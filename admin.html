<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - EDU-LEAGUE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="icon" href="edulogo.jpg" type="image/jpeg">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .active-tab { background-color: #16a34a; color: white; border-color: #16a34a; }
        .inactive-tab { background-color: white; color: #4b5563; border-color: #e5e7eb; }
        .sub-active { background-color: #4c1d95; color: white; border: 1px solid #4c1d95; }
        .sub-inactive { background-color: white; color: #374151; border: 1px solid #e5e7eb; }
        .stat-input { width: 100%; text-align: center; border: 1px solid #e5e7eb; padding: 4px; border-radius: 4px; }
        .stat-input:focus { outline: none; border-color: #16a34a; background-color: #f0fdf4; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <nav class="bg-white border-b sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2">
                    <img src="edulogo.jpg" class="h-8 w-8 rounded-full border border-gray-200">
                    <span class="font-black text-xl text-gray-900">EDU-LEAGUE <span class="bg-gray-800 text-white text-xs px-2 py-1 rounded ml-1">ADMIN</span></span>
                </div>
                <button onclick="logout()" id="logoutBtn" class="hidden text-sm text-red-600 font-bold hover:text-red-800">Log Out</button>
            </div>
        </div>
    </nav>

    <main class="flex-grow py-10 px-4">
        
        <div id="login-section" class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-8">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Secure Access</h2>
            </div>
            <div class="space-y-4">
                <input type="password" id="adminPin" class="w-full border p-3 rounded-lg text-center text-2xl tracking-widest mb-4" placeholder="****">
                <button onclick="login()" id="loginBtn" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition shadow">Login</button>
                <p id="loginError" class="text-red-500 text-center text-sm hidden font-bold mt-2">Incorrect Password</p>
            </div>
        </div>

        <div id="dashboard-section" class="max-w-7xl mx-auto hidden">
            
            <div class="grid grid-cols-3 md:grid-cols-6 gap-2 mb-6 overflow-x-auto">
                <button onclick="switchTab('registrations')" id="btn-registrations" class="active-tab py-3 px-2 text-xs md:text-sm rounded-lg font-bold border shadow-sm whitespace-nowrap"><i class="fa-solid fa-users mr-2"></i> Teams</button>
                <button onclick="switchTab('news')" id="btn-news" class="inactive-tab py-3 px-2 text-xs md:text-sm rounded-lg font-bold border shadow-sm whitespace-nowrap"><i class="fa-regular fa-newspaper mr-2"></i> News</button>
                <button onclick="switchTab('widget')" id="btn-widget" class="inactive-tab py-3 px-2 text-xs md:text-sm rounded-lg font-bold border shadow-sm whitespace-nowrap"><i class="fa-solid fa-stopwatch mr-2"></i> Widget</button>
                <button onclick="switchTab('schedule')" id="btn-schedule" class="inactive-tab py-3 px-2 text-xs md:text-sm rounded-lg font-bold border shadow-sm whitespace-nowrap"><i class="fa-solid fa-calendar-days mr-2"></i> Schedule</button>
                <button onclick="switchTab('league')" id="btn-league" class="inactive-tab py-3 px-2 text-xs md:text-sm rounded-lg font-bold border shadow-sm whitespace-nowrap"><i class="fa-solid fa-list-ol mr-2"></i> Tables</button>
                <button onclick="switchTab('stats')" id="btn-stats" class="inactive-tab py-3 px-2 text-xs md:text-sm rounded-lg font-bold border shadow-sm whitespace-nowrap"><i class="fa-solid fa-futbol mr-2"></i> Player Stats</button>
            </div>

            <div id="tab-registrations" class="bg-white rounded-xl shadow-md p-6 border border-gray-200">
                <div class="bg-blue-50 p-5 rounded-lg border border-blue-100 mb-8">
                    <h3 class="font-bold text-blue-900 mb-4 flex items-center"><i class="fa-solid fa-shield-halved mr-2"></i> Upload Team Badges</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Department</label>
                            <select id="logoDeptSelect" class="w-full border p-2.5 rounded-lg bg-white font-semibold">
                                <option value="Adult Edu">Adult Education</option>
                                <option value="Art Edu">Art Education</option>
                                <option value="Edu Found">Education Foundation</option>
                                <option value="Edu Mgt">Education Management</option>
                                <option value="HKHE">HKHE</option>
                                <option value="Sci Edu">Science Education</option>
                                <option value="Soc Sci Edu">Social Science Edu</option>
                                <option value="TVESA">TVESA</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Level</label>
                            <select id="logoLevelSelect" class="w-full border p-2.5 rounded-lg bg-white font-semibold">
                                <option value="Finalist">Finalist</option>
                                <option value="Penultimate">Penultimate</option>
                                <option value="Sophomore">Sophomore</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Badge Image</label>
                            <input type="file" id="teamLogoFile" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-xs file:font-bold file:bg-blue-600 file:text-white hover:file:bg-blue-700 bg-white border rounded-lg">
                        </div>
                    </div>
                    <button onclick="uploadTeamLogo()" id="uploadLogoBtn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition shadow-sm">Save Official Team Badge</button>
                    <p id="logoStatus" class="text-xs text-green-600 font-bold mt-2 hidden text-center">Logo uploaded successfully!</p>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-4">Registered Teams</h3>
                <div id="registrations-list" class="space-y-3 max-h-[400px] overflow-y-auto"><p class="text-center text-gray-400 py-4">Loading...</p></div>
            </div>

            <div id="tab-news" class="bg-white rounded-xl shadow-md p-6 border border-gray-200 hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <h3 class="font-bold">Post News (Photo/Video)</h3>
                        <input id="newsTitle" class="w-full border p-3 rounded-lg font-bold" placeholder="Headline">
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:bg-gray-50 relative">
                            <input id="newsFile" type="file" accept="image/*,video/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="previewImage(event)">
                            <div id="uploadPlaceholder"><i class="fa-solid fa-cloud-arrow-up text-2xl text-gray-400"></i><p class="text-xs text-gray-500 font-bold">Upload Image or Video</p></div>
                            <img id="imagePreview" class="hidden h-24 mx-auto object-cover rounded shadow">
                        </div>
                        <div id="progressArea" class="hidden"><div class="w-full bg-gray-200 rounded-full h-2"><div id="progressBar" class="bg-green-600 h-2 rounded-full" style="width: 0%"></div></div></div>
                        <textarea id="newsContent" class="w-full border p-3 rounded-lg h-32" placeholder="Story..."></textarea>
                        <button onclick="postNews()" id="publishBtn" class="bg-green-600 text-white px-6 py-3 rounded-lg font-bold w-full hover:bg-green-700">Publish News</button>
                    </div>
                    <div>
                        <h3 class="font-bold mb-2">History</h3>
                        <div id="admin-news-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <div id="tab-widget" class="bg-white rounded-xl shadow-md p-6 border border-gray-200 hidden">
                <h3 class="font-bold text-gray-900 text-lg mb-4">Homepage Spotlight (Add Multiple Games)</h3>
                <p class="text-sm text-gray-500 mb-4">Add all key matches for the day here. They will rotate on the homepage.</p>
                <div id="widget-matches-container" class="space-y-4 mb-4"></div>
                <div class="flex gap-4">
                    <button onclick="addWidgetMatchRow()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-bold hover:bg-gray-300">+ Add Game</button>
                    <button onclick="saveSpotlightWidget()" class="bg-gray-900 text-white px-8 py-2 rounded-lg font-bold hover:bg-black">Publish Spotlight</button>
                </div>
            </div>

            <div id="tab-schedule" class="bg-white rounded-xl shadow-md p-6 border border-gray-200 hidden">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h3 class="text-xl font-bold text-gray-900">Manage Schedule</h3>
                    <select id="matchDaySelect" onchange="loadSchedule()" class="border-2 border-green-600 rounded-lg p-2 font-bold text-green-700 bg-white">
                        <option value="Matchday 1">Matchday 1</option>
                        <option value="Matchday 2">Matchday 2</option>
                        <option value="Matchday 3">Matchday 3</option>
                        <option value="Matchday 4">Matchday 4</option>
                        <option value="Matchday 5">Matchday 5</option>
                        <option value="Matchday 6">Matchday 6</option>
                        <option value="Matchday 7">Matchday 7</option>
                        <option value="Semi-Finals">Semi-Finals (Day 8)</option>
                        <option value="Rest Day">Rest Day (Day 9)</option>
                        <option value="Finals">Finals (Day 10)</option>
                    </select>
                </div>
                <div id="schedule-container" class="space-y-3 mb-6"></div>
                <div class="flex gap-4">
                    <button onclick="addMatchInput()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-bold hover:bg-gray-300">+ Match Row</button>
                    <button onclick="saveSchedule()" class="bg-green-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-green-700">Save Matchday</button>
                </div>
            </div>

            <div id="tab-league" class="bg-white rounded-xl shadow-md p-6 border border-gray-200 hidden">
                <div class="flex justify-between items-center mb-6 bg-gray-50 p-4 rounded-xl border">
                    <div class="text-center">
                        <img id="division-logo-display" src="Finalist.png" class="w-12 h-12 object-contain mx-auto" onerror="this.src='edulogo.jpg'">
                        <p id="division-label" class="text-[10px] font-bold text-gray-500 uppercase mt-1">Finalist</p>
                    </div>
                    <div class="flex space-x-1">
                        <button onclick="changeTableLevel('Finalist')" id="lvl-Finalist" class="sub-active px-3 py-1 rounded text-xs font-bold transition">Finalist</button>
                        <button onclick="changeTableLevel('Penultimate')" id="lvl-Penultimate" class="sub-inactive px-3 py-1 rounded text-xs font-bold transition">Penultimate</button>
                        <button onclick="changeTableLevel('Sophomore')" id="lvl-Sophomore" class="sub-inactive px-3 py-1 rounded text-xs font-bold transition">Sophomore</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead><tr class="bg-gray-100"><th class="p-2 text-left">Dept</th><th>MP</th><th>W</th><th>D</th><th>L</th><th>GD</th><th>Pts</th></tr></thead>
                        <tbody id="table-editor-body"></tbody>
                    </table>
                </div>
                <button onclick="saveTable()" class="w-full bg-purple-700 text-white py-3 mt-4 rounded-lg font-bold hover:bg-purple-800">Save <span id="save-lvl-name">Finalist</span> Table</button>
            </div>

            <div id="tab-stats" class="bg-white rounded-xl shadow-md p-6 border border-gray-200 hidden">
                <h3 class="text-xl font-bold text-gray-900 mb-6 border-b pb-2">Player Stats (Goals, Assists & Cards)</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-4">
                        <div class="bg-gray-50 p-4 rounded-lg border">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">1. Select Team</label>
                            <select id="statsTeamSelect" onchange="loadPlayersForStats()" class="w-full border p-2 rounded font-bold mb-4"><option value="">Loading Teams...</option></select>

                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">2. Select Player</label>
                            <select id="statsPlayerSelect" onchange="fetchCurrentStats()" class="w-full border p-2 rounded font-bold mb-4"><option value="">Select a Team first</option></select>

                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Goals âš½</label><input type="number" id="playerGoals" class="w-full border p-2 rounded text-center font-bold text-green-600 text-xl" value="0"></div>
                                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Assists ðŸ‘Ÿ</label><input type="number" id="playerAssists" class="w-full border p-2 rounded text-center font-bold text-blue-600 text-xl" value="0"></div>
                            </div>

                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Yellow Cards ðŸŸ¨</label><input type="number" id="playerYellow" class="w-full border p-2 rounded text-center font-bold text-yellow-600 text-xl bg-yellow-50" value="0"></div>
                                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Red Cards ðŸŸ¥</label><input type="number" id="playerRed" class="w-full border p-2 rounded text-center font-bold text-red-600 text-xl bg-red-50" value="0"></div>
                            </div>

                            <div class="mb-4">
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Saves (GK Only) ðŸ§¤</label>
                                <input type="number" id="playerSaves" class="w-full border p-2 rounded text-center font-bold text-purple-600 text-xl bg-purple-50" value="0">
                            </div>

                            <button onclick="savePlayerStats()" class="w-full bg-gray-900 text-white py-3 rounded-lg font-bold mt-4 hover:bg-black">Update Player Stats</button>
                        </div>
                    </div>

                    <div>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <button onclick="loadLeaderboard('goals')" class="bg-green-100 text-green-800 py-1 rounded font-bold text-xs border border-green-200">Top Scorers</button>
                            <button onclick="loadLeaderboard('assists')" class="bg-blue-100 text-blue-800 py-1 rounded font-bold text-xs border border-blue-200">Top Assists</button>
                        </div>
                        <div class="grid grid-cols-3 gap-2 mb-4">
                            <button onclick="loadLeaderboard('yellowCards')" class="bg-yellow-100 text-yellow-800 py-1 rounded font-bold text-xs border border-yellow-200">Yellows</button>
                            <button onclick="loadLeaderboard('redCards')" class="bg-red-100 text-red-800 py-1 rounded font-bold text-xs border border-red-200">Reds</button>
                            <button onclick="loadLeaderboard('saves')" class="bg-purple-100 text-purple-800 py-1 rounded font-bold text-xs border border-purple-200">Saves</button>
                        </div>

                        <div id="statsLeaderboard" class="bg-white border rounded-lg overflow-hidden">
                            <h4 id="leaderboardTitle" class="text-xs font-bold bg-gray-100 p-2 text-center text-gray-600 uppercase">Leaderboard</h4>
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50"><tr class="text-left"><th class="p-2 w-8">#</th><th class="p-2">Player</th><th class="p-2">Team</th><th class="p-2 text-center">Count</th></tr></thead>
                                <tbody id="leaderboardBody"><tr><td colspan="4" class="p-4 text-center text-gray-400">Select a category...</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, serverTimestamp, query, orderBy, getDocs, onSnapshot, deleteDoc, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 1. PASTE FIREBASE CONFIG HERE ---
        const firebaseConfig = {
           apiKey: "AIzaSyDtxFsLYoe0NYlZRWiXgEM90IYKMwx7K8s",
           authDomain: "sonic-verbena-239117.firebaseapp.com",
           projectId: "sonic-verbena-239117",
           storageBucket: "sonic-verbena-239117.firebasestorage.app",
           messagingSenderId: "652544574249",
           appId: "1:652544574249:web:6ff33771307e892e7f6d38",
           measurementId: "G-TD780JGNED"
        };

        // --- 2. CLOUDINARY KEYS (INSERTED) ---
        const CLOUD_NAME = "dxdxgrvvb"; 
        const UPLOAD_PRESET = "edu_league"; 

        // ---------------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const DEPARTMENTS = ["Adult Edu", "Art Edu", "Edu Found", "Edu Mgt", "HKHE", "Sci Edu", "Soc Sci Edu", "TVESA"];
        const ADMIN_PASS = "EDUADMIN2025"; 
        let currentTableLevel = "Finalist"; 

        // --- AUTH ---
        window.login = async () => {
            const pin = document.getElementById('adminPin').value;
            const btn = document.getElementById('loginBtn');
            
            if(pin === ADMIN_PASS) {
                btn.textContent = "Connecting..."; 
                try {
                    await signInAnonymously(auth);
                    document.getElementById('login-section').classList.add('hidden');
                    document.getElementById('dashboard-section').classList.remove('hidden');
                    document.getElementById('logoutBtn').classList.remove('hidden');
                    initDashboard();
                } catch (e) {
                    console.error(e);
                    alert("PIN correct, but database connection failed.");
                    btn.textContent = "Login";
                }
            } else { 
                document.getElementById('loginError').classList.remove('hidden'); 
            }
        }
        window.logout = () => window.location.reload();

        // --- TABS ---
        window.switchTab = (tabName) => {
            ['registrations', 'news', 'widget', 'schedule', 'league', 'stats'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.add('hidden');
                document.getElementById(`btn-${t}`).classList.replace('active-tab', 'inactive-tab');
            });
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            document.getElementById(`btn-${tabName}`).classList.replace('inactive-tab', 'active-tab');
        }

        function initDashboard() {
            loadRegistrations();
            loadNewsHistory();
            loadTableEditor();
            populateTeamSelects();
            loadSchedule();
            loadTeamsForStatsDropdown(); 
            loadLeaderboard('goals'); 
            addWidgetMatchRow();   
        }

        // --- UPDATED CLOUDINARY UPLOAD (SUPPORTS VIDEO) ---
        async function uploadToCloudinary(file) {
            const formData = new FormData();
            formData.append("file", file);
            formData.append("upload_preset", UPLOAD_PRESET);

            // Change 'image' to 'auto' in the URL to allow videos
            const type = file.type.startsWith('video/') ? 'video' : 'image';
            
            try {
                // We use 'auto' here so Cloudinary figures it out
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`, {
                    method: "POST",
                    body: formData
                });
                const data = await response.json();
                if (data.secure_url) {
                    return data.secure_url;
                } else {
                    throw new Error("Upload failed: " + (data.error?.message || "Unknown error"));
                }
            } catch (error) {
                console.error("Cloudinary Error:", error);
                throw error;
            }
        }

        // --- NEWS (UPDATED FOR CLOUDINARY) ---
        window.postNews = async () => {
            const title = document.getElementById('newsTitle').value;
            const content = document.getElementById('newsContent').value;
            const file = document.getElementById('newsFile').files[0];
            const btn = document.getElementById('publishBtn');

            if(!title || !content) return alert("Please fill Title and Content");

            btn.disabled = true;
            btn.textContent = "Uploading File...";
            let imageUrl = "";

            try {
                if(file) {
                    document.getElementById('progressArea').classList.remove('hidden');
                    // Cloudinary upload
                    imageUrl = await uploadToCloudinary(file);
                }

                btn.textContent = "Saving...";
                await addDoc(collection(db, "news_posts"), { 
                    title, 
                    content, 
                    imageUrl, 
                    timestamp: serverTimestamp() 
                });

                alert("News Published Successfully!");
                
                // Reset Form
                document.getElementById('newsTitle').value = "";
                document.getElementById('newsContent').value = "";
                document.getElementById('newsFile').value = "";
                document.getElementById('imagePreview').classList.add('hidden');
                document.getElementById('uploadPlaceholder').classList.remove('hidden');
                document.getElementById('progressArea').classList.add('hidden');
                btn.textContent = "Publish News";
                btn.disabled = false;

            } catch (error) {
                console.error("Error:", error);
                alert("Failed: " + error.message);
                btn.disabled = false;
                btn.textContent = "Publish News";
            }
        }

        // --- TEAM LOGO UPLOAD (UPDATED FOR CLOUDINARY) ---
        window.uploadTeamLogo = async () => { 
            const dept = document.getElementById('logoDeptSelect').value;
            const level = document.getElementById('logoLevelSelect').value;
            const file = document.getElementById('teamLogoFile').files[0];
            const btn = document.getElementById('uploadLogoBtn');
            const status = document.getElementById('logoStatus');

            if(!file) return alert("Select a file");
            btn.disabled = true; btn.textContent = "Uploading...";

            try {
                const url = await uploadToCloudinary(file);
                
                // Save URL to Firestore
                await setDoc(doc(db, "team_assets", dept), { logoUrl: url, levelUpdated: level }, { merge: true });
                
                btn.disabled = false; btn.textContent = "Save Official Team Badge";
                status.classList.remove('hidden'); 
                setTimeout(() => status.classList.add('hidden'), 3000);
                alert(`${dept} Logo Saved!`);
            } catch (error) {
                console.error("Logo Upload Error:", error);
                alert("Upload Failed: " + error.message);
                btn.disabled = false;
                btn.textContent = "Save Official Team Badge";
            }
        }

        window.previewImage = (e) => { 
            const f = e.target.files[0]; 
            if(f) { 
                document.getElementById('imagePreview').src = URL.createObjectURL(f); 
                document.getElementById('imagePreview').classList.remove('hidden'); 
                document.getElementById('uploadPlaceholder').classList.add('hidden'); 
            } 
        }

        // --- SPOTLIGHT WIDGET (MULTIPLE) ---
        window.addWidgetMatchRow = (tA='', tB='', date='', time='', venue='') => {
            const div = document.createElement('div');
            div.className = "grid grid-cols-1 md:grid-cols-6 gap-2 bg-gray-50 p-3 rounded widget-row mb-2 items-center";
            div.innerHTML = `
                <select class="w-teamA border p-2 rounded text-xs font-bold col-span-2"><option value="">Home Team</option></select>
                <select class="w-teamB border p-2 rounded text-xs font-bold col-span-2"><option value="">Away Team</option></select>
                <input class="w-time border p-2 rounded text-xs col-span-1" placeholder="Time" value="${time}">
                <button onclick="this.parentElement.remove()" class="text-red-500 text-center"><i class="fa-solid fa-trash"></i></button>
                <div class="col-span-6 grid grid-cols-2 gap-2 mt-1">
                     <input class="w-date border p-1 rounded text-xs" placeholder="Date" value="${date}">
                     <input class="w-venue border p-1 rounded text-xs" placeholder="Venue" value="${venue}">
                </div>
            `;
            document.getElementById('widget-matches-container').appendChild(div);
            // Populate these specific dropdowns immediately
            const options = DEPARTMENTS.map(d => `<option value="${d}">${d}</option>`).join('');
            div.querySelector('.w-teamA').innerHTML += options;
            div.querySelector('.w-teamB').innerHTML += options;
            div.querySelector('.w-teamA').value = tA;
            div.querySelector('.w-teamB').value = tB;
        }

        window.saveSpotlightWidget = async () => {
            const rows = document.querySelectorAll('.widget-row');
            const matches = [];
            for (const r of rows) {
                const tA = r.querySelector('.w-teamA').value;
                const tB = r.querySelector('.w-teamB').value;
                if(tA && tB) {
                    let logoA="", logoB="";
                    const dA = await getDoc(doc(db, "team_assets", tA)); if(dA.exists()) logoA = dA.data().logoUrl;
                    const dB = await getDoc(doc(db, "team_assets", tB)); if(dB.exists()) logoB = dB.data().logoUrl;
                    matches.push({ teamA: tA, teamB: tB, teamALogo: logoA, teamBLogo: logoB, date: r.querySelector('.w-date').value, time: r.querySelector('.w-time').value, venue: r.querySelector('.w-venue').value });
                }
            }
            await setDoc(doc(db, "app_content", "current_fixture"), { matches: matches });
            alert("Spotlight Updated!");
        }

        // --- OTHER FUNCTIONS ---
        function populateTeamSelects() {
            const options = DEPARTMENTS.map(d => `<option value="${d}">${d}</option>`).join('');
            document.getElementById('logoDeptSelect').innerHTML = options;
            document.getElementById('statsTeamSelect').innerHTML = '<option value="">Select Team</option>';
        }

        function loadNewsHistory() { onSnapshot(query(collection(db, "news_posts"), orderBy("timestamp", "desc")), snap => { document.getElementById('admin-news-list').innerHTML = ''; snap.forEach(d => document.getElementById('admin-news-list').innerHTML += `<div class="p-2 border rounded flex justify-between bg-white mb-2"><span class="text-xs truncate w-3/4 font-semibold">${d.data().title}</span><button onclick="deletePost('${d.id}')" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button></div>`); }); }
        window.deletePost = async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db, "news_posts", id)); }

        window.loadRegistrations = async () => { const list = document.getElementById('registrations-list'); list.innerHTML = 'Loading...'; const snap = await getDocs(query(collection(db, "registrations"), orderBy("registeredAt", "desc"))); list.innerHTML = snap.empty ? '<p class="text-center text-gray-400">No teams.</p>' : ''; snap.forEach(d => { const data = d.data(); const color = data.registrationStatus === "Complete" ? "bg-green-100 text-green-800" : "bg-yellow-100 text-yellow-800"; list.innerHTML += `<div class="p-3 bg-gray-50 rounded border flex justify-between items-center"><div><h4 class="font-bold text-gray-800">${data.department} <span class="text-xs text-gray-500 font-normal">(${data.level})</span></h4><p class="text-xs text-gray-500">${data.coachName} | ${data.phone}</p></div><span class="px-2 py-1 rounded text-xs font-bold ${color}">${data.registrationStatus}</span></div>`; }); }

        window.addMatchInput = (tA='', tB='', time='', res='') => { document.getElementById('schedule-container').innerHTML += `<div class="grid grid-cols-4 gap-2 bg-gray-50 p-2 rounded match-row mb-2"><input class="border p-2 rounded s-teamA" placeholder="Team A" value="${tA}"><input class="border p-2 rounded s-teamB" placeholder="Team B" value="${tB}"><input class="border p-2 rounded s-time" placeholder="Time" value="${time}"><input class="border p-2 rounded s-result" placeholder="Score" value="${res}"></div>`; }
        window.loadSchedule = async () => { const docId = "schedule_" + document.getElementById('matchDaySelect').value.replace(/\s+/g, '_').toLowerCase(); const snap = await getDoc(doc(db, "schedules", docId)); const c = document.getElementById('schedule-container'); c.innerHTML=''; if(snap.exists() && snap.data().matches) snap.data().matches.forEach(m=>window.addMatchInput(m.teamA, m.teamB, m.time, m.result)); else window.addMatchInput(); }
        window.saveSchedule = async () => { const matches=[]; document.querySelectorAll('.match-row').forEach(r=>matches.push({teamA:r.querySelector('.s-teamA').value, teamB:r.querySelector('.s-teamB').value, time:r.querySelector('.s-time').value, result:r.querySelector('.s-result').value})); await setDoc(doc(db, "schedules", "schedule_" + document.getElementById('matchDaySelect').value.replace(/\s+/g, '_').toLowerCase()), { matches }); alert("Schedule Saved"); }

        window.changeTableLevel = (level) => { currentTableLevel = level; const logoMap = { 'Finalist': 'Finalist.png', 'Penultimate': 'Penultimate.png', 'Sophomore': 'Sophomore.png' }; document.getElementById('division-logo-display').src = logoMap[level]; document.getElementById('division-label').textContent = level; document.getElementById('save-lvl-name').textContent = level; ['Finalist', 'Penultimate', 'Sophomore'].forEach(l => { const b=document.getElementById('lvl-'+l); if(l===level){b.classList.add('sub-active');b.classList.remove('sub-inactive');}else{b.classList.remove('sub-active');b.classList.add('sub-inactive');}}); loadTableEditor(); }
        async function loadTableEditor() { const snap = await getDoc(doc(db, "app_content", `league_table_${currentTableLevel.toLowerCase()}`)); let data = snap.exists() ? snap.data() : {}; DEPARTMENTS.forEach(d => { if(!data[d]) data[d] = { mp:0, w:0, d:0, l:0, gd:0, pts:0 }; }); const tbody = document.getElementById('table-editor-body'); tbody.innerHTML = ''; Object.keys(data).sort().forEach(dept => { const s = data[dept]; tbody.innerHTML += `<tr><td class="py-2 px-4 font-bold text-sm">${dept}</td><td><input id="${dept}-mp" value="${s.mp}" class="stat-input"></td><td><input id="${dept}-w" value="${s.w}" class="stat-input"></td><td><input id="${dept}-d" value="${s.d}" class="stat-input"></td><td><input id="${dept}-l" value="${s.l}" class="stat-input"></td><td><input id="${dept}-gd" value="${s.gd}" class="stat-input"></td><td><input id="${dept}-pts" value="${s.pts}" class="stat-input font-bold bg-green-50 text-green-700"></td></tr>`; }); }
        window.saveTable = async () => { let newData = {}; document.getElementById('table-editor-body').querySelectorAll('tr').forEach(row => { const dept = row.querySelector('td:first-child').innerText; newData[dept] = { mp: parseInt(document.getElementById(`${dept}-mp`).value)||0, w: parseInt(document.getElementById(`${dept}-w`).value)||0, d: parseInt(document.getElementById(`${dept}-d`).value)||0, l: parseInt(document.getElementById(`${dept}-l`).value)||0, gd: parseInt(document.getElementById(`${dept}-gd`).value)||0, pts: parseInt(document.getElementById(`${dept}-pts`).value)||0 }; }); await setDoc(doc(db, "app_content", `league_table_${currentTableLevel.toLowerCase()}`), newData); alert("Table Saved!"); }

        window.loadTeamsForStatsDropdown = async () => { const select = document.getElementById('statsTeamSelect'); select.innerHTML = '<option value="">Select Team</option>'; const q = query(collection(db, "registrations")); const snap = await getDocs(q); snap.forEach(doc => { const d = doc.data(); if(d.registrationStatus === "Complete") { const opt = document.createElement('option'); opt.value = doc.id; opt.textContent = `${d.department} (${d.level})`; select.appendChild(opt); } }); }
        window.loadPlayersForStats = async () => { const teamId = document.getElementById('statsTeamSelect').value; const select = document.getElementById('statsPlayerSelect'); select.innerHTML = '<option value="">Select Player</option>'; if(!teamId) return; const snap = await getDoc(doc(db, "registrations", teamId)); if(snap.exists() && snap.data().players) snap.data().players.forEach(p => { const opt = document.createElement('option'); opt.value = p.name; opt.textContent = p.name; select.appendChild(opt); }); }
        window.fetchCurrentStats = async () => { const teamSelect = document.getElementById('statsTeamSelect'); const player = document.getElementById('statsPlayerSelect').value; const teamName = teamSelect.options[teamSelect.selectedIndex].text; if(!player) return; const statId = (teamName + "_" + player).replace(/\s+/g, '').toLowerCase(); const snap = await getDoc(doc(db, "player_stats", statId)); if(snap.exists()) { document.getElementById('playerGoals').value = snap.data().goals || 0; document.getElementById('playerAssists').value = snap.data().assists || 0; document.getElementById('playerYellow').value = snap.data().yellowCards || 0; document.getElementById('playerRed').value = snap.data().redCards || 0; document.getElementById('playerSaves').value = snap.data().saves || 0; } else { ['playerGoals', 'playerAssists', 'playerYellow', 'playerRed', 'playerSaves'].forEach(id => document.getElementById(id).value = 0); } }
        window.savePlayerStats = async () => { const teamSelect = document.getElementById('statsTeamSelect'); const player = document.getElementById('statsPlayerSelect').value; if(!player) return alert("Select a player"); const teamName = teamSelect.options[teamSelect.selectedIndex].text; const goals = parseInt(document.getElementById('playerGoals').value)||0; const assists = parseInt(document.getElementById('playerAssists').value)||0; const yellow = parseInt(document.getElementById('playerYellow').value)||0; const red = parseInt(document.getElementById('playerRed').value)||0; const saves = parseInt(document.getElementById('playerSaves').value)||0; const statId = (teamName + "_" + player).replace(/\s+/g, '').toLowerCase(); await setDoc(doc(db, "player_stats", statId), { name: player, team: teamName, goals, assists, yellowCards: yellow, redCards: red, saves, updatedAt: serverTimestamp() }); alert("Stats Updated!"); loadLeaderboard('goals'); }
        window.loadLeaderboard = async (type) => { const body = document.getElementById('leaderboardBody'); const title = document.getElementById('leaderboardTitle'); body.innerHTML = '<tr><td colspan="4" class="p-4 text-center">Loading...</td></tr>'; const titles = { goals: 'Goals', assists: 'Assists', yellowCards: 'Yellow Cards', redCards: 'Red Cards', saves: 'GK Saves' }; title.textContent = `Leaderboard: ${titles[type]}`; const q = query(collection(db, "player_stats"), orderBy(type, "desc")); const snap = await getDocs(q); body.innerHTML = ''; if(snap.empty) { body.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-400">No stats yet.</td></tr>'; return; } let rank = 1; snap.forEach(doc => { const d = doc.data(); const count = d[type]; if(count > 0) { let color = "text-gray-800"; if(type === 'goals') color = "text-green-600"; if(type === 'assists') color = "text-blue-600"; if(type === 'yellowCards') color = "text-yellow-600"; if(type === 'redCards') color = "text-red-600"; if(type === 'saves') color = "text-purple-600"; body.innerHTML += `<tr class="border-b"><td class="p-2 font-bold text-gray-500">${rank++}</td><td class="p-2 font-bold text-gray-800">${d.name}</td><td class="p-2 text-xs text-gray-500">${d.team}</td><td class="p-2 text-center font-black ${color}">${count}</td></tr>`; } }); }

    </script>
</body>
</html>