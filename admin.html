<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - EDU-LEAGUE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="icon" href="edulogo.jpg" type="image/jpeg">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .active-tab { background-color: #16a34a; color: white; border-color: #16a34a; }
        .inactive-tab { background-color: white; color: #4b5563; border-color: #e5e7eb; }
        .stat-input { width: 100%; text-align: center; border: 1px solid #e5e7eb; padding: 4px; border-radius: 4px; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <nav class="bg-white border-b sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2">
                    <img src="edulogo.jpg" class="h-8 w-8 rounded-full">
                    <span class="font-black text-xl text-gray-900">EDU-LEAGUE <span class="bg-gray-800 text-white text-xs px-2 py-1 rounded ml-1">ADMIN</span></span>
                </div>
                <button onclick="logout()" id="logoutBtn" class="hidden text-sm text-red-600 font-bold">Log Out</button>
            </div>
        </div>
    </nav>

    <main class="flex-grow py-10 px-4">
        
        <div id="login-section" class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-8">
            <h2 class="text-2xl font-bold text-center text-gray-900 mb-4">Secure Access</h2>
            <input type="password" id="adminPin" class="w-full border p-3 rounded-lg text-center text-2xl tracking-widest mb-4" placeholder="****">
            <button onclick="login()" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700">Login</button>
            <p id="loginError" class="text-red-500 text-center text-sm hidden font-bold mt-2">Incorrect Password</p>
        </div>

        <div id="dashboard-section" class="max-w-6xl mx-auto hidden">
            
            <div class="grid grid-cols-5 gap-2 mb-6 overflow-x-auto">
                <button onclick="switchTab('registrations')" id="btn-registrations" class="active-tab py-3 px-2 text-sm rounded-lg font-bold border">Teams & Logos</button>
                <button onclick="switchTab('news')" id="btn-news" class="inactive-tab py-3 px-2 text-sm rounded-lg font-bold border">News</button>
                <button onclick="switchTab('widget')" id="btn-widget" class="inactive-tab py-3 px-2 text-sm rounded-lg font-bold border">Match Widget</button>
                <button onclick="switchTab('schedule')" id="btn-schedule" class="inactive-tab py-3 px-2 text-sm rounded-lg font-bold border">Full Schedule</button>
                <button onclick="switchTab('league')" id="btn-league" class="inactive-tab py-3 px-2 text-sm rounded-lg font-bold border">Tables</button>
            </div>

            <div id="tab-registrations" class="bg-white rounded-xl shadow-md p-6 border border-gray-200">
                
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 mb-6">
                    <h3 class="font-bold text-blue-900 mb-3"><i class="fa-solid fa-shield-halved mr-2"></i> Upload Team Badges</h3>
                    <div class="flex flex-col md:flex-row gap-4 items-end">
                        <div class="w-full">
                            <label class="text-xs font-bold text-gray-500">Select Department</label>
                            <select id="logoDeptSelect" class="w-full border p-2 rounded bg-white">
                                <option value="Adult Edu">Adult Education</option>
                                <option value="Art Edu">Art Education</option>
                                <option value="Edu Found">Education Foundation</option>
                                <option value="Edu Mgt">Education Management</option>
                                <option value="HKHE">HKHE</option>
                                <option value="Sci Edu">Science Education</option>
                                <option value="Soc Sci Edu">Social Science Edu</option>
                                <option value="TVESA">TVESA</option>
                            </select>
                        </div>
                        <div class="w-full">
                            <label class="text-xs font-bold text-gray-500">Upload Logo (PNG/JPG)</label>
                            <input type="file" id="teamLogoFile" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700">
                        </div>
                        <button onclick="uploadTeamLogo()" id="uploadLogoBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 w-full md:w-auto">Save Logo</button>
                    </div>
                    <p id="logoStatus" class="text-xs text-green-600 font-bold mt-2 hidden">Logo uploaded successfully!</p>
                </div>

                <h3 class="text-xl font-bold text-gray-900 mb-4">Registered Teams List</h3>
                <div id="registrations-list" class="space-y-3 max-h-[400px] overflow-y-auto">Loading...</div>
            </div>

            <div id="tab-news" class="bg-white rounded-xl shadow-md p-6 border border-gray-200 hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <h3 class="font-bold">Post News</h3>
                        <input id="newsTitle" class="w-full border p-3 rounded" placeholder="Headline">
                        <input id="newsFile" type="file" accept="image/*" class="w-full text-sm">
                        <textarea id="newsContent" class="w-full border p-3 rounded h-32" placeholder="Story..."></textarea>
                        <button onclick="postNews()" id="publishBtn" class="bg-green-600 text-white px-6 py-2 rounded font-bold w-full">Publish</button>
                    </div>
                    <div>
                        <h3 class="font-bold mb-2">History</h3>
                        <div id="admin-news-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <div id="tab-widget" class="bg-white rounded-xl shadow-md p-6 border border-gray-200 hidden">
                <h3 class="font-bold mb-4">Update Homepage Widget</h3>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <select id="teamA" class="border p-3 rounded font-bold"><option>Select Team A</option></select>
                    <select id="teamB" class="border p-3 rounded font-bold"><option>Select Team B</option></select>
                </div>
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <input id="fixDate" class="border p-3 rounded" placeholder="Date">
                    <input id="fixTime" class="border p-3 rounded" placeholder="Time">
                    <input id="fixVenue" class="border p-3 rounded" placeholder="Venue">
                </div>
                <button onclick="saveFixture()" class="bg-gray-900 text-white px-6 py-2 rounded font-bold">Update Live Widget</button>
            </div>

            <div id="tab-schedule" class="bg-white rounded-xl shadow-md p-6 border border-gray-200 hidden">
                <p>Use Table Tab for Results/Standings</p>
            </div>

            <div id="tab-league" class="bg-white rounded-xl shadow-md p-6 border border-gray-200 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold">League Table</h3>
                    <div class="flex gap-2">
                        <button onclick="changeTableLevel('Finalist')" id="lvl-Finalist" class="sub-active px-3 py-1 rounded text-sm font-bold">Finalist</button>
                        <button onclick="changeTableLevel('Penultimate')" id="lvl-Penultimate" class="sub-inactive px-3 py-1 rounded text-sm font-bold">Penultimate</button>
                        <button onclick="changeTableLevel('Sophomore')" id="lvl-Sophomore" class="sub-inactive px-3 py-1 rounded text-sm font-bold">Sophomore</button>
                    </div>
                </div>
                <table class="w-full text-sm">
                    <thead><tr class="bg-gray-100"><th class="p-2 text-left">Dept</th><th>MP</th><th>W</th><th>D</th><th>L</th><th>GD</th><th>Pts</th></tr></thead>
                    <tbody id="table-editor-body"></tbody>
                </table>
                <button onclick="saveTable()" class="w-full bg-purple-700 text-white py-3 mt-4 rounded font-bold">Save Table</button>
            </div>

        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, serverTimestamp, query, orderBy, getDocs, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // --- PASTE FIREBASE CONFIG HERE ---
        const firebaseConfig = {
           apiKey: "AIzaSyDtxFsLYoe0NYlZRWiXgEM90IYKMwx7K8s",
           authDomain: "sonic-verbena-239117.firebaseapp.com",
           projectId: "sonic-verbena-239117",
           storageBucket: "sonic-verbena-239117.firebasestorage.app",
           messagingSenderId: "652544574249",
           appId: "1:652544574249:web:6ff33771307e892e7f6d38",
           measurementId: "G-TD780JGNED"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const DEPARTMENTS = ["Adult Edu", "Art Edu", "Edu Found", "Edu Mgt", "HKHE", "Sci Edu", "Soc Sci Edu", "TVESA"];
        const ADMIN_PASS = "EDUADMIN2025"; 
        let currentTableLevel = "Finalist"; 

        // --- LOGIN ---
        window.login = () => {
            if(document.getElementById('adminPin').value === ADMIN_PASS) {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('dashboard-section').classList.remove('hidden');
                document.getElementById('logoutBtn').classList.remove('hidden');
                initDashboard();
            } else { document.getElementById('loginError').classList.remove('hidden'); }
        }
        window.logout = () => window.location.reload();

        // --- TABS ---
        window.switchTab = (tabName) => {
            ['registrations', 'news', 'widget', 'schedule', 'league'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.add('hidden');
                document.getElementById(`btn-${t}`).classList.replace('active-tab', 'inactive-tab');
            });
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            document.getElementById(`btn-${tabName}`).classList.replace('inactive-tab', 'active-tab');
        }

        function initDashboard() {
            loadRegistrations();
            loadNewsHistory();
            loadTableEditor();
            populateTeamSelects(); // New function for dropdowns
        }

        // --- POPULATE DROPDOWNS ---
        function populateTeamSelects() {
            const options = DEPARTMENTS.map(d => `<option value="${d}">${d}</option>`).join('');
            document.getElementById('teamA').innerHTML = `<option value="">Select Team A</option>` + options;
            document.getElementById('teamB').innerHTML = `<option value="">Select Team B</option>` + options;
        }

        // --- UPLOAD TEAM LOGO ---
        window.uploadTeamLogo = async () => {
            const dept = document.getElementById('logoDeptSelect').value;
            const file = document.getElementById('teamLogoFile').files[0];
            const btn = document.getElementById('uploadLogoBtn');
            const status = document.getElementById('logoStatus');

            if(!file) return alert("Select a file");
            btn.disabled = true; btn.textContent = "Uploading...";

            // Upload
            const storageRef = ref(storage, 'team_logos/' + dept + '.png'); // Force PNG name for simplicity
            const task = uploadBytesResumable(storageRef, file);
            
            task.on('state_changed', null, null, async () => {
                const url = await getDownloadURL(task.snapshot.ref);
                // Save URL to 'team_assets' collection
                await setDoc(doc(db, "team_assets", dept), { logoUrl: url });
                
                btn.disabled = false; btn.textContent = "Save Logo";
                status.classList.remove('hidden');
                setTimeout(() => status.classList.add('hidden'), 3000);
                alert(`${dept} logo saved!`);
            });
        }

        // --- 1. REGISTRATIONS ---
        window.loadRegistrations = async () => {
            const list = document.getElementById('registrations-list');
            list.innerHTML = 'Loading...';
            const snap = await getDocs(query(collection(db, "registrations"), orderBy("registeredAt", "desc")));
            list.innerHTML = snap.empty ? 'No teams.' : '';
            snap.forEach(d => list.innerHTML += `<div class="p-2 border rounded bg-gray-50 mb-2 text-sm"><b>${d.data().department}</b> (${d.data().registrationStatus})</div>`);
        }

        // --- 2. NEWS ---
        window.postNews = async () => {
            // Simplified for brevity - assumes logic from previous iteration
            const title = document.getElementById('newsTitle').value;
            const content = document.getElementById('newsContent').value;
            await addDoc(collection(db, "news_posts"), { title, content, timestamp: serverTimestamp() });
            alert("Published");
        }
        function loadNewsHistory() { /* ... */ }

        // --- 3. WIDGET (UPDATED TO SAVE LOGOS) ---
        window.saveFixture = async () => {
            const tA = document.getElementById('teamA').value;
            const tB = document.getElementById('teamB').value;
            
            // Fetch logos automatically
            let logoA = "", logoB = "";
            const docA = await getDoc(doc(db, "team_assets", tA));
            if(docA.exists()) logoA = docA.data().logoUrl;
            const docB = await getDoc(doc(db, "team_assets", tB));
            if(docB.exists()) logoB = docB.data().logoUrl;

            await setDoc(doc(db, "app_content", "current_fixture"), {
                teamA: tA, teamB: tB,
                teamALogo: logoA, teamBLogo: logoB, // Save logos to fixture doc
                date: document.getElementById('fixDate').value,
                time: document.getElementById('fixTime').value,
                venue: document.getElementById('fixVenue').value
            });
            alert("Widget Updated with Logos!");
        }

        // --- 5. TABLES ---
        window.changeTableLevel = (level) => {
            currentTableLevel = level;
            // Toggle classes...
            loadTableEditor();
        }
        async function loadTableEditor() { /* ...Same as before... */ }
        window.saveTable = async () => { /* ...Same as before... */ }

    </script>
</body>
</html>