<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EDU-LEAGUE | Command Center</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <link rel="icon" href="edulogo.jpg" type="image/jpeg">

    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #f0f4f8; }
        
        /* Modern Gradient Sidebar */
        .sidebar-gradient {
            background: linear-gradient(180deg, #1e1b4b 0%, #312e81 100%);
        }

        /* Nav Item Styling */
        .nav-item {
            display: flex; align-items: center; padding: 12px 16px; margin: 4px 12px;
            border-radius: 12px; color: #a5b4fc; font-weight: 500; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
        }
        .nav-item:hover { background: rgba(255, 255, 255, 0.05); color: white; transform: translateX(4px); }
        .nav-item.active {
            background: linear-gradient(90deg, #6366f1 0%, #4f46e5 100%);
            color: white; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .nav-item i { width: 24px; text-align: center; margin-right: 12px; font-size: 1.1em; }

        /* Card Styling */
        .card {
            background: white; border-radius: 20px;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0; transition: transform 0.2s;
        }
        .card-header { padding: 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        
        /* Inputs */
        .input-field {
            width: 100%; background: #f8fafc; border: 1px solid #cbd5e1;
            padding: 10px 14px; border-radius: 10px; font-size: 0.9rem; font-weight: 600;
            color: #1e293b; outline: none; transition: border 0.2s;
        }
        .input-field:focus { border-color: #6366f1; background: white; ring: 3px solid #e0e7ff; }

        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
            color: white; font-weight: 700; padding: 10px 20px; border-radius: 10px;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2); transition: transform 0.2s;
        }
        .btn-primary:active { transform: scale(0.98); }

        /* Spotlight Cards */
        .spotlight-slot {
            border: 2px dashed #cbd5e1; border-radius: 16px; min-height: 100px;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            color: #94a3b8; font-weight: 700; font-size: 0.8rem; background: #f8fafc;
        }
        .spotlight-slot.filled {
            border: 2px solid #6366f1; background: #eef2ff; color: #312e81;
        }

        /* Loading */
        .loader { width: 24px; height: 24px; border: 3px solid #fff; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <div id="login-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-[#0f172a]/90 backdrop-blur-md p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 to-purple-500"></div>
            <div class="h-20 w-20 bg-indigo-50 rounded-2xl flex items-center justify-center mx-auto mb-6">
                <i class="fa-solid fa-user-astronaut text-3xl text-indigo-600"></i>
            </div>
            <h2 class="text-2xl font-black text-slate-800">Command Center</h2>
            <p class="text-sm text-slate-400 mb-6">Edu-League Administration</p>
            <form id="login-form" class="space-y-4">
                <input type="email" id="adm-email" placeholder="Email Address" class="input-field">
                <input type="password" id="adm-pass" placeholder="Access Key" class="input-field">
                <button type="submit" class="w-full btn-primary py-3">AUTHENTICATE</button>
            </form>
        </div>
    </div>

    <aside class="w-72 sidebar-gradient hidden md:flex flex-col z-20 shadow-xl">
        <div class="h-24 flex items-center px-6">
            <div class="h-10 w-10 bg-white/10 rounded-xl flex items-center justify-center text-white mr-3 border border-white/10">
                <i class="fa-solid fa-crown"></i>
            </div>
            <div>
                <h1 class="text-lg font-black text-white tracking-tight">EDU-ADMIN</h1>
                <p class="text-[10px] font-bold text-indigo-200 uppercase tracking-widest">Master Control</p>
            </div>
        </div>
        
        <nav class="flex-1 overflow-y-auto py-2">
            <div class="px-6 py-2 text-[10px] font-black text-indigo-300 uppercase tracking-widest">Overview</div>
            <button onclick="nav('dashboard')" id="btn-dashboard" class="nav-item active"><i class="fa-solid fa-grid-2"></i> Dashboard</button>
            
            <div class="px-6 py-2 mt-4 text-[10px] font-black text-indigo-300 uppercase tracking-widest">Competition</div>
            <button onclick="nav('schedule')" id="btn-schedule" class="nav-item"><i class="fa-regular fa-calendar-check"></i> Schedule</button>
            <button onclick="nav('tables')" id="btn-tables" class="nav-item"><i class="fa-solid fa-table-list"></i> Standings</button>
            <button onclick="nav('spotlight')" id="btn-spotlight" class="nav-item"><i class="fa-solid fa-star"></i> Spotlight</button>

            <div class="px-6 py-2 mt-4 text-[10px] font-black text-indigo-300 uppercase tracking-widest">Teams</div>
            <button onclick="nav('verification')" id="btn-verification" class="nav-item"><i class="fa-solid fa-clipboard-check"></i> Verify Teams</button>
            <button onclick="nav('assets')" id="btn-assets" class="nav-item"><i class="fa-solid fa-shield-cat"></i> Logos & Assets</button>
            
            <div class="px-6 py-2 mt-4 text-[10px] font-black text-indigo-300 uppercase tracking-widest">Engage</div>
            <button onclick="nav('news')" id="btn-news" class="nav-item"><i class="fa-solid fa-newspaper"></i> News Feed</button>
            <button onclick="nav('fanz')" id="btn-fanz" class="nav-item"><i class="fa-solid fa-bolt"></i> Fan Zone</button>
        </nav>

        <div class="p-4 border-t border-white/5">
            <button onclick="logout()" class="w-full flex items-center justify-center gap-2 text-xs font-bold text-red-200 hover:text-white bg-white/5 hover:bg-red-500/20 py-3 rounded-xl transition"><i class="fa-solid fa-power-off"></i> System Logout</button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden">
        <header class="h-16 bg-white border-b flex md:hidden items-center justify-between px-4 z-20">
            <span class="font-black text-indigo-800 text-lg">EDU-LEAGUE</span>
            <button onclick="document.querySelector('aside').classList.toggle('hidden'); document.querySelector('aside').classList.add('absolute', 'h-full');" class="text-slate-600"><i class="fa-solid fa-bars text-xl"></i></button>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 relative">

            <div id="dashboard" class="section animate-fade">
                <h1 class="text-3xl font-black text-slate-800 mb-6">Overview</h1>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="card p-5 border-l-4 border-indigo-500"><div class="text-[10px] font-bold text-slate-400 uppercase">Total Teams</div><div class="text-3xl font-black text-slate-800 mt-1" id="dash-teams">0</div></div>
                    <div class="card p-5 border-l-4 border-green-500"><div class="text-[10px] font-bold text-slate-400 uppercase">Verified</div><div class="text-3xl font-black text-slate-800 mt-1" id="dash-verified">0</div></div>
                    <div class="card p-5 border-l-4 border-blue-500"><div class="text-[10px] font-bold text-slate-400 uppercase">Fixtures</div><div class="text-3xl font-black text-slate-800 mt-1" id="dash-matches">0</div></div>
                    <div class="card p-5 border-l-4 border-purple-500"><div class="text-[10px] font-bold text-slate-400 uppercase">News</div><div class="text-3xl font-black text-slate-800 mt-1" id="dash-news">0</div></div>
                </div>
            </div>

            <div id="verification" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-black text-slate-800">Team Verification</h1>
                    <button onclick="loadVerifications()" class="text-xs font-bold text-indigo-600 bg-indigo-50 px-4 py-2 rounded-lg">Refresh List</button>
                </div>
                <div class="card overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-xs font-bold text-slate-500 uppercase border-b"><tr><th class="p-4">Team Info</th><th class="p-4">Level</th><th class="p-4">Status</th><th class="p-4 text-right">Actions</th></tr></thead>
                        <tbody id="verify-list" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

            <div id="assets" class="section hidden">
                <h1 class="text-2xl font-black text-slate-800 mb-6">Team Assets</h1>
                <div id="assets-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>

            <div id="schedule" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-black text-slate-800">Match Schedule</h1>
                    <button onclick="downloadSchedulePDF()" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-xs font-bold"><i class="fa-solid fa-file-pdf mr-2"></i>PDF</button>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="card p-6 h-fit">
                        <h3 class="font-bold text-slate-700 mb-4">New Fixture</h3>
                        <div class="space-y-3">
                            <select id="fix-div" class="input-field" onchange="filterTeamsByDiv()"><option value="">Select Division</option><option value="Finalist (400Lvl)">Finalist</option><option value="Penultimate (300Lvl)">Penultimate</option><option value="Sophomore (200Lvl)">Sophomore</option><option value="Female League">Female</option></select>
                            <div class="grid grid-cols-2 gap-2">
                                <select id="fix-day" class="input-field"><option>Matchday 1</option><option>Matchday 2</option><option>Matchday 3</option><option>Matchday 4</option><option>Matchday 5</option><option>Matchday 6</option><option>Matchday 7</option></select>
                                <input type="date" id="fix-date" class="input-field">
                            </div>
                            <select id="fix-time" class="input-field"><option value="TBD">⏰ TBD</option><option value="08:00">08:00 AM</option><option value="10:00">10:00 AM</option><option value="12:00">12:00 PM</option><option value="14:00">02:00 PM</option><option value="16:00">04:00 PM</option></select>
                            <div class="grid grid-cols-2 gap-2"><select id="fix-home" class="input-field"><option>Home</option></select><select id="fix-away" class="input-field"><option>Away</option></select></div>
                            <button onclick="saveFixture()" class="btn-primary w-full mt-2">ADD MATCH</button>
                        </div>
                    </div>
                    <div class="lg:col-span-2">
                        <div class="flex gap-2 mb-4">
                            <select id="view-div" onchange="loadSchedule()" class="input-field"><option value="All">All Divisions</option><option value="Finalist (400Lvl)">Finalist</option><option value="Penultimate (300Lvl)">Penultimate</option><option value="Sophomore (200Lvl)">Sophomore</option><option value="Female League">Female</option></select>
                            <select id="view-day" onchange="loadSchedule()" class="input-field"><option value="All">All Days</option><option>Matchday 1</option><option>Matchday 2</option><option>Matchday 3</option><option>Matchday 4</option><option>Matchday 5</option><option>Matchday 6</option><option>Matchday 7</option></select>
                        </div>
                        <div id="active-fixtures" class="space-y-3 max-h-[600px] overflow-y-auto"></div>
                    </div>
                </div>
            </div>

            <div id="spotlight" class="section hidden">
                <h1 class="text-2xl font-black text-slate-800 mb-2">Spotlight Manager</h1>
                <p class="text-sm text-slate-500 mb-6">Select up to 3 matches to feature on the homepage.</p>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card p-6 h-fit">
                        <h3 class="font-bold text-slate-700 mb-4 border-b pb-2">1. Find Match</h3>
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <select id="spot-div" class="input-field" onchange="loadSpotlightCandidates()"><option value="">Division</option><option value="Finalist (400Lvl)">Finalist</option><option value="Penultimate (300Lvl)">Penultimate</option><option value="Sophomore (200Lvl)">Sophomore</option><option value="Female League">Female</option></select>
                            <select id="spot-day" class="input-field" onchange="loadSpotlightCandidates()"><option value="">Matchday</option><option>Matchday 1</option><option>Matchday 2</option><option>Matchday 3</option><option>Matchday 4</option><option>Matchday 5</option><option>Matchday 6</option><option>Matchday 7</option></select>
                        </div>
                        <div id="spot-candidates" class="space-y-2 max-h-[300px] overflow-y-auto bg-slate-50 p-2 rounded-xl">
                            <p class="text-center text-xs text-slate-400 py-4">Select Division & Day to see matches.</p>
                        </div>
                    </div>

                    <div class="card p-6">
                        <h3 class="font-bold text-slate-700 mb-4 border-b pb-2 flex justify-between">
                            <span>2. Active Spotlights</span>
                            <button onclick="clearSpotlights()" class="text-xs text-red-500 font-bold">Clear All</button>
                        </h3>
                        <div id="active-spotlights" class="space-y-4">
                            </div>
                        <button onclick="publishSpotlights()" class="btn-primary w-full mt-6">UPDATE NEWS PAGE</button>
                    </div>
                </div>
            </div>

            <div id="fanz" class="section hidden">
                <h1 class="text-2xl font-black text-slate-800 mb-6">Fan Zone Control</h1>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="card p-6 h-fit">
                        <h3 class="font-bold text-slate-700 mb-4">Create Poll</h3>
                        <div class="space-y-3">
                            <input id="poll-q" placeholder="Question" class="input-field">
                            <input id="poll-o1" placeholder="Option 1" class="input-field">
                            <input id="poll-o2" placeholder="Option 2" class="input-field">
                            <button onclick="createPoll()" class="btn-primary w-full">LAUNCH POLL</button>
                        </div>
                    </div>
                    <div class="lg:col-span-2">
                        <h3 class="font-bold text-slate-700 mb-4">Active Polls</h3>
                        <div id="active-polls" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    </div>
                </div>
            </div>

            <div id="news" class="section hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="card p-6 h-fit">
                        <h3 class="font-bold text-slate-700 mb-4">New Article</h3>
                        <div class="space-y-3">
                            <input id="news-title" placeholder="Title" class="input-field">
                            <textarea id="news-body" rows="5" placeholder="Content..." class="input-field"></textarea>
                            <label class="block border-2 border-dashed border-slate-300 rounded-xl p-4 text-center cursor-pointer hover:bg-slate-50 transition">
                                <input type="file" id="news-file" class="hidden" onchange="document.getElementById('f-news-name').innerText = this.files[0].name">
                                <i class="fa-solid fa-cloud-arrow-up text-2xl text-slate-400"></i>
                                <p id="f-news-name" class="text-xs font-bold text-slate-500 mt-1">Upload Image/Video</p>
                            </label>
                            <button onclick="publishNews()" class="btn-primary w-full">PUBLISH</button>
                        </div>
                    </div>
                    <div class="lg:col-span-2 card p-6 h-[600px] flex flex-col">
                        <div class="flex justify-between mb-4"><h3 class="font-bold text-slate-700">Recent Posts</h3><button onclick="loadNews()" class="text-xs font-bold text-indigo-600">Refresh</button></div>
                        <div id="news-feed" class="flex-1 overflow-y-auto space-y-3 pr-2"></div>
                    </div>
                </div>
            </div>

            <div id="tables" class="section hidden">
                <h1 class="text-2xl font-black text-slate-800 mb-4">Standings</h1>
                <div class="flex gap-2 mb-4 overflow-x-auto">
                    <button onclick="loadTableData('Finalist (400Lvl)','Finalist')" class="btn-primary text-xs">Finalist</button>
                    <button onclick="loadTableData('Penultimate (300Lvl)','Penultimate')" class="btn-primary text-xs">Penultimate</button>
                    </div>
                <div class="card p-6">
                    <div id="table-editor-container"></div>
                    <button onclick="saveTableUpdates()" id="save-table-btn" class="btn-primary w-full mt-4 hidden">SAVE</button>
                </div>
            </div>

        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, deleteDoc, updateDoc, serverTimestamp, query, orderBy, where, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = { apiKey: "AIzaSyDtxFsLYoe0NYlZRWiXgEM90IYKMwx7K8s", authDomain: "sonic-verbena-239117.firebaseapp.com", projectId: "sonic-verbena-239117", storageBucket: "sonic-verbena-239117.appspot.com", messagingSenderId: "652544574249", appId: "1:652544574249:web:6ff33771307e892e7f6d38", measurementId: "G-TD780JGNED" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app); const storage = getStorage(app);

        // --- UTILS ---
        const notify = (msg, type="success") => {
            Toastify({ text: msg, duration: 3000, gravity: "top", position: "right", backgroundColor: type==="success"?"#10b981":"#ef4444", stopOnFocus: true }).showToast();
        };
        const mainLogoUrl = "edulogo.jpg";

        // --- AUTH ---
        document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); signInAnonymously(auth).catch(()=>{document.getElementById('login-msg').classList.remove('hidden');}); });
        onAuthStateChanged(auth, (u) => { if(u) { document.getElementById('login-modal').classList.add('hidden'); initData(); } else { document.getElementById('login-modal').classList.remove('hidden'); } });
        window.logout = () => signOut(auth);
        window.nav = (id) => {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden')); document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active')); const btn = document.getElementById('btn-'+id); if(btn) btn.classList.add('active');
        }

        async function initData() {
            loadVerifications(); loadTeams(); loadSchedule(); loadNews(); loadActivePolls();
            // Stats
            const t = await getDocs(collection(db, "registrations"));
            document.getElementById('dash-teams').innerText = t.size;
            document.getElementById('dash-verified').innerText = t.docs.filter(d => d.data().registrationStatus === "Verified").length;
            document.getElementById('dash-matches').innerText = (await getDocs(collection(db, "schedules"))).size; // CHANGED TO SCHEDULES
            document.getElementById('dash-news').innerText = (await getDocs(collection(db, "news_posts"))).size;
        }

        // --- 1. VERIFICATION (FIXED SORTING) ---
        window.loadVerifications = async () => {
            const list = document.getElementById('verify-list'); list.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-slate-400">Loading...</td></tr>';
            // Removed orderBy to ensure data loads even if index missing
            const s = await getDocs(collection(db, "registrations"));
            list.innerHTML = '';
            if(s.empty) { list.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-slate-400">No registrations found.</td></tr>'; return; }
            s.forEach(d => {
                const data = d.data();
                const clr = data.registrationStatus === "Verified" ? "text-green-600 bg-green-50" : "text-amber-600 bg-amber-50";
                list.innerHTML += `<tr class="border-b border-slate-50 hover:bg-slate-50"><td class="p-4"><div class="font-bold text-slate-800">${data.department}</div><div class="text-xs text-slate-400">${data.teamName}</div></td><td class="p-4 text-xs font-bold text-slate-500">${data.level}</td><td class="p-4"><span class="${clr} px-2.5 py-1 rounded-lg text-[10px] font-black uppercase">${data.registrationStatus||'Pending'}</span></td><td class="p-4 text-right"><button onclick="verifyTeam('${d.id}')" class="text-indigo-600 bg-indigo-50 p-2 rounded-lg hover:bg-indigo-100 transition"><i class="fa-solid fa-check"></i></button></td></tr>`;
            });
        };
        window.verifyTeam = async (id) => { if(confirm("Confirm Verification?")) { await updateDoc(doc(db,"registrations",id), {registrationStatus:"Verified"}); notify("Team Verified"); loadVerifications(); }};

        // --- 2. ASSETS (FEEDBACK) ---
        window.loadTeams = async () => {
            const grid = document.getElementById('assets-grid'); grid.innerHTML = '<p class="text-slate-400">Loading...</p>';
            const s = await getDocs(collection(db,"registrations"));
            grid.innerHTML = '';
            for(const d of s.docs) {
                const data = d.data();
                let logo = "edulogo.jpg";
                // Timestamp to force refresh image
                try { const a = await getDoc(doc(db,"team_assets",data.department)); if(a.exists()) logo = a.data().logoUrl + '?t=' + new Date().getTime(); } catch(e){}
                grid.innerHTML += `<div class="card p-3 flex items-center gap-3 hover:shadow-lg transition"><img src="${logo}" class="h-12 w-12 rounded-xl bg-slate-50 object-cover border"><div class="flex-1 min-w-0"><h4 class="font-bold text-slate-800 text-sm truncate">${data.department}</h4><p class="text-[10px] font-bold text-slate-400 uppercase mb-2">${data.level}</p><label class="cursor-pointer text-[10px] font-bold bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-lg hover:bg-indigo-600 hover:text-white transition">Upload <input type="file" class="hidden" onchange="upLogo(event, '${data.department}')" accept="image/*"></label></div></div>`;
            }
        };
        window.upLogo = async (e, id) => {
            const f = e.target.files[0]; if(!f) return;
            const r = ref(storage, `logos/${id}_${Date.now()}`);
            notify("Uploading Logo...", "info");
            await uploadBytes(r, f); const u = await getDownloadURL(r);
            await setDoc(doc(db,"team_assets",id), { logoUrl: u }, { merge: true });
            notify("Logo Updated Successfully!"); loadTeams();
        };

        // --- 3. SCHEDULE (FIXED COLLECTION: schedules) ---
        let allSchedules = [];
        let allRegTeams = [];
        window.loadSchedule = async () => {
            if(allRegTeams.length===0) (await getDocs(collection(db,"registrations"))).forEach(d=>allRegTeams.push(d.data()));
            const el = document.getElementById('active-fixtures'); el.innerHTML='Loading...';
            // CHANGED TO 'schedules'
            const snap = await getDocs(collection(db,"schedules"));
            allSchedules = snap.docs.map(d => ({id:d.id, ...d.data()}));
            renderMatches();
        };
        function renderMatches() {
            const el = document.getElementById('active-fixtures'); el.innerHTML = '';
            const fDiv = document.getElementById('view-div').value, fDay = document.getElementById('view-day').value;
            let filtered = allSchedules;
            if(fDiv!=='All') filtered = filtered.filter(m => m.div === fDiv);
            if(fDay!=='All') filtered = filtered.filter(m => m.day === fDay);
            
            if(filtered.length===0) { el.innerHTML='<p class="text-center text-slate-400 text-sm">No matches found.</p>'; return; }
            filtered.forEach(m => {
                const isTBD = m.time === 'TBD' || !m.time;
                el.innerHTML += `<div class="card p-3 flex justify-between items-center mb-3"><div><div class="flex items-center gap-2 mb-1"><span class="text-[9px] font-black bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded uppercase">${(m.div||'').split(' ')[0]}</span><span class="text-[9px] font-bold text-slate-400 uppercase">${m.day||''}</span></div><div class="font-black text-slate-800 text-sm">${m.home} <span class="text-slate-400 font-normal mx-1">vs</span> ${m.away}</div><div class="text-[10px] font-bold text-slate-500 mt-1">${isTBD && !m.date ? 'Pending' : m.date} • ${isTBD?'TBD':m.time}</div></div><button onclick="deleteMatch('${m.id}')" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></div>`;
            });
        }
        window.filterTeamsByDiv = () => { const div=document.getElementById('fix-div').value, h=document.getElementById('fix-home'), a=document.getElementById('fix-away'); h.innerHTML='<option>Home</option>'; a.innerHTML='<option>Away</option>'; allRegTeams.filter(t=>t.level===div || (div==="Female League"&&t.division==="Female")).forEach(t=>{ const o=`<option value="${t.department}">${t.department}</option>`; h.innerHTML+=o; a.innerHTML+=o; }); };
        window.saveFixture = async () => { 
            const f={div:document.getElementById('fix-div').value, day:document.getElementById('fix-day').value, date:document.getElementById('fix-date').value, time:document.getElementById('fix-time').value, home:document.getElementById('fix-home').value, away:document.getElementById('fix-away').value, timestamp:serverTimestamp()}; 
            if(!f.home) return notify("Select Teams!", "error"); 
            // Saving to 'schedules'
            await addDoc(collection(db,"schedules"), f); notify("Fixture Added"); loadSchedule(); 
        };
        window.deleteMatch = async(id) => { if(confirm("Delete?")) { await deleteDoc(doc(db,"schedules",id)); notify("Deleted"); loadSchedule(); }};

        // --- 4. SPOTLIGHT MANAGER (ADVANCED) ---
        let currentSpotlights = [];
        window.loadSpotlightCandidates = () => {
            const div = document.getElementById('spot-div').value;
            const day = document.getElementById('spot-day').value;
            const el = document.getElementById('spot-candidates');
            if(!div || !day) return;
            
            // Filter from loaded schedules
            const matches = allSchedules.filter(m => m.div === div && m.day === day);
            el.innerHTML = '';
            matches.forEach(m => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-3 bg-white border rounded-lg text-xs font-bold text-slate-700 hover:bg-indigo-50 mb-2";
                btn.innerHTML = `<span>${m.home} vs ${m.away}</span>`;
                btn.onclick = () => addToSpotlight(m);
                el.appendChild(btn);
            });
        };
        function addToSpotlight(m) {
            if(currentSpotlights.length >= 3) return notify("Max 3 Spotlights!", "error");
            currentSpotlights.push(m);
            renderSpotlightUI();
        }
        function renderSpotlightUI() {
            const el = document.getElementById('active-spotlights');
            el.innerHTML = '';
            currentSpotlights.forEach((m, i) => {
                el.innerHTML += `<div class="p-3 bg-indigo-50 border border-indigo-100 rounded-xl flex justify-between items-center"><div class="text-xs font-bold text-indigo-900">${m.home} vs ${m.away}<br><span class="text-[9px] text-indigo-400">${m.day}</span></div><button onclick="removeSpot(${i})" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-times"></i></button></div>`;
            });
        }
        window.removeSpot = (i) => { currentSpotlights.splice(i, 1); renderSpotlightUI(); };
        window.clearSpotlights = () => { currentSpotlights = []; renderSpotlightUI(); };
        window.publishSpotlights = async () => {
            if(currentSpotlights.length === 0) return notify("No matches selected", "error");
            
            // Fetch Logos for them
            const spotlightData = await Promise.all(currentSpotlights.map(async (m) => {
                let l1 = "edulogo.jpg", l2 = "edulogo.jpg";
                try {
                    const s1 = await getDoc(doc(db,"team_assets",m.home)); if(s1.exists()) l1 = s1.data().logoUrl;
                    const s2 = await getDoc(doc(db,"team_assets",m.away)); if(s2.exists()) l2 = s2.data().logoUrl;
                } catch(e) {}
                return {
                    teamA: m.home, teamB: m.away, teamALogo: l1, teamBLogo: l2,
                    date: m.date || 'TBD', time: m.time || 'TBD', venue: 'Main Bowl', category: 'SPOTLIGHT'
                };
            }));

            await setDoc(doc(db, "app_content", "current_fixture"), { matches: spotlightData });
            notify("Spotlight Updated on News Page!");
        };

        // --- 5. POLLS (MULTIPLE) ---
        window.createPoll = async () => {
            const q = document.getElementById('poll-q').value, o1 = document.getElementById('poll-o1').value, o2 = document.getElementById('poll-o2').value;
            if(!q) return notify("Question Required", "error");
            await addDoc(collection(db, "polls"), {
                question: q, opt1: o1, opt2: o2, votes1: 0, votes2: 0, 
                active: true, timestamp: serverTimestamp()
            });
            notify("Poll Created"); loadActivePolls();
        };
        window.loadActivePolls = async () => {
            const el = document.getElementById('active-polls'); el.innerHTML = '';
            const snap = await getDocs(query(collection(db, "polls"), orderBy("timestamp", "desc")));
            snap.forEach(d => {
                const p = d.data();
                const statusColor = p.active ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
                el.innerHTML += `
                    <div class="card p-4 mb-2">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-sm text-slate-800">${p.question}</h4>
                            <span class="${statusColor} text-[9px] font-black px-2 py-1 rounded uppercase">${p.active?'Active':'Stopped'}</span>
                        </div>
                        <div class="flex gap-2 justify-end">
                            ${p.active ? `<button onclick="stopPoll('${d.id}')" class="text-xs bg-orange-100 text-orange-600 px-3 py-1 rounded font-bold">Stop</button>` : ''}
                            <button onclick="deletePoll('${d.id}')" class="text-xs bg-slate-100 text-slate-500 px-3 py-1 rounded font-bold">Delete</button>
                        </div>
                    </div>
                `;
            });
        };
        window.stopPoll = async (id) => { await updateDoc(doc(db,"polls",id), {active:false}); notify("Poll Stopped"); loadActivePolls(); };
        window.deletePoll = async (id) => { if(confirm("Delete Poll?")) { await deleteDoc(doc(db,"polls",id)); notify("Poll Deleted"); loadActivePolls(); }};

        // --- 6. NEWS (SEPARATE) ---
        window.publishNews = async () => {
            const file = document.getElementById('news-file').files[0];
            let mediaUrl = "";
            if(file) {
                notify("Uploading Media...", "info");
                const r = ref(storage, `news/${Date.now()}_${file.name}`);
                await uploadBytes(r, file);
                mediaUrl = await getDownloadURL(r);
            }
            await addDoc(collection(db,"news_posts"), {
                title: document.getElementById('news-title').value,
                content: document.getElementById('news-body').value,
                imageUrl: mediaUrl,
                timestamp: serverTimestamp(), likes: 0, commentsCount: 0
            });
            notify("News Published!"); loadNews();
        };
        window.loadNews = async () => {
            const el = document.getElementById('news-feed'); el.innerHTML = '';
            (await getDocs(query(collection(db,"news_posts"), orderBy("timestamp", "desc")))).forEach(d => {
                el.innerHTML += `<div class="p-3 bg-slate-50 rounded-xl mb-2 flex justify-between items-center"><span class="text-xs font-bold text-slate-700 truncate w-32">${d.data().title}</span><button onclick="deleteDoc(doc(db,'news_posts','${d.id}'));loadNews()" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button></div>`;
            });
        };

        // --- TABLES ---
        let curDivCode = '';
        window.loadTableData = async (regLevel, shortCode) => {
            curDivCode = shortCode; document.getElementById('table-editor-container').innerHTML = '<span class="loader"></span>';
            const tableDoc = await getDoc(doc(db, "app_content", `league_table_${shortCode}`));
            const existing = tableDoc.exists() ? tableDoc.data() : {};
            const regSnap = await getDocs(query(collection(db, "registrations"), where("level", "==", regLevel)));
            
            let html = `<div class="grid grid-cols-12 gap-1 text-[9px] font-bold text-slate-400 uppercase mb-2 px-1"><div class="col-span-3">Team</div><div class="col-span-1 text-center">PL</div><div class="col-span-1 text-center">W</div><div class="col-span-1 text-center">D</div><div class="col-span-1 text-center">L</div><div class="col-span-1 text-center">GD</div><div class="col-span-2 text-center">PTS</div></div>`;
            
            const map = {};
            Object.keys(existing).forEach(k => map[k] = existing[k]);
            regSnap.forEach(d => { if(!map[d.data().department]) map[d.data().department] = {mp:0,w:0,d:0,l:0,gd:0,pts:0}; });
            
            Object.keys(map).sort((a,b)=>map[b].pts-map[a].pts).forEach(t => {
                const d = map[t];
                html += `<div class="grid grid-cols-12 gap-1 items-center mb-2 team-row bg-slate-50 p-2 rounded-lg border border-slate-100" data-name="${t}">
                    <div class="col-span-3 font-bold text-xs truncate text-slate-800">${t}</div>
                    <input type="number" class="col-span-1 tbl-inp inp-mp" value="${d.mp||0}">
                    <input type="number" class="col-span-1 tbl-inp inp-w text-green-600" value="${d.w||0}">
                    <input type="number" class="col-span-1 tbl-inp inp-d" value="${d.d||0}">
                    <input type="number" class="col-span-1 tbl-inp inp-l text-red-500" value="${d.l||0}">
                    <input type="number" class="col-span-1 tbl-inp inp-gd" value="${d.gd||0}">
                    <input type="number" class="col-span-2 tbl-inp inp-pts bg-indigo-50 text-indigo-700" value="${d.pts||0}">
                </div>`;
            });
            document.getElementById('table-editor-container').innerHTML = html;
            document.getElementById('save-table-btn').classList.remove('hidden');
        };
        window.saveTableUpdates = async () => {
            const rows = document.querySelectorAll('.team-row'); let d = {};
            rows.forEach(r => {
                d[r.dataset.name] = {
                    mp: parseInt(r.querySelector('.inp-mp').value)||0,
                    w: parseInt(r.querySelector('.inp-w').value)||0,
                    d: parseInt(r.querySelector('.inp-d').value)||0,
                    l: parseInt(r.querySelector('.inp-l').value)||0,
                    gd: parseInt(r.querySelector('.inp-gd').value)||0,
                    pts: parseInt(r.querySelector('.inp-pts').value)||0
                };
            });
            await setDoc(doc(db, "app_content", `league_table_${curDivCode}`), d); notify("Standings Updated");
        };

    </script>
</body>
</html>