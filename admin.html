<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EDU-LEAGUE | Admin Console</title>
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#6d28d9">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js');
        });
    }
</script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <link rel="icon" href="edulogo.jpg" type="image/jpeg">

    <style>
        :root { --navy: #0f172a; --blue: #2563eb; --green: #10b981; --orange: #f59e0b; --red: #dc2626; --surface: #ffffff; --bg: #f1f5f9; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); background-image: radial-gradient(#cbd5e1 1.5px, transparent 1.5px); background-size: 24px 24px; color: #1e293b; }
        h1, h2, h3, h4 { font-family: 'Rajdhani', sans-serif; text-transform: uppercase; }
        .sport-card { background: var(--surface); border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); position: relative; overflow: hidden; }
        .sport-card::before { content: ''; position: absolute; top:0; left:0; width:4px; height:100%; background: var(--navy); }
        .border-l-blue::before { background: var(--blue); } .border-l-green::before { background: var(--green); } .border-l-orange::before { background: var(--orange); } .border-l-red::before { background: var(--red); } .border-l-purple::before { background: #9333ea; }
        .input-sport { width: 100%; padding: 10px 12px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; font-family: 'Rajdhani', sans-serif; font-weight: 600; font-size: 0.9rem; outline: none; transition: 0.2s; }
        .input-sport:focus { background: white; border-color: var(--blue); }
        .btn-sport { background: var(--navy); color: white; font-family: 'Rajdhani', sans-serif; font-weight: 700; padding: 12px; border-radius: 6px; letter-spacing: 1px; text-transform: uppercase; transition: 0.2s; width: 100%; display: flex; justify-content: center; align-items: center; gap: 8px; cursor: pointer; }
        .btn-sport:hover { background: #1e293b; transform: translateY(-1px); }
        .btn-accent { background: var(--blue); } .btn-accent:hover { background: #1d4ed8; }
        .btn-danger { background: var(--red); } .btn-danger:hover { background: #b91c1c; }
        .nav-container { background: var(--navy); color: white; box-shadow: 0 4px 20px -5px rgba(0,0,0,0.3); }
        .nav-btn { padding: 8px 16px; border-radius: 4px; font-family: 'Rajdhani', sans-serif; font-weight: 600; color: #94a3b8; border-bottom: 2px solid transparent; }
        .nav-btn.active { color: var(--blue); border-bottom-color: var(--blue); background: rgba(37, 99, 235, 0.1); }
        .badge-item { padding: 10px; border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; border: 1px solid #e2e8f0; background: white; margin-bottom: 6px; }
        .badge-item.active { background: #eff6ff; border-color: var(--blue); border-left: 4px solid var(--blue); }
        #notify-bar { position: fixed; top: -100px; left: 0; right: 0; background: var(--navy); color: white; border-bottom: 3px solid var(--green); padding: 16px; text-align: center; font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 1.2rem; z-index: 10000; transition: top 0.4s; display: flex; justify-content: center; gap: 10px; }
        #notify-bar.show { top: 0; }
        .loader { width: 20px; height: 20px; border: 3px solid #fff; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .tbd-label { display: flex; items-center; font-size: 0.75rem; font-weight: 700; color: #64748b; margin-top: 4px; }
        .tbd-check { margin-right: 6px; width: 16px; height: 16px; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <div id="notify-bar"><i id="notify-icon" class="fa-solid fa-check"></i><span id="notify-msg">READY</span></div>

    <div id="login-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/95 backdrop-blur-md p-4">
        <div class="sport-card p-10 max-w-sm w-full text-center border-l-orange">
            <div class="h-16 w-16 bg-gradient-to-br from-slate-800 to-slate-900 rounded-lg flex items-center justify-center mx-auto mb-6 shadow-lg border border-slate-700">
                <span class="text-2xl font-black text-white font-[Rajdhani]">EL</span>
            </div>
            <h2 class="text-3xl font-black text-slate-800 mb-1">ADMIN ACCESS</h2>
            <p class="text-xs text-slate-500 mb-8 font-bold tracking-widest uppercase">Restricted Area</p>
            <form id="login-form" class="space-y-4">
                <input type="password" id="adm-pass" placeholder="ACCESS CODE" class="input-sport text-center tracking-[0.3em] uppercase" required>
                <button type="submit" id="btn-auth" class="w-full btn-sport">Authorize</button>
            </form>
            <p id="login-msg" class="text-red-600 text-xs font-bold mt-4 hidden bg-red-50 py-2 rounded">INVALID CODE</p>
        </div>
    </div>

    <nav class="nav-container sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="flex justify-between items-center w-full md:w-auto">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 text-white h-8 w-8 rounded flex items-center justify-center font-black skew-x-[-10deg]"><span class="skew-x-[10deg]">E</span></div>
                    <span class="font-black text-2xl tracking-tighter text-white font-[Rajdhani]">EDU-LEAGUE <span class="text-blue-500 text-sm align-top">ADMIN</span></span>
                </div>
                <button onclick="logout()" class="md:hidden text-slate-400 hover:text-red-500"><i class="fa-solid fa-power-off"></i></button>
            </div>
            <div class="overflow-x-auto w-full md:w-auto flex gap-2 no-scrollbar pb-1">
                <button onclick="nav('dashboard')" id="btn-dashboard" class="nav-btn active">DASHBOARD</button>
                <button onclick="nav('teams')" id="btn-teams" class="nav-btn">BADGES</button>
                <button onclick="nav('rosters')" id="btn-rosters" class="nav-btn text-purple-400 hover:text-purple-300">ROSTERS</button>
                <button onclick="nav('schedule')" id="btn-schedule" class="nav-btn">FIXTURES</button>
                <button onclick="nav('results')" id="btn-results" class="nav-btn text-red-400 hover:text-red-300">SCORES</button>
                <button onclick="nav('tables')" id="btn-tables" class="nav-btn">TABLES</button>
                <button onclick="nav('spotlight')" id="btn-spotlight" class="nav-btn">SPOTLIGHT</button>
                <button onclick="nav('stats')" id="btn-stats" class="nav-btn">STATS</button>
                <button onclick="nav('news')" id="btn-news" class="nav-btn">NEWS</button>
                <button onclick="nav('fanz')" id="btn-fanz" class="nav-btn">FANZ</button>
                <button onclick="nav('partners')" id="btn-partners" class="nav-btn text-yellow-400 hover:text-yellow-300">PARTNERS</button>
                <button onclick="nav('verification')" id="btn-verification" class="nav-btn">VERIFY</button>
            </div>
            <button onclick="logout()" class="hidden md:flex items-center gap-2 text-slate-400 hover:text-red-500 font-bold text-xs uppercase tracking-wide"><i class="fa-solid fa-power-off"></i> LOGOUT</button>
        </div>
    </nav>

    <main class="flex-1 overflow-y-auto p-4 md:p-8 max-w-7xl mx-auto w-full mb-12">

        <div id="dashboard" class="section">
            <h2 class="text-2xl font-black text-slate-800 mb-6 flex items-center gap-2"><i class="fa-solid fa-chart-pie text-blue-600"></i> OVERVIEW</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="sport-card p-6 border-l-blue"><p class="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Teams</p><h3 class="text-4xl font-black text-slate-800 mt-1" id="dash-teams">0</h3><i class="fa-solid fa-users absolute top-4 right-4 text-slate-100 text-4xl"></i></div>
                <div class="sport-card p-6 border-l-green"><p class="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Verified</p><h3 class="text-4xl font-black text-slate-800 mt-1" id="dash-verified">0</h3><i class="fa-solid fa-check-double absolute top-4 right-4 text-slate-100 text-4xl"></i></div>
                <div class="sport-card p-6 border-l-orange"><p class="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Matches</p><h3 class="text-4xl font-black text-slate-800 mt-1" id="dash-matches">0</h3><i class="fa-solid fa-calendar-day absolute top-4 right-4 text-slate-100 text-4xl"></i></div>
                <div class="sport-card p-6 border-l-4 border-l-slate-800"><p class="text-[10px] font-bold uppercase text-slate-400 tracking-wider">News</p><h3 class="text-4xl font-black text-slate-800 mt-1" id="dash-news">0</h3><i class="fa-solid fa-newspaper absolute top-4 right-4 text-slate-100 text-4xl"></i></div>
            </div>
        </div>

        <div id="rosters" class="section hidden">
            <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-black text-slate-800"><i class="fa-solid fa-clipboard-list text-purple-600"></i> TEAM ROSTERS</h2></div>
            <div class="sport-card border-l-purple overflow-hidden">
                <table class="w-full text-sm text-left"><thead class="bg-slate-50 text-[10px] font-bold text-slate-500 uppercase border-b"><tr><th class="p-4 pl-6">Department</th><th class="p-4">Level</th><th class="p-4">Players</th><th class="p-4 text-right pr-6">Action</th></tr></thead><tbody id="roster-table-body" class="divide-y divide-slate-100"></tbody></table>
            </div>
        </div>

        <div id="teams" class="section hidden">
            <h2 class="text-2xl font-black text-slate-800 mb-6 flex items-center gap-2"><i class="fa-solid fa-id-badge text-blue-600"></i> BADGE MANAGER</h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:h-[600px] h-auto">
                <div class="sport-card flex flex-col h-[400px] lg:h-full border-l-blue"><div class="p-4 border-b border-gray-100 bg-slate-50 flex justify-between items-center"><h3 class="font-bold text-slate-700 text-sm">TEAM ROSTER</h3><span class="text-[10px] font-bold bg-white border px-2 py-1 rounded text-slate-500">SELECT TO EDIT</span></div><div id="badge-tracker-list" class="flex-1 overflow-y-auto p-3 bg-slate-50/50"></div></div>
                <div class="col-span-1 lg:col-span-2"><div class="sport-card p-8 h-full flex flex-col justify-center border-l-orange bg-white"><div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center"><div class="space-y-6"><div><label class="text-xs font-bold text-slate-400 uppercase block mb-1">TARGET TEAM</label><input id="logo-team-name-display" class="input-sport bg-slate-100 text-slate-500 cursor-not-allowed" readonly placeholder="SELECT FROM ROSTER"><input type="hidden" id="logo-team-name"><input type="hidden" id="logo-team-div"></div><div class="relative group cursor-pointer border-2 border-dashed border-slate-300 rounded-lg p-8 text-center hover:bg-slate-50 hover:border-blue-500 transition"><input type="file" id="logo-file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="previewFile(this)" accept="image/*"><i class="fa-solid fa-cloud-arrow-up text-4xl text-slate-300 group-hover:text-blue-500 mb-2"></i><p class="text-sm font-bold text-slate-600 font-[Rajdhani] uppercase" id="logo-file-label">TAP TO SELECT</p><p class="text-[10px] text-slate-400">Open Gallery</p></div><button onclick="uploadBadgeDirect()" id="btn-save-badge" class="w-full btn-sport btn-accent shadow-lg">UPLOAD & SAVE</button></div><div class="flex flex-col items-center justify-center border-t md:border-t-0 md:border-l border-slate-100 pt-6 md:pt-0 md:pl-6"><div class="w-48 h-48 bg-slate-50 rounded-full flex items-center justify-center shadow-inner border border-slate-200 p-6 mb-4 relative"><img id="logo-preview" src="edulogo.jpg" class="w-full h-full object-contain"><div class="absolute bottom-0 bg-green-500 text-white text-[10px] font-bold px-3 py-1 rounded shadow hidden" id="preview-badge">ACTIVE</div></div><p class="text-xs font-bold text-slate-400 uppercase tracking-widest">LIVE PREVIEW</p></div></div></div></div>
            </div>
        </div>

        <div id="schedule" class="section hidden">
            <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-black text-slate-800"><i class="fa-regular fa-calendar-days text-blue-600"></i> FIXTURE LIST</h2><button onclick="downloadSchedulePDF()" class="bg-slate-800 text-white px-4 py-2 rounded text-xs font-bold font-[Rajdhani] uppercase">Export PDF</button></div>
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <div class="lg:col-span-8"><div class="flex gap-3 mb-4 overflow-x-auto pb-1 no-scrollbar"><select id="view-div" onchange="loadSchedule()" class="input-sport w-auto"><option value="All">ALL DIVISIONS</option><option value="Finalist (400Lvl)">Finalist</option><option value="Penultimate (300Lvl)">Penultimate</option><option value="Sophomore (200Lvl)">Sophomore</option><option value="Female League">Female</option></select><select id="view-day" onchange="loadSchedule()" class="input-sport w-auto"><option value="All">ALL MATCHDAYS</option><option>Matchday 1</option><option>Matchday 2</option><option>Matchday 3</option><option>Matchday 4</option><option>Matchday 5</option><option>Matchday 6</option><option>Matchday 7</option><option>Matchday 8 (PlayOff)</option><option>Matchday 9 (Rest for All)</option><option>Matchday 10 (Final)</option></select></div><div id="active-fixtures" class="space-y-3"></div></div>
                <div class="lg:col-span-4 sport-card p-6 h-fit border-l-blue"><h3 class="font-bold text-slate-800 mb-4 border-b pb-2">ADD FIXTURE</h3><div class="space-y-3"><select id="fix-div" class="input-sport" onchange="filterTeamsByDiv()"><option value="">SELECT DIVISION</option><option value="Finalist (400Lvl)">Finalist</option><option value="Penultimate (300Lvl)">Penultimate</option><option value="Sophomore (200Lvl)">Sophomore</option><option value="Female League">Female</option></select><div class="grid grid-cols-2 gap-2"><select id="fix-day" class="input-sport"><option>Matchday 1</option><option>Matchday 2</option><option>Matchday 3</option><option>Matchday 4</option><option>Matchday 5</option><option>Matchday 6</option><option>Matchday 7</option><option>Matchday 8 (PlayOff)</option><option>Matchday 9 (Rest for All)</option><option>Matchday 10 (Final)</option></select><input type="date" id="fix-date" class="input-sport"></div><div class="grid grid-cols-2 gap-2 items-center"><input type="time" id="fix-time" class="input-sport"><label class="tbd-label"><input type="checkbox" id="fix-time-tbd" class="tbd-check" onchange="toggleTime(this, 'fix-time')"> TIME TBD</label></div><div class="grid grid-cols-2 gap-2 items-center"><input type="text" id="fix-venue" placeholder="VENUE" class="input-sport uppercase"><label class="tbd-label"><input type="checkbox" id="fix-venue-tbd" class="tbd-check" onchange="toggleVenue(this, 'fix-venue')"> VENUE TBD</label></div><div class="grid grid-cols-2 gap-2"><select id="fix-home" class="input-sport"><option>HOME</option></select><select id="fix-away" class="input-sport"><option>AWAY</option></select></div><button onclick="saveFixture()" class="w-full btn-sport btn-accent">CREATE MATCH</button></div></div>
            </div>
        </div>

        <div id="results" class="section hidden">
            <h2 class="text-2xl font-black text-slate-800 mb-6"><i class="fa-solid fa-square-check text-red-500"></i> MATCH RESULTS & MOTM</h2>
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <div class="lg:col-span-1 sport-card p-6 h-fit border-l-red"><h3 class="font-bold text-slate-800 mb-4 border-b pb-2">FILTER</h3><div class="space-y-3"><select id="res-div" onchange="loadResults()" class="input-sport"><option value="All">All Divisions</option><option value="Finalist (400Lvl)">Finalist</option><option value="Penultimate (300Lvl)">Penultimate</option><option value="Sophomore (200Lvl)">Sophomore</option><option value="Female League">Female</option></select><select id="res-day" onchange="loadResults()" class="input-sport"><option value="All">All Days</option><option>Matchday 1</option><option>Matchday 2</option><option>Matchday 3</option><option>Matchday 4</option><option>Matchday 5</option><option>Matchday 6</option><option>Matchday 7</option><option>Matchday 8 (PlayOff)</option><option>Matchday 9 (Rest for All)</option><option>Matchday 10 (Final)</option></select><button onclick="loadResults()" class="w-full btn-sport btn-danger">REFRESH LIST</button></div></div>
                <div class="lg:col-span-3"><div id="results-list" class="space-y-3"></div></div>
            </div>
        </div>

        <div id="tables" class="section hidden">
            <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-black text-slate-800"><i class="fa-solid fa-list-ol text-blue-600"></i> STANDINGS</h2><button onclick="downloadTablePDF()" class="bg-slate-800 text-white px-4 py-2 rounded text-xs font-bold font-[Rajdhani] uppercase">Export PDF</button></div>
            <div class="flex gap-3 mb-6 overflow-x-auto pb-2 no-scrollbar"><button onclick="loadTableData('Finalist (400Lvl)','Finalist')" class="px-6 py-2 bg-white border border-slate-200 rounded text-xs font-bold font-[Rajdhani] hover:bg-slate-50 uppercase shadow-sm">Finalist</button><button onclick="loadTableData('Penultimate (300Lvl)','Penultimate')" class="px-6 py-2 bg-white border border-slate-200 rounded text-xs font-bold font-[Rajdhani] hover:bg-slate-50 uppercase shadow-sm">Penultimate</button><button onclick="loadTableData('Sophomore (200Lvl)','Sophomore')" class="px-6 py-2 bg-white border border-slate-200 rounded text-xs font-bold font-[Rajdhani] hover:bg-slate-50 uppercase shadow-sm">Sophomore</button><button onclick="loadTableData('Female League','Female')" class="px-6 py-2 bg-pink-50 border border-pink-200 text-pink-700 rounded text-xs font-bold font-[Rajdhani] uppercase shadow-sm">Female</button></div>
            <div id="table-logos" class="hidden mb-6 flex justify-between items-center w-full px-12 bg-white p-3 rounded shadow-sm border border-slate-200"><div class="text-center flex flex-col items-center"><img src="edulogo.jpg" class="h-16 w-16 object-cover"><p class="text-[8px] font-bold uppercase mt-1">LEAGUE</p></div><div class="text-slate-300 font-black text-2xl font-[Rajdhani]">VS</div><div class="text-center flex flex-col items-center relative group"><img id="div-logo-display" src="" class="h-16 w-16 object-contain"><label class="absolute -bottom-2 -right-2 bg-blue-600 text-white p-1.5 rounded-full text-xs hover:bg-blue-700 shadow-lg cursor-pointer"><i class="fa-solid fa-camera"></i><input type="file" class="hidden" onchange="changeDivLogoDirect(this)" accept="image/*"></label><p class="text-[8px] font-bold uppercase mt-1">DIVISION</p></div></div>
            <div class="sport-card p-6 border-l-green"><div id="table-container" class="space-y-2"></div><button onclick="saveTableUpdates()" id="save-table-btn" class="mt-6 w-full btn-sport btn-accent hidden">UPDATE TABLE</button></div>
        </div>

        <div id="spotlight" class="section hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="sport-card p-6 border-l-orange"><h3 class="font-bold text-slate-800 mb-4 border-b pb-2">MATCH FINDER</h3><div class="grid grid-cols-2 gap-3 mb-4"><select id="spot-div" class="input-sport" onchange="loadSpotlightCandidates()"><option value="">Division</option><option value="Finalist (400Lvl)">Finalist</option><option value="Penultimate (300Lvl)">Penultimate</option><option value="Sophomore (200Lvl)">Sophomore</option><option value="Female League">Female</option></select><select id="spot-day" class="input-sport" onchange="loadSpotlightCandidates()"><option value="">Day</option><option>Matchday 1</option><option>Matchday 2</option><option>Matchday 3</option><option>Matchday 4</option><option>Matchday 5</option><option>Matchday 6</option><option>Matchday 7</option></select></div><div id="spot-candidates" class="space-y-2 max-h-[300px] overflow-y-auto p-1"></div></div><div class="sport-card p-6 border-l-blue"><h3 class="font-bold text-slate-800 mb-4 border-b pb-2 flex justify-between"><span>FEATURED MATCHES (MAX 4)</span><button onclick="clearSpotlights()" class="text-xs text-red-500 hover:underline">CLEAR</button></h3><div id="active-spotlights" class="space-y-3"></div><button onclick="publishSpotlights()" class="w-full btn-sport mt-6">GO LIVE</button></div></div>
        </div>

        <div id="stats" class="section hidden"><div class="sport-card p-8 max-w-4xl mx-auto border-l-green"><div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 border-b pb-8"><div><label class="text-xs font-bold text-slate-400 uppercase mb-2 block">1. Team</label><select id="stat-team-select" class="input-sport" onchange="loadTeamPlayers()"><option value="">Select...</option></select></div><div><label class="text-xs font-bold text-slate-400 uppercase mb-2 block">2. Player</label><select id="stat-player-select" class="input-sport" onchange="fetchPlayerCurrentStats()"><option value="">Select...</option></select></div></div><div id="stats-editor" class="hidden"><div class="flex justify-between items-center mb-6"><h3 class="font-bold text-slate-800 text-xl">PLAYER STATS</h3></div><div class="grid grid-cols-3 md:grid-cols-5 gap-3 mb-8"><div class="bg-slate-50 p-3 rounded text-center border border-slate-200"><p class="text-[10px] font-bold text-green-600 uppercase mb-1">Goals</p><input type="number" id="p-goals" min="0" class="bg-transparent text-3xl font-black w-full text-center outline-none font-[Rajdhani]"></div><div class="bg-slate-50 p-3 rounded text-center border border-slate-200"><p class="text-[10px] font-bold text-blue-600 uppercase mb-1">Assists</p><input type="number" id="p-assists" min="0" class="bg-transparent text-3xl font-black w-full text-center outline-none font-[Rajdhani]"></div><div class="bg-slate-50 p-3 rounded text-center border border-slate-200"><p class="text-[10px] font-bold text-yellow-600 uppercase mb-1">Yellow</p><input type="number" id="p-yellow" min="0" class="bg-transparent text-3xl font-black w-full text-center outline-none font-[Rajdhani]"></div><div class="bg-slate-50 p-3 rounded text-center border border-slate-200"><p class="text-[10px] font-bold text-red-600 uppercase mb-1">Red</p><input type="number" id="p-red" min="0" class="bg-transparent text-3xl font-black w-full text-center outline-none font-[Rajdhani]"></div><div class="bg-slate-50 p-3 rounded text-center border border-slate-200"><p class="text-[10px] font-bold text-orange-600 uppercase mb-1">Saves</p><input type="number" id="p-saves" min="0" class="bg-transparent text-3xl font-black w-full text-center outline-none font-[Rajdhani]"></div></div><button onclick="savePlayerStats()" class="w-full btn-sport btn-accent">UPDATE STATS</button></div></div></div>
        
        <div id="news" class="section hidden"><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="sport-card p-6 h-fit border-l-blue"><h3 class="font-bold text-slate-800 mb-4 border-b pb-2">COMPOSE NEWS</h3><div class="space-y-3"><input id="news-title" placeholder="HEADLINE" class="input-sport uppercase"><textarea id="news-body" rows="4" placeholder="Details..." class="input-sport"></textarea><div class="relative group cursor-pointer border-2 border-dashed border-slate-300 rounded-lg p-4 text-center hover:bg-slate-50 transition"><input type="file" id="news-file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="document.getElementById('news-file-label').innerText=this.files[0].name"><i class="fa-solid fa-cloud-arrow-up text-xl text-slate-400 mb-1"></i><p class="text-xs font-bold text-slate-500 uppercase" id="news-file-label">Attach Media</p></div><button onclick="publishNews()" id="btn-pub-news" class="w-full btn-sport btn-accent">PUBLISH</button></div></div><div class="lg:col-span-2 sport-card p-6 h-[500px] flex flex-col border-l-orange"><div class="flex justify-between mb-4"><h3 class="font-bold text-slate-800">LIVE FEED</h3><button onclick="loadNews()" class="text-xs font-bold text-blue-600 uppercase">REFRESH</button></div><div id="news-feed" class="flex-1 overflow-y-auto space-y-2 pr-2"></div></div></div></div>

        <div id="fanz" class="section hidden">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <div class="lg:col-span-4 sport-card p-6 border-l-blue h-fit">
                    <h3 class="font-bold text-slate-800 mb-4">FAN POLL</h3>
                    <div class="space-y-3"><input id="poll-q" placeholder="QUESTION" class="input-sport"><input id="poll-o1" placeholder="OPTION 1" class="input-sport"><input id="poll-o2" placeholder="OPTION 2" class="input-sport"><button onclick="createPoll()" class="w-full btn-sport btn-accent">LAUNCH</button></div><div id="active-polls" class="mt-6 space-y-2"></div>
                </div>
                <div class="lg:col-span-8 sport-card p-6 border-l-purple">
                    <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-800 text-xl"><i class="fa-solid fa-user-astronaut text-purple-600"></i> PLAYER OF THE WEEK (POTW)</h3><div class="flex gap-2"><select id="potw-matchday" class="input-sport w-32 py-1"><option>Matchday 1</option><option>Matchday 2</option><option>Matchday 3</option><option>Matchday 4</option><option>Matchday 5</option><option>Matchday 6</option><option>Matchday 7</option><option>Matchday 8</option><option>Matchday 9</option><option>Matchday 10</option></select><button onclick="togglePOTWVoting(false)" class="bg-red-500 text-white px-4 rounded text-xs font-bold hover:bg-red-600">STOP VOTE</button></div></div>
                    <div id="potw-nominees-container" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="bg-slate-50 p-3 rounded border border-slate-200"><p class="text-xs font-bold text-slate-400 mb-2">NOMINEE 1</p><select class="input-sport mb-2 text-xs" onchange="loadPOTWTeams(this, 1)"><option value="">Division...</option><option value="Finalist (400Lvl)">Finalist</option><option value="Penultimate (300Lvl)">Penultimate</option><option value="Sophomore (200Lvl)">Sophomore</option><option value="Female League">Female</option></select><select id="potw-team-1" class="input-sport mb-2 text-xs" onchange="loadPOTWPlayers(this, 1)"><option>Team...</option></select><select id="potw-player-1" class="input-sport mb-2 text-xs font-bold text-purple-700"><option>Player...</option></select><textarea id="potw-stats-1" rows="3" class="input-sport text-xs" placeholder="Stats (comma separated)"></textarea></div>
                        <div class="bg-slate-50 p-3 rounded border border-slate-200"><p class="text-xs font-bold text-slate-400 mb-2">NOMINEE 2</p><select class="input-sport mb-2 text-xs" onchange="loadPOTWTeams(this, 2)"><option value="">Division...</option><option value="Finalist (400Lvl)">Finalist</option><option value="Penultimate (300Lvl)">Penultimate</option><option value="Sophomore (200Lvl)">Sophomore</option><option value="Female League">Female</option></select><select id="potw-team-2" class="input-sport mb-2 text-xs" onchange="loadPOTWPlayers(this, 2)"><option>Team...</option></select><select id="potw-player-2" class="input-sport mb-2 text-xs font-bold text-purple-700"><option>Player...</option></select><textarea id="potw-stats-2" rows="3" class="input-sport text-xs" placeholder="Stats (comma separated)"></textarea></div>
                        <div class="bg-slate-50 p-3 rounded border border-slate-200"><p class="text-xs font-bold text-slate-400 mb-2">NOMINEE 3</p><select class="input-sport mb-2 text-xs" onchange="loadPOTWTeams(this, 3)"><option value="">Division...</option><option value="Finalist (400Lvl)">Finalist</option><option value="Penultimate (300Lvl)">Penultimate</option><option value="Sophomore (200Lvl)">Sophomore</option><option value="Female League">Female</option></select><select id="potw-team-3" class="input-sport mb-2 text-xs" onchange="loadPOTWPlayers(this, 3)"><option>Team...</option></select><select id="potw-player-3" class="input-sport mb-2 text-xs font-bold text-purple-700"><option>Player...</option></select><textarea id="potw-stats-3" rows="3" class="input-sport text-xs" placeholder="Stats (comma separated)"></textarea></div>
                    </div>
                    <button onclick="publishPOTW()" class="w-full btn-sport btn-accent">START VOTING</button>
                </div>
            </div>
        </div>

        <div id="partners" class="section hidden">
            <h2 class="text-2xl font-black text-slate-800 mb-6 flex items-center gap-2"><i class="fa-solid fa-handshake text-yellow-500"></i> PARTNERS & SPONSORS</h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="sport-card p-6 border-l-orange h-fit">
                    <h3 class="font-bold text-slate-800 mb-4 border-b pb-2">ADD PARTNER</h3>
                    <div class="space-y-4">
                        <input id="partner-name" placeholder="Sponsor Name" class="input-sport">
                        <input id="partner-link" placeholder="Website/WhatsApp Link" class="input-sport">
                        <div class="relative group cursor-pointer border-2 border-dashed border-slate-300 rounded-lg p-6 text-center hover:bg-slate-50 transition">
                            <input type="file" id="partner-logo" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="image/*">
                            <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-300 mb-2"></i>
                            <p class="text-xs font-bold text-slate-500 uppercase">Upload Logo</p>
                        </div>
                        <button onclick="addPartner()" id="btn-add-partner" class="w-full btn-sport btn-accent">ADD SPONSOR</button>
                    </div>
                </div>
                <div class="lg:col-span-2 sport-card p-6 border-l-blue">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-800">ACTIVE SPONSORS</h3>
                        <button onclick="loadPartners()" class="text-xs font-bold text-blue-600 hover:underline">REFRESH</button>
                    </div>
                    <div id="partners-list" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <p class="text-gray-400 text-sm col-span-full text-center py-8">Loading partners...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="verification" class="section hidden"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-black text-slate-800"><i class="fa-solid fa-check-double text-blue-600"></i> VERIFICATION</h2><button onclick="loadVerifications()" class="bg-slate-800 text-white px-4 py-2 rounded text-xs font-bold uppercase">Refresh</button></div><div class="sport-card overflow-hidden border-l-green"><table class="w-full text-sm text-left"><thead class="bg-slate-50 text-[10px] font-bold text-slate-500 uppercase border-b"><tr><th class="p-4 pl-6">Team</th><th class="p-4 hidden md:table-cell">Div</th><th class="p-4">Acronym</th><th class="p-4">Status</th><th class="p-4 text-right pr-6">Act</th></tr></thead><tbody id="verify-list" class="divide-y divide-slate-100"></tbody></table></div></div>

        <div id="edit-match-modal" class="fixed inset-0 z-[150] flex items-center justify-center bg-slate-900/90 backdrop-blur-sm hidden p-4"><div class="bg-white p-6 rounded-lg w-full max-w-sm shadow-2xl border-l-4 border-blue-600"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-black text-slate-800 font-[Rajdhani]">EDIT FIXTURE</h3><button onclick="closeEditModal()" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button></div><input type="hidden" id="edit-match-id"><div class="bg-slate-100 p-3 rounded mb-4 text-center border border-slate-200"><p class="text-sm font-bold text-slate-800 uppercase font-[Rajdhani]" id="edit-match-teams">...</p></div><div class="space-y-3"><div><label class="text-[10px] font-bold text-slate-400 uppercase">Date</label><input type="date" id="edit-match-date" class="input-sport"></div><div><label class="text-[10px] font-bold text-slate-400 uppercase">Time</label><div class="grid grid-cols-2 gap-2 items-center"><input type="time" id="edit-match-time" class="input-sport"><label class="tbd-label"><input type="checkbox" id="edit-time-tbd" class="tbd-check" onchange="toggleTime(this, 'edit-match-time')"> TBD</label></div></div><div><label class="text-[10px] font-bold text-slate-400 uppercase">Venue</label><div class="grid grid-cols-2 gap-2 items-center"><input type="text" id="edit-match-venue" class="input-sport uppercase"><label class="tbd-label"><input type="checkbox" id="edit-venue-tbd" class="tbd-check" onchange="toggleVenue(this, 'edit-match-venue')"> TBD</label></div></div><button onclick="confirmEditMatch()" class="w-full btn-sport btn-accent mt-2">UPDATE MATCH</button></div></div></div>

        <div id="motm-modal" class="fixed inset-0 z-[160] flex items-center justify-center bg-slate-900/95 backdrop-blur-md hidden p-4"><div class="bg-white w-full max-w-md rounded-xl p-6 border-l-4 border-green-500 shadow-2xl"><div class="flex justify-between items-center mb-4"><h3 class="font-black text-xl text-slate-800">MAN OF THE MATCH</h3><button onclick="document.getElementById('motm-modal').classList.add('hidden')" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times text-xl"></i></button></div><input type="hidden" id="motm-match-id"><div class="mb-4"><p class="text-xs font-bold text-gray-400 uppercase mb-1">Select Player</p><select id="motm-player-select" class="input-sport w-full font-bold text-lg"><option>Loading Squads...</option></select></div><div class="grid grid-cols-2 gap-3 mb-4"><input id="motm-stat-1" placeholder="Stat 1 (e.g. 2 Goals)" class="input-sport"><input id="motm-stat-2" placeholder="Stat 2 (e.g. 1 Assist)" class="input-sport"><input id="motm-stat-3" placeholder="Stat 3 (e.g. 90% Pass)" class="input-sport"></div><button onclick="confirmMOTM()" class="w-full btn-sport btn-accent">SAVE MOTM</button></div></div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, deleteDoc, updateDoc, serverTimestamp, query, orderBy, where, getDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ORIGINAL CREDENTIALS
        const HIDDEN_ADMIN_EMAIL = "admin@eduleague.com"; 
        const firebaseConfig = { apiKey: "AIzaSyDtxFsLYoe0NYlZRWiXgEM90IYKMwx7K8s", authDomain: "sonic-verbena-239117.firebaseapp.com", projectId: "sonic-verbena-239117", storageBucket: "sonic-verbena-239117.appspot.com", messagingSenderId: "652544574249", appId: "1:652544574249:web:6ff33771307e892e7f6d38", measurementId: "G-TD780JGNED" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);
        
        const CLOUD_NAME = "dxdxgrvvb"; const UPLOAD_PRESET = "edu_league"; 
        const mainLogoUrl = "edulogo.jpg";
        let divisionLogos = { 'Finalist': 'edulogo.jpg', 'Penultimate': 'edulogo.jpg', 'Sophomore': 'edulogo.jpg', 'Female': 'edulogo.jpg' };
        let teamAcronymMap = {};
        let allRegTeams = []; // Global Store

        const showNotify = (msg, type="success") => {
            const bar = document.getElementById('notify-bar'); const icon = document.getElementById('notify-icon'); const text = document.getElementById('notify-msg');
            bar.className = type; text.innerText = msg;
            if(type === 'success') { icon.className = "fa-solid fa-check"; bar.style.borderBottomColor = "#10b981"; }
            else if(type === 'error') { icon.className = "fa-solid fa-triangle-exclamation"; bar.style.borderBottomColor = "#ef4444"; }
            else { icon.className = "fa-solid fa-info-circle"; bar.style.borderBottomColor = "#3b82f6"; }
            bar.classList.add('show'); setTimeout(() => bar.classList.remove('show'), 3000);
        };

        // SAFETY OVERRIDE LOGIN
        document.getElementById('login-form').addEventListener('submit', (e) => { 
            e.preventDefault(); const pass = document.getElementById('adm-pass').value;
            // Immediate local check
            if(pass === 'EDUADMIN2025') {
                document.getElementById('login-modal').classList.add('hidden');
                showNotify("ACCESS GRANTED");
                initData();
                signInWithEmailAndPassword(auth, HIDDEN_ADMIN_EMAIL, pass).catch(e => {
                    if(e.code === 'auth/user-not-found') createUserWithEmailAndPassword(auth, HIDDEN_ADMIN_EMAIL, pass);
                });
            } else {
                document.getElementById('login-msg').classList.remove('hidden');
            }
        });
        
        onAuthStateChanged(auth, (u) => { if(u) { document.getElementById('login-modal').classList.add('hidden'); initData(); } });
        window.logout = () => { signOut(auth); location.reload(); };
        window.nav = (id) => { document.querySelectorAll('.section').forEach(s => s.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); const btn = document.getElementById('btn-'+id); if(btn) btn.classList.add('active'); };

        async function initData() {
            try {
                const divLogosSnap = await getDoc(doc(db, "app_content", "division_logos"));
                if(divLogosSnap.exists()) divisionLogos = { ...divisionLogos, ...divLogosSnap.data() };
                const t = await getDocs(collection(db, "registrations"));
                allRegTeams = [];
                t.forEach(doc => { 
                    const d = doc.data(); 
                    allRegTeams.push(d); 
                    if(d.acronym) teamAcronymMap[d.department] = d.acronym; 
                });
                
                document.getElementById('dash-teams').innerText = t.size;
                document.getElementById('dash-verified').innerText = t.docs.filter(d => d.data().registrationStatus === "Verified").length;
                let schedSize = (await getDocs(collection(db, "schedules"))).size; if(schedSize===0) schedSize=(await getDocs(collection(db, "matches"))).size;
                document.getElementById('dash-matches').innerText = schedSize;
                document.getElementById('dash-news').innerText = (await getDocs(collection(db, "news_posts"))).size;
                
                loadTeams(); loadVerifications(); loadSchedule(); loadNews(); loadActivePolls(); loadRosters();
                loadPartners(); // ðŸ”¥ NEW: Load Partners
                
                const ts = document.getElementById('stat-team-select'); ts.innerHTML = '<option value="">Select Team...</option>'; t.forEach(doc => { const d=doc.data(); const o=document.createElement('option'); o.value=doc.id; o.textContent=`${d.department} (${d.level})`; ts.appendChild(o); });
            } catch(e) { console.error(e); }
        }

        // --- NEW: PARTNER MANAGEMENT ---
        window.addPartner = async () => {
            const btn = document.getElementById('btn-add-partner');
            const name = document.getElementById('partner-name').value;
            const link = document.getElementById('partner-link').value;
            const file = document.getElementById('partner-logo').files[0];
            
            if(!name || !file) return showNotify("NAME & LOGO REQUIRED", "error");
            
            btn.innerHTML = "UPLOADING...";
            const formData = new FormData(); 
            formData.append("file", file); 
            formData.append("upload_preset", UPLOAD_PRESET); 
            formData.append("folder", "partners");
            
            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: "POST", body: formData });
                const data = await response.json();
                
                await addDoc(collection(db, "sponsors"), {
                    name: name,
                    link: link || '#',
                    logo: data.secure_url,
                    timestamp: serverTimestamp()
                });
                
                showNotify("PARTNER ADDED");
                document.getElementById('partner-name').value = '';
                document.getElementById('partner-link').value = '';
                loadPartners();
            } catch(e) { console.error(e); showNotify("UPLOAD FAILED", "error"); }
            btn.innerHTML = "ADD SPONSOR";
        };

        window.loadPartners = async () => {
            const list = document.getElementById('partners-list');
            list.innerHTML = '<p class="text-gray-400 text-sm col-span-full text-center">Loading...</p>';
            
            const snap = await getDocs(query(collection(db, "sponsors"), orderBy("timestamp", "desc")));
            list.innerHTML = '';
            
            if(snap.empty) { list.innerHTML = '<p class="text-gray-400 text-sm col-span-full text-center">No active sponsors.</p>'; return; }
            
            snap.forEach(d => {
                const p = d.data();
                list.innerHTML += `
                    <div class="bg-white p-4 rounded-lg shadow border border-gray-100 flex flex-col items-center relative group">
                        <img src="${p.logo}" class="h-16 w-auto object-contain mb-2">
                        <p class="text-xs font-bold text-gray-800 uppercase">${p.name}</p>
                        <button onclick="deletePartner('${d.id}')" class="absolute top-2 right-2 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
            });
        };

        window.deletePartner = async (id) => {
            if(confirm("Remove this partner?")) {
                await deleteDoc(doc(db, "sponsors", id));
                showNotify("PARTNER REMOVED", "info");
                loadPartners();
            }
        };

        // --- CORE FUNCTIONS (UNCHANGED) ---
        window.toggleTime = (checkbox, inputId) => { const input = document.getElementById(inputId); if(checkbox.checked) { input.value = ''; input.disabled = true; } else { input.disabled = false; } };
        window.toggleVenue = (checkbox, inputId) => { const input = document.getElementById(inputId); if(checkbox.checked) { input.value = ''; input.disabled = true; } else { input.disabled = false; } };
        const formatTime = (time) => { if(!time || time === 'TBD') return 'TBD'; const [h, m] = time.split(':'); const hour = parseInt(h); const ampm = hour >= 12 ? 'PM' : 'AM'; const h12 = hour % 12 || 12; return `${h12}:${m} ${ampm}`; };
        const getShortName = (name) => teamAcronymMap[name] || name;

        // --- ROSTER PDF ---
        window.loadRosters = async () => {
            const body = document.getElementById('roster-table-body'); body.innerHTML = '';
            try {
                const snap = await getDocs(collection(db, "registrations"));
                snap.forEach(doc => {
                    const d = doc.data(); const players = d.players || [];
                    body.innerHTML += `<tr class="border-b hover:bg-slate-50"><td class="p-4 font-bold text-gray-700">${d.department}</td><td class="p-4 text-xs font-bold text-gray-500">${d.level}</td><td class="p-4"><span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold">${players.length}/18</span></td><td class="p-4 text-right"><button onclick="downloadRosterPDF('${doc.id}')" class="bg-purple-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-purple-700"><i class="fa-solid fa-download mr-1"></i> PDF</button></td></tr>`;
                });
            } catch(e) { console.error(e); }
        };

        window.downloadRosterPDF = async (teamId) => {
            try {
                showNotify("GENERATING PDF...", "info");
                const docSnap = await getDoc(doc(db, "registrations", teamId));
                if(!docSnap.exists()) return;
                const d = docSnap.data();
                const { jsPDF } = window.jspdf; const pdf = new jsPDF();
                const mImg = await getBase64Image(mainLogoUrl); if(mImg) pdf.addImage(mImg, 'JPEG', 15, 10, 20, 20);
                pdf.setFontSize(18); pdf.setTextColor(30, 41, 59); pdf.text("OFFICIAL TEAM ROSTER", 105, 20, { align: 'center' });
                pdf.setFontSize(14); pdf.setTextColor(37, 99, 235); pdf.text(d.department.toUpperCase(), 105, 30, { align: 'center' });
                pdf.setFontSize(10); pdf.setTextColor(100); pdf.text(`Division: ${d.level}  |  Coach: ${d.coachName || 'N/A'}`, 105, 38, { align: 'center' });
                const rows = (d.players || []).map((p, i) => [i+1, p.name, p.number, p.position]);
                pdf.autoTable({ head: [['S/N', 'Player Name', 'Jersey #', 'Pos']], body: rows, startY: 45, theme: 'grid', headStyles: { fillColor: [37, 99, 235] } });
                pdf.save(`${d.department}_Roster.pdf`); showNotify("DOWNLOAD STARTED");
            } catch(e) { console.error(e); alert("PDF Error"); }
        };

        // --- POTW ---
        window.loadPOTWTeams = (select, idx) => {
            const div = select.value;
            const teamSelect = document.getElementById(`potw-team-${idx}`);
            teamSelect.innerHTML = '<option>Select Team...</option>';
            if(!div) return;
            allRegTeams.filter(t => t.level === div || (div === "Female League" && t.division === "Female")).forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.department; opt.text = t.department;
                teamSelect.appendChild(opt);
            });
        };
        window.loadPOTWPlayers = async (select, idx) => {
            const teamName = select.value;
            const playerSelect = document.getElementById(`potw-player-${idx}`);
            playerSelect.innerHTML = '<option>Loading...</option>';
            if(!teamName) return;
            const teamDoc = allRegTeams.find(t => t.department === teamName);
            if(teamDoc && teamDoc.players) {
                playerSelect.innerHTML = '<option>Select Player...</option>';
                teamDoc.players.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.name; opt.text = `${p.name} (${p.position})`;
                    playerSelect.appendChild(opt);
                });
            } else { playerSelect.innerHTML = '<option>No players found</option>'; }
        };
        window.publishPOTW = async () => {
            const nominees = [];
            for(let i=1; i<=3; i++) {
                const div = document.querySelector(`#potw-nominees-container > div:nth-child(${i}) select:nth-child(2)`).value;
                const team = document.getElementById(`potw-team-${i}`).value;
                const player = document.getElementById(`potw-player-${i}`).value;
                const stats = document.getElementById(`potw-stats-${i}`).value;
                if(player && player !== "Player...") nominees.push({div, team, name: player, stats: stats.split(',').map(s=>s.trim())});
            }
            if(nominees.length < 3) return showNotify("SELECT 3 PLAYERS", "error");
            const matchday = document.getElementById('potw-matchday').value;
            await setDoc(doc(db, "app_content", "potw_current"), { matchday: matchday, active: true, nominees: nominees, votes: { [nominees[0].name]: 0, [nominees[1].name]: 0, [nominees[2].name]: 0 } });
            showNotify("POTW VOTING STARTED");
        };
        window.togglePOTWVoting = async (active) => {
            const potwRef = doc(db, "app_content", "potw_current");
            if (!active) {
                const snap = await getDoc(potwRef);
                if (snap.exists() && snap.data().active) {
                    const d = snap.data();
                    let winner="No Votes", max=-1, wTeam="", wStats="";
                    d.nominees.forEach(n => {
                        const count = d.votes ? (d.votes[n.name]||0) : 0;
                        if(count > max) { max = count; winner = n.name; wTeam = n.team; wStats = n.stats.join(', '); }
                    });
                    if (max > -1) {
                        await addDoc(collection(db, "potw_history"), {
                            matchday: d.matchday, winner, team: wTeam, stats: wStats, votes: max, timestamp: serverTimestamp()
                        });
                    }
                }
            }
            await updateDoc(potwRef, { active: active });
            showNotify(active ? "VOTING OPEN" : "VOTING CLOSED & SAVED", active ? "success" : "info");
        };

        // --- MOTM ---
        window.openMOTMModal = (matchId, home, away) => {
            document.getElementById('motm-match-id').value = matchId;
            const select = document.getElementById('motm-player-select');
            select.innerHTML = '<option>Loading...</option>';
            document.getElementById('motm-modal').classList.remove('hidden');
            const teamH = allRegTeams.find(t => t.department === home || t.acronym === home);
            const teamA = allRegTeams.find(t => t.department === away || t.acronym === away);
            select.innerHTML = '<option value="">Select MOTM...</option>';
            if(teamH) { const grp = document.createElement('optgroup'); grp.label = home; (teamH.players||[]).forEach(p => { const o=document.createElement('option'); o.value=`${p.name}|${home}`; o.text=p.name; grp.appendChild(o); }); select.appendChild(grp); }
            if(teamA) { const grp = document.createElement('optgroup'); grp.label = away; (teamA.players||[]).forEach(p => { const o=document.createElement('option'); o.value=`${p.name}|${away}`; o.text=p.name; grp.appendChild(o); }); select.appendChild(grp); }
        };
        window.confirmMOTM = async () => {
            const matchId = document.getElementById('motm-match-id').value;
            const val = document.getElementById('motm-player-select').value;
            if(!val) return showNotify("SELECT PLAYER", "error");
            const [player, team] = val.split('|');
            const stats = [document.getElementById('motm-stat-1').value, document.getElementById('motm-stat-2').value, document.getElementById('motm-stat-3').value].filter(s => s);
            if(stats.length === 0) return showNotify("ENTER AT LEAST 1 STAT", "error");
            await updateDoc(doc(db, "schedules", matchId), { motm: { player, team, stats } });
            document.getElementById('motm-modal').classList.add('hidden');
            showNotify("MOTM SAVED");
            loadResults();
        };

        // --- STANDARD FUNCTIONS (UNCHANGED) ---
        window.loadTeams = async () => {
            const listEl = document.getElementById('badge-tracker-list'); listEl.innerHTML = '<div class="loader mx-auto border-blue-500"></div>';
            const teamsSnap = await getDocs(collection(db, "registrations"));
            const uploadedMap = new Set(); (await getDocs(collection(db, "team_assets"))).forEach(d => { if(d.data().logoUrl) uploadedMap.add(d.id); });
            const grouped = {}; teamsSnap.forEach(d => { const t = d.data(); if(!grouped[t.level]) grouped[t.level] = []; grouped[t.level].push(t); });
            listEl.innerHTML = '';
            Object.keys(grouped).sort().forEach(div => {
                const header = document.createElement('div'); header.className = "text-xs font-black text-slate-400 uppercase tracking-widest mt-6 mb-2 ml-1"; header.innerText = div; listEl.appendChild(header);
                grouped[div].forEach(t => {
                    const uniqueId = `${t.department}_${t.level.replace(/[^a-zA-Z0-9]/g, '')}`; const hasBadge = uploadedMap.has(uniqueId);
                    const item = document.createElement('div'); item.className = "badge-item"; if(hasBadge) item.classList.add("active");
                    item.onclick = () => selectTeamForUpload(t.department, t.level, item);
                    item.innerHTML = `<span class="text-sm font-bold text-slate-700 truncate font-[Rajdhani] uppercase tracking-wide">${t.department}</span>${hasBadge ? '<i class="fa-solid fa-circle-check text-blue-600 text-lg"></i>' : '<i class="fa-solid fa-circle text-slate-200 text-lg"></i>'}`; listEl.appendChild(item);
                });
            });
        };
        window.selectTeamForUpload = (name, div, el) => { document.querySelectorAll('.badge-item').forEach(b => b.classList.remove('active')); el.classList.add('active'); document.getElementById('logo-team-name-display').value = `${name} (${div})`; document.getElementById('logo-team-name').value = name; document.getElementById('logo-team-div').value = div; previewTeamLogo(name, div); };
        window.previewTeamLogo = async (name, div) => { const uniqueId = `${name}_${div.replace(/[^a-zA-Z0-9]/g, '')}`; try { const d = await getDoc(doc(db,"team_assets",uniqueId)); if(d.exists() && d.data().logoUrl) { document.getElementById('logo-preview').src = d.data().logoUrl; document.getElementById('preview-badge').classList.remove('hidden'); } else { document.getElementById('logo-preview').src = "edulogo.jpg"; document.getElementById('preview-badge').classList.add('hidden'); } } catch(e){ preview.src = "edulogo.jpg"; } };
        window.uploadBadgeDirect = async () => {
            const name = document.getElementById('logo-team-name').value, div = document.getElementById('logo-team-div').value, file = document.getElementById('logo-file').files[0]; const btn = document.getElementById('btn-save-badge');
            if(!name || !file) return showNotify("SELECT TEAM & FILE", "error");
            btn.innerHTML = 'UPLOADING...';
            const formData = new FormData(); formData.append("file", file); formData.append("upload_preset", UPLOAD_PRESET); formData.append("folder", "team_badges");
            try { const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: "POST", body: formData }); const data = await response.json(); if(data.error) throw new Error(data.error.message); const uniqueId = `${name}_${div.replace(/[^a-zA-Z0-9]/g, '')}`; await setDoc(doc(db,"team_assets",uniqueId), { logoUrl: data.secure_url }, { merge: true }); showNotify("BADGE SAVED", "success"); loadTeams(); btn.innerHTML = 'UPLOAD & SAVE'; } catch(err) { console.error(err); showNotify("UPLOAD FAILED", "error"); btn.innerHTML = 'RETRY'; }
        };
        window.publishNews = async () => {
            const btn = document.getElementById('btn-pub-news'); btn.innerHTML = 'PUBLISHING...'; const file = document.getElementById('news-file').files[0]; let finalUrl = "";
            if(file) { const formData = new FormData(); formData.append("file", file); formData.append("upload_preset", UPLOAD_PRESET); formData.append("folder", "news"); try { const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`, { method: "POST", body: formData }); const data = await response.json(); if(data.error) throw new Error(data.error.message); finalUrl = data.secure_url; } catch(e) { showNotify("MEDIA UPLOAD FAILED", "error"); btn.innerHTML = 'PUBLISH'; return; } }
            await addDoc(collection(db,"news_posts"), { title: document.getElementById('news-title').value, content: document.getElementById('news-body').value, imageUrl: finalUrl, timestamp: serverTimestamp(), likes: 0, commentsCount: 0 }); showNotify("PUBLISHED", "success"); loadNews(); btn.innerHTML = 'PUBLISH';
        };
        window.changeDivLogoDirect = async (input) => { if(!curDivCode) return showNotify("SELECT DIVISION FIRST", "error"); const file = input.files[0]; if(!file) return; showNotify("UPDATING LOGO...", "info"); const formData = new FormData(); formData.append("file", file); formData.append("upload_preset", UPLOAD_PRESET); formData.append("folder", "division_logos"); try { const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: "POST", body: formData }); const data = await response.json(); const url = data.secure_url; divisionLogos[curDivCode] = url; document.getElementById('div-logo-display').src = url; await setDoc(doc(db,"app_content","division_logos"), { [curDivCode]: url }, { merge: true }); showNotify("DIVISION LOGO UPDATED", "success"); } catch(e) { showNotify("UPLOAD FAILED", "error"); } };
        window.loadNews=async()=>{const e=document.getElementById('news-feed');e.innerHTML='';(await getDocs(query(collection(db,"news_posts"),orderBy("timestamp","desc")))).forEach(d=>{e.innerHTML+=`<div class="sport-card p-3 mb-2 flex justify-between items-center"><span class="text-xs font-bold text-slate-700 truncate w-32 uppercase font-[Rajdhani]">${d.data().title}</span><button onclick="deleteDoc(doc(db,'news_posts','${d.id}'));loadNews()" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button></div>`;});};
        async function getTeamLogo(name, div) { if(!div) return mainLogoUrl; const uniqueId = `${name}_${div.replace(/[^a-zA-Z0-9]/g, '')}`; try { let s = await getDoc(doc(db,"team_assets",uniqueId)); if(s.exists()&&s.data().logoUrl) return s.data().logoUrl; s = await getDoc(doc(db,"team_assets",name)); if(s.exists()&&s.data().logoUrl) return s.data().logoUrl; } catch(e){} return mainLogoUrl; }
        let allSchedules=[];
        window.loadSchedule = async () => { if(allRegTeams.length===0) (await getDocs(collection(db,"registrations"))).forEach(d=>allRegTeams.push(d.data())); const el=document.getElementById('active-fixtures'); el.innerHTML='Loading...'; let snap=await getDocs(collection(db,"schedules")); if(snap.empty) snap=await getDocs(collection(db,"matches")); allSchedules=snap.docs.map(d=>({id:d.id,...d.data()})); loadSpotlightCandidates(); renderMatches(); };
        function renderMatches() { const el=document.getElementById('active-fixtures'); el.innerHTML=''; const fDiv=document.getElementById('view-div').value, fDay=document.getElementById('view-day').value; let filtered=allSchedules; if(fDiv!=='All') filtered=filtered.filter(m=>m.div===fDiv); if(fDay!=='All') filtered=filtered.filter(m=>m.day===fDay); if(filtered.length===0) { el.innerHTML='<p class="text-center text-slate-400 text-sm">NO MATCHES FOUND</p>'; return; } filtered.forEach(m=>{ const home=getShortName(m.home||m.homeTeam||"Unknown"); const away=getShortName(m.away||m.awayTeam||"Unknown"); const isTBD=m.time==='TBD'||!m.time; const venue = m.venue || 'TBD'; el.innerHTML+=`<div class="sport-card p-4 flex justify-between items-center mb-3"><div><div class="flex items-center gap-2 mb-1"><span class="text-[9px] font-black bg-blue-600 text-white px-2 py-0.5 rounded uppercase">${(m.div||'').split(' ')[0]}</span><span class="text-[9px] font-bold text-slate-400 uppercase">${m.day||''}</span></div><div class="font-black text-slate-800 text-sm uppercase font-[Rajdhani] tracking-wide">${home} <span class="text-slate-400 font-normal mx-1">vs</span> ${away}</div><div class="text-[10px] font-bold text-slate-500 mt-1">${isTBD&&!m.date?'PENDING':m.date} â€¢ ${isTBD?'TBD':m.time} â€¢ ${venue}</div></div><div class="flex gap-2"><button onclick="openEditMatch('${m.id}','${m.home}','${m.away}','${m.date}','${m.time}','${venue}')" class="text-blue-500 p-2 hover:bg-blue-50 rounded"><i class="fa-solid fa-pen"></i></button><button onclick="deleteMatch('${m.id}')" class="text-slate-400 hover:text-red-500 p-2 hover:bg-red-50 rounded"><i class="fa-solid fa-trash"></i></button></div></div>`; }); }
        window.openEditMatch = (id,h,a,date,time,venue) => { document.getElementById('edit-match-id').value=id; document.getElementById('edit-match-teams').innerText=`${getShortName(h)} vs ${getShortName(a)}`; document.getElementById('edit-match-date').value = date; const timeInp = document.getElementById('edit-match-time'); const timeCheck = document.getElementById('edit-time-tbd'); if(time === 'TBD') { timeInp.value=''; timeInp.disabled=true; timeCheck.checked=true; } else { timeInp.value=time; timeInp.disabled=false; timeCheck.checked=false; } const venInp = document.getElementById('edit-match-venue'); const venCheck = document.getElementById('edit-venue-tbd'); if(venue === 'TBD') { venInp.value=''; venInp.disabled=true; venCheck.checked=true; } else { venInp.value=venue; venInp.disabled=false; venCheck.checked=false; } document.getElementById('edit-match-modal').classList.remove('hidden'); };
        window.closeEditModal = () => document.getElementById('edit-match-modal').classList.add('hidden');
        window.confirmEditMatch = async () => { const id=document.getElementById('edit-match-id').value; const d=document.getElementById('edit-match-date').value; const timeTBD = document.getElementById('edit-time-tbd').checked; const timeVal = document.getElementById('edit-match-time').value; const t = timeTBD ? "TBD" : (timeVal ? formatTime(timeVal) : "TBD"); const venueTBD = document.getElementById('edit-venue-tbd').checked; const venueVal = document.getElementById('edit-match-venue').value; const v = venueTBD ? "TBD" : (venueVal || "TBD"); if(!d) return showNotify("DATE REQUIRED", "error"); await updateDoc(doc(db,"schedules",id),{date:d,time:t,venue:v}); closeEditModal(); loadSchedule(); showNotify("UPDATED", "success"); };
        window.saveFixture = async () => { const div = document.getElementById('fix-div').value; const day = document.getElementById('fix-day').value; const date = document.getElementById('fix-date').value; const home = document.getElementById('fix-home').value; const away = document.getElementById('fix-away').value; const timeTBD = document.getElementById('fix-time-tbd').checked; const timeVal = document.getElementById('fix-time').value; const time = timeTBD ? "TBD" : (timeVal ? formatTime(timeVal) : "TBD"); const venueTBD = document.getElementById('fix-venue-tbd').checked; const venueVal = document.getElementById('fix-venue').value; const venue = venueTBD ? "TBD" : (venueVal || "TBD"); if(!home || !date) return showNotify("FILL ALL FIELDS", "error"); const f = {div, day, date, time, venue, home, away, timestamp: serverTimestamp()}; await addDoc(collection(db,"schedules"), f); showNotify("FIXTURE ADDED", "success"); loadSchedule(); };
        window.deleteMatch = async(id) => { if(confirm("DELETE FIXTURE?")) { await deleteDoc(doc(db,"schedules",id)); showNotify("DELETED", "info"); loadSchedule(); }};
        window.filterTeamsByDiv = () => { const div=document.getElementById('fix-div').value, h=document.getElementById('fix-home'), a=document.getElementById('fix-away'); h.innerHTML='<option>HOME</option>'; a.innerHTML='<option>AWAY</option>'; allRegTeams.filter(t=>t.level===div || (div==="Female League"&&t.division==="Female")).forEach(t=>{ const o=`<option value="${t.department}">${t.department}</option>`; h.innerHTML+=o; a.innerHTML+=o; }); };
        window.loadResults = async () => { if(allSchedules.length===0) await loadSchedule(); const list = document.getElementById('results-list'); list.innerHTML = ''; const fDiv = document.getElementById('res-div').value, fDay = document.getElementById('res-day').value; let matches = allSchedules; if(fDiv!=='All') matches = matches.filter(m=>m.div===fDiv); if(fDay!=='All') matches = matches.filter(m=>m.day===fDay); if(matches.length === 0) { list.innerHTML = '<p class="text-center text-gray-400">No matches found.</p>'; return; } matches.forEach(m => { const hScore = m.homeScore !== undefined ? m.homeScore : ''; const aScore = m.awayScore !== undefined ? m.awayScore : ''; const home = getShortName(m.home||m.homeTeam); const away = getShortName(m.away||m.awayTeam); list.innerHTML += `<div class="sport-card p-4 flex items-center justify-between gap-4"><div class="w-1/3 text-right font-black text-sm uppercase truncate">${home}</div><div class="flex items-center gap-2"><input type="number" id="hs-${m.id}" value="${hScore}" class="w-12 p-2 text-center border rounded font-bold bg-slate-50 outline-none focus:border-blue-500" placeholder="-"><span class="font-black text-slate-300">:</span><input type="number" id="as-${m.id}" value="${aScore}" class="w-12 p-2 text-center border rounded font-bold bg-slate-50 outline-none focus:border-blue-500" placeholder="-"></div><div class="w-1/3 font-black text-sm uppercase truncate">${away}</div><div class="flex gap-1"><button onclick="saveScore('${m.id}')" class="bg-green-600 text-white p-2 rounded hover:bg-green-700 transition"><i class="fa-solid fa-floppy-disk"></i></button><button onclick="openMOTMModal('${m.id}', '${m.home||m.homeTeam}', '${m.away||m.awayTeam}')" class="bg-yellow-500 text-white p-2 rounded hover:bg-yellow-600 transition ${m.motm?'opacity-50':''}"><i class="fa-solid fa-star"></i></button></div></div>`; }); };
        window.saveScore = async (id) => { const h = document.getElementById(`hs-${id}`).value; const a = document.getElementById(`as-${id}`).value; if(h==='' || a==='') return showNotify("ENTER SCORES", "error"); await updateDoc(doc(db, "schedules", id), { homeScore: parseInt(h), awayScore: parseInt(a), status: 'FT' }); showNotify("SCORE UPDATED", "success"); };
        let currentSpotlights=[]; window.loadSpotlightCandidates=()=>{ const div=document.getElementById('spot-div').value, day=document.getElementById('spot-day').value; const el=document.getElementById('spot-candidates'); if(!div||!day)return; const matches=allSchedules.filter(m=>m.div===div&&m.day===day); el.innerHTML=''; matches.forEach(m=>{ const home=getShortName(m.home||m.homeTeam); const away=getShortName(m.away||m.awayTeam); const btn=document.createElement('button'); btn.className="w-full text-left p-3 bg-white border border-slate-200 rounded text-xs font-bold text-slate-700 hover:bg-blue-50 mb-2 font-[Rajdhani] uppercase"; btn.innerHTML=`<span>${home} vs ${away}</span>`; btn.onclick=()=>addToSpotlight({home,away,...m}); el.appendChild(btn); }); };
        function addToSpotlight(m) { if(currentSpotlights.length>=4) return showNotify("MAX 4 SPOTLIGHTS", "error"); currentSpotlights.push(m); renderSpotlightUI(); }
        function renderSpotlightUI() { const el=document.getElementById('active-spotlights'); el.innerHTML=''; currentSpotlights.forEach((m,i)=>{ el.innerHTML+=`<div class="p-3 bg-blue-50 border border-blue-200 rounded flex justify-between items-center"><div class="text-xs font-bold text-blue-900 font-[Rajdhani] uppercase">${m.home} vs ${m.away}<br><span class="text-[9px] text-blue-400 font-sans">${m.day}</span></div><button onclick="removeSpot(${i})" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-times"></i></button></div>`; }); }
        window.removeSpot=(i)=>{ currentSpotlights.splice(i,1); renderSpotlightUI(); }; window.clearSpotlights=()=>{ currentSpotlights=[]; renderSpotlightUI(); };
        window.publishSpotlights=async()=>{ if(currentSpotlights.length===0) return showNotify("SELECT MATCHES", "error"); const spotlightData=await Promise.all(currentSpotlights.map(async (m)=>{ let l1=await getTeamLogo(m.home, m.div), l2=await getTeamLogo(m.away, m.div); return { teamA:m.home, teamB:m.away, teamALogo:l1, teamBLogo:l2, date:m.date||'TBD', time:m.time||'TBD', venue: m.venue||'TBD', category:'SPOTLIGHT' }; })); await setDoc(doc(db,"app_content","current_fixture"),{matches:spotlightData}); showNotify("SPOTLIGHT LIVE"); };
        
        let curDivCode=''; 
        window.loadTableData=async(regLevel,shortCode)=>{ 
            curDivCode=shortCode; // Keep original for logos
            document.getElementById('table-logos').classList.remove('hidden'); 
            document.getElementById('div-logo-display').src=divisionLogos[shortCode]||mainLogoUrl; 
            const container=document.getElementById('table-container'); container.innerHTML='<span class="loader border-blue-600"></span>'; 
            
            // ðŸ”¥ FIX: Use lowercase for table doc path
            const existing=(await getDoc(doc(db,"app_content",`league_table_${shortCode.toLowerCase()}`))).data()||{}; 
            const regSnap=await getDocs(query(collection(db,"registrations"),where("level","==",regLevel))); 
            
            container.innerHTML=`<div class="grid grid-cols-12 gap-1 text-[10px] font-black text-slate-400 uppercase mb-2 px-1 tracking-wider"><div class="col-span-3">Team</div><div class="col-span-1 text-center">PL</div><div class="col-span-1 text-center">W</div><div class="col-span-1 text-center">D</div><div class="col-span-1 text-center">L</div><div class="col-span-1 text-center">GD</div><div class="col-span-2 text-center text-blue-600">PTS</div></div>`; const map={}; Object.keys(existing).forEach(k=>map[k]=existing[k]); regSnap.forEach(d=>{ const n=d.data().department; if(!map[n]) map[n]={mp:0,w:0,d:0,l:0,gd:0,pts:0}; }); const names=Object.keys(map); const logos=await Promise.all(names.map(n=>getTeamLogo(n,regLevel))); names.map((n,i)=>({name:n,logo:logos[i],...map[n]})).sort((a,b)=>b.pts-a.pts||b.gd-a.gd).forEach(t=>{ container.innerHTML+=`<div class="grid grid-cols-12 gap-1 items-center mb-2 team-row bg-white p-2 rounded border border-slate-100 shadow-sm" data-name="${t.name}"><div class="col-span-3 flex items-center gap-1.5"><img src="${t.logo}" class="h-6 w-6 rounded-full object-cover border"><span class="font-bold text-xs truncate text-slate-800 font-[Rajdhani] uppercase">${getShortName(t.name)}</span></div><input type="number" class="col-span-1 tbl-input inp-mp" value="${t.mp||0}"><input type="number" class="col-span-1 tbl-input inp-w text-green-600" value="${t.w||0}"><input type="number" class="col-span-1 tbl-input inp-d" value="${t.d||0}"><input type="number" class="col-span-1 tbl-input inp-l text-red-500" value="${t.l||0}"><input type="number" class="col-span-1 tbl-input inp-gd" value="${t.gd||0}"><input type="number" class="col-span-2 tbl-input inp-pts bg-blue-50 text-blue-700 rounded font-black" value="${t.pts||0}"></div>`; }); document.getElementById('save-table-btn').classList.remove('hidden'); 
        };
        
        window.saveTableUpdates=async()=>{ 
            const rows=document.querySelectorAll('.team-row'); let d={}; 
            rows.forEach(r=>d[r.dataset.name]={mp:parseInt(r.querySelector('.inp-mp').value)||0, w:parseInt(r.querySelector('.inp-w').value)||0, d:parseInt(r.querySelector('.inp-d').value)||0, l:parseInt(r.querySelector('.inp-l').value)||0, gd:parseInt(r.querySelector('.inp-gd').value)||0, pts:parseInt(r.querySelector('.inp-pts').value)||0}); 
            
            // ðŸ”¥ FIX: Write to lowercase doc path
            await setDoc(doc(db,"app_content",`league_table_${curDivCode.toLowerCase()}`),d); 
            showNotify("STANDINGS SAVED"); 
        };
        
        window.downloadTablePDF=async()=>{try{const{jsPDF}=window.jspdf;const pdf=new jsPDF();const mImg=await getBase64Image(mainLogoUrl);const dImg=await getBase64Image(divisionLogos[curDivCode]||mainLogoUrl);if(mImg)pdf.addImage(mImg,'JPEG',15,10,15,15);if(dImg)pdf.addImage(dImg,'JPEG',180,10,15,15);pdf.setFontSize(16);pdf.setTextColor(37,99,235);pdf.text(`${curDivCode.toUpperCase()} TABLE`,105,20,{align:'center'});const rows=[];document.querySelectorAll('.team-row').forEach((r,i)=>rows.push([i+1,r.dataset.name,r.querySelector('.inp-mp').value,r.querySelector('.inp-w').value,r.querySelector('.inp-d').value,r.querySelector('.inp-l').value,r.querySelector('.inp-gd').value,r.querySelector('.inp-pts').value]));pdf.autoTable({head:[['#','Team','P','W','D','L','GD','Pts']],body:rows,startY:35,theme:'grid',headStyles:{fillColor:[37,99,235]}});pdf.save("Table.pdf");}catch(e){console.error(e);showNotify("PDF Error","error");}};
        window.downloadSchedulePDF=async()=>{try{const{jsPDF}=window.jspdf;const pdf=new jsPDF();const divFilter=document.getElementById('view-div').value;const dayFilter=document.getElementById('view-day').value;let title="EDU-LEAGUE 2025/26";if(divFilter!=="All")title+=` ${divFilter.split(' ')[0].toUpperCase()}`;if(dayFilter!=="All")title+=` ${dayFilter.toUpperCase()}`;title+=" FIXTURES";const mImg=await getBase64Image(mainLogoUrl);if(mImg)pdf.addImage(mImg,'JPEG',15,10,20,20);let divCode="";if(divFilter.includes("Finalist"))divCode="Finalist";else if(divFilter.includes("Penultimate"))divCode="Penultimate";else if(divFilter.includes("Sophomore"))divCode="Sophomore";else if(divFilter.includes("Female"))divCode="Female";if(divCode){const dImg=await getBase64Image(divisionLogos[divCode]||mainLogoUrl);if(dImg)pdf.addImage(dImg,'JPEG',175,10,20,20);}pdf.setFontSize(14);pdf.setTextColor(37,99,235);pdf.text(title,105,20,{align:'center'});const rows=[];allSchedules.forEach(m=>{if(divFilter!=='All'&&m.div!==divFilter)return;if(dayFilter!=='All'&&m.day!==dayFilter)return;rows.push([m.date||'TBD',m.time||'TBD',m.div?m.div.split(' ')[0]:'',`${getShortName(m.home)} vs ${getShortName(m.away)}`,m.venue||'TBD']);});pdf.autoTable({head:[['Date','Time','Div','Match','Venue']],body:rows,startY:35,theme:'grid',headStyles:{fillColor:[37,99,235]}});pdf.save(`${title.replace(/ /g,'_')}.pdf`);}catch(e){console.error(e);showNotify("PDF Error","error");}};
        window.loadTeamPlayers=async()=>{const t=document.getElementById('stat-team-select').value;const p=document.getElementById('stat-player-select');p.innerHTML='<option>Loading...</option>';if(!t)return;const d=await getDoc(doc(db,"registrations",t));p.innerHTML='<option value="">Select Player...</option>';(d.data().players||[]).forEach(o=>{const e=document.createElement('option');e.value=o.name;e.textContent=`${o.name} (${o.position})`;p.appendChild(e);});};
        window.fetchPlayerCurrentStats=async()=>{const t=document.getElementById('stat-team-select').value,p=document.getElementById('stat-player-select').value;if(!t||!p)return;document.getElementById('stats-editor').classList.remove('hidden');const s=await getDoc(doc(db,"player_stats",`${t}_${p.replace(/\s+/g,'')}`));const d=s.exists()?s.data():{};document.getElementById('p-goals').value=d.goals||0;document.getElementById('p-assists').value=d.assists||0;document.getElementById('p-yellow').value=d.yellow_cards||0;document.getElementById('p-red').value=d.red_cards||0;document.getElementById('p-saves').value=d.saves||0;};
        window.savePlayerStats=async()=>{const t=document.getElementById('stat-team-select').value,p=document.getElementById('stat-player-select').value;if(!t||!p)return;await setDoc(doc(db,"player_stats",`${t}_${p.replace(/\s+/g,'')}`),{name:p,teamId:t,goals:parseInt(document.getElementById('p-goals').value)||0,assists:parseInt(document.getElementById('p-assists').value)||0,yellow_cards:parseInt(document.getElementById('p-yellow').value)||0,red_cards:parseInt(document.getElementById('p-red').value)||0,saves:parseInt(document.getElementById('p-saves').value)||0},{merge:true});showNotify("STATS SAVED");};
        window.createPoll=async()=>{const q=document.getElementById('poll-q').value;if(!q)return;await addDoc(collection(db,"polls"),{question:q,opt1:document.getElementById('poll-o1').value,opt2:document.getElementById('poll-o2').value,votes1:0,votes2:0,active:true,timestamp:serverTimestamp()});showNotify("POLL LIVE");loadActivePolls();};
        window.deletePoll=async(id)=>{if(confirm("Delete this poll?")){await deleteDoc(doc(db,"polls",id));loadActivePolls();showNotify("POLL DELETED","info");}};
        window.loadActivePolls=async()=>{const e=document.getElementById('active-polls');e.innerHTML='';(await getDocs(query(collection(db,"polls"),orderBy("timestamp","desc")))).forEach(d=>{const p=d.data();e.innerHTML+=`<div class="sport-card p-4 mb-2"><h4 class="font-bold text-sm text-slate-800 uppercase font-[Rajdhani]">${p.question}</h4><div class="flex gap-2 justify-end mt-2"><button onclick="deletePoll('${d.id}')" class="text-xs bg-slate-100 px-3 py-1 rounded font-bold uppercase text-slate-500 hover:text-red-500">Delete</button></div></div>`;});};
        window.loadVerifications=async()=>{const l=document.getElementById('verify-list');l.innerHTML='';(await getDocs(collection(db,"registrations"))).forEach(d=>{l.innerHTML+=`<tr class="border-b border-slate-50 hover:bg-slate-50"><td class="p-4 font-bold text-slate-800 font-[Rajdhani] uppercase tracking-wide">${d.data().department}</td><td class="p-4 text-xs font-bold text-slate-400">${d.data().level}</td><td class="p-4"><input class="input-sport p-1 text-xs" value="${d.data().acronym||''}" placeholder="Acronym" onchange="updateAcronym('${d.id}', this.value)"></td><td class="p-4"><span class="bg-slate-100 text-slate-500 px-2 py-1 rounded text-[10px] font-bold uppercase">${d.data().registrationStatus||'PENDING'}</span></td><td class="p-4 text-right"><button onclick="verifyTeam('${d.id}')" class="text-green-500 hover:bg-green-50 p-2 rounded"><i class="fa-solid fa-check"></i></button></td></tr>`;});};
        window.updateAcronym=async(id, val)=>{await updateDoc(doc(db,"registrations",id),{acronym:val});showNotify("ACRONYM SAVED");};
        window.verifyTeam=async(id)=>{if(confirm("CONFIRM VERIFICATION?")){await updateDoc(doc(db,"registrations",id),{registrationStatus:"Verified"});showNotify("VERIFIED");loadVerifications();}};
        window.setMOTM=async(a)=>{const n=[document.getElementById('motm-1').value,document.getElementById('motm-2').value,document.getElementById('motm-3').value];await setDoc(doc(db,"app_content","fan_zone"),{motm:{active:a,nominees:n,votes:[0,0,0]}},{merge:true});showNotify(a?"VOTING OPEN":"VOTING CLOSED", "info");};
        async function getBase64Image(u){try{if(!u)return null;if(u.startsWith('data:'))return u;return new Promise((r,j)=>{var i=new Image();i.crossOrigin="anonymous";i.onload=function(){var c=document.createElement("canvas");c.width=this.width;c.height=this.height;var x=c.getContext("2d");x.drawImage(this,0,0);r(c.toDataURL("image/jpeg"));};i.onerror=function(){r(null);};i.src=u;});}catch(e){return null;}}
    </script>
</body>
</html>