<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Roster - EDU-LEAGUE</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Social Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- ** NEW: Web Icon (Favicon) ** -->
    <link rel="icon" href="edulogo.jpg" type="image/jpeg">
    <link rel="apple-touch-icon" href="edulogo.jpg">

    <style>
        /* Custom Font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fd;
        }
        .bg-edu-purple { background-color: #6d28d9; }
        .text-edu-purple { color: #6d28d9; }
        .border-edu-purple { border-color: #6d28d9; }
        .ring-edu-purple:focus { ring-color: #6d28d9; }
        .bg-edu-yellow { background-color: #fbbf24; }
        .hover-edu-yellow:hover { background-color: #f59e0b; }
        
        .modal-content { transition: all 0.3s ease-in-out; }

        /* Added styles for player list */
        .player-entry {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* News Ticker Footer */
        .news-ticker {
            width: 100%;
            background-color: #1f2937;
            color: white;
            padding: 0.75rem 0;
            overflow: hidden;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .ticker-wrapper {
            display: flex;
            white-space: nowrap;
            animation: ticker 60s linear infinite; 
        }
        .ticker-item { padding: 0 1.5rem; color: #d1d5db; }
        .ticker-item strong { color: #fbbf24; }
        @keyframes ticker {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        .social-bar {
            background-color: #374151;
            border-top: 1px solid #4b5563; /* Thinner border */
        }
        .social-icon { transition: color 0.3s ease; }
        /* Brand Colors */
        .social-fb { color: #1877F2; } .social-fb:hover { color: #FFFFFF; }
        .social-tk { color: #000000; } .social-tk:hover { color: #FFFFFF; }
        .social-yt { color: #FF0000; } .social-yt:hover { color: #FFFFFF; }
        .social-ig { color: #E4405F; } .social-ig:hover { color: #FFFFFF; }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">

    <!-- ** NEW: Main Navigation Bar ** -->
    <nav class="bg-white shadow-md sticky top-0 z-40">
        <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
            <a href="./championship.html" class="flex items-center space-x-2">
                <img src="edulogo.jpg" alt="Logo" class="h-10 w-10 rounded-full object-cover" onerror="this.onerror=null; this.src='https://placehold.co/40x40/6d28d9/fbbf24?text=EDU';">
                <span class="text-xl font-bold text-edu-purple">EDU-LEAGUE</span>
            </a>
            <div class="flex space-x-4">
                <a href="./index.html" class="text-gray-600 hover:text-edu-purple font-semibold">Registration</a>
                <a href="./championship.html" class="text-gray-600 hover:text-edu-purple font-semibold">Championship Hub</a>
            </div>
        </div>
    </nav>

    <main class="flex-grow flex items-center justify-center p-4">
        <div class="max-w-3xl w-full bg-white shadow-2xl rounded-xl overflow-hidden">
            
            <!-- Header -->
            <div class="bg-edu-purple text-white p-8">
                <h1 class="text-3xl font-extrabold tracking-tight text-center">Team Roster Submission</h1>
                <p class="mt-1 text-purple-200 text-lg text-center">EDU-LEAGUE CHAMPIONSHIP</p>
            </div>

            <!-- Roster Form -->
            <div class="p-8 md:p-10 space-y-6">
                
                <!-- Team Info Display -->
                <div class="bg-gray-100 p-4 rounded-lg border border-gray-200 text-center">
                    <h2 id="teamNameDisplay" class="text-2xl font-bold text-edu-purple">Loading Team...</h2>
                    <p id="levelDisplay" class="text-lg font-semibold text-gray-700">Loading Level...</p>
                </div>

                <form id="rosterForm" onsubmit="saveRoster(event); return false;" class="space-y-6">

                    <!-- Coach Details -->
                    <fieldset class="space-y-4">
                        <legend class="text-xl font-bold text-gray-800 border-b pb-2 mb-3">Team Officials (2 Total)</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="coachName" class="block text-sm font-medium text-gray-700">1. Head Coach Name</label>
                                <input type="text" id="coachName" name="coachName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-edu-purple ring-edu-purple h-10 p-2 border">
                            </div>
                            <div>
                                <label for="coachPhone" class="block text-sm font-medium text-gray-700">Head Coach Phone</label>
                                <input type="tel" id="coachPhone" name="coachPhone" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-edu-purple ring-edu-purple h-10 p-2 border">
                            </div>
                            <div>
                                <label for="asstCoachName" class="block text-sm font-medium text-gray-700">2. Assistant Coach Name</label>
                                <input type="text" id="asstCoachName" name="asstCoachName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-edu-purple ring-edu-purple h-10 p-2 border">
                            </div>
                            <div>
                                <label for="asstCoachPhone" class="block text-sm font-medium text-gray-700">Assistant Coach Phone</label>
                                <input type="tel" id="asstCoachPhone" name="asstCoachPhone" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-edu-purple ring-edu-purple h-10 p-2 border">
                            </div>
                        </div>
                    </fieldset>

                    <!-- Player Details -->
                    <fieldset>
                        <legend class="text-xl font-bold text-gray-800 border-b pb-2 mb-3">Players (Max 18)</legend>
                        
                        <!-- Player Add Input -->
                        <div class="flex gap-3 mb-4">
                            <div class="flex-grow">
                                <label for="newPlayerName" class="block text-sm font-medium text-gray-700">New Player Full Name</label>
                                <input type="text" id="newPlayerName" name="newPlayerName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-edu-purple ring-edu-purple h-10 p-2 border" placeholder="e.g., John Doe">
                            </div>
                            <button type="button" id="addPlayerButton" onclick="addPlayer()" class="mt-6 px-4 py-2 bg-edu-purple text-white font-semibold rounded-md shadow hover:bg-purple-700 h-10">Add</button>
                        </div>
                        
                        <p id="playerLimitMessage" class="text-sm text-red-600 font-semibold text-center hidden mb-3">Maximum of 18 players reached.</p>

                        <!-- Player List Container -->
                        <div id="playerListContainer" class="max-h-64 overflow-y-auto space-y-2 bg-gray-50 p-4 rounded-lg border">
                            <p id="noPlayersMessage" class="text-gray-500 text-center">No players added yet.</p>
                            <!-- Players will be added here -->
                        </div>
                        <input type="hidden" id="playerCount" value="0">
                    </fieldset>

                    <!-- Submit Button -->
                    <button type="submit" id="submitRosterButton" class="w-full mt-8 py-3 bg-green-600 text-white font-bold rounded-md shadow-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                        Submit Roster & Complete Registration
                    </button>
                </form>
            </div>
        </div>
    </main>

    <!-- Roster Success Box (Modal) -->
    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0 pointer-events-none z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-sm w-full text-center transform transition-all scale-95 duration-300 modal-content">
            <svg class="w-16 h-16 text-green-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Registration 100% Complete!</h3>
            <p class="text-gray-600 mb-6">Your team roster has been submitted. We'll be in touch with the schedule. Good luck!</p>
            <button onclick="goToHome()" class="py-2 px-4 bg-edu-purple text-white font-semibold rounded-md hover:bg-purple-700 transition duration-150">
                Back to Registration Page
            </button>
        </div>
    </div>
    
    <!-- Custom Alert Modal -->
    <div id="custom-alert-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-sm w-full text-center transform transition-all scale-95 duration-300 modal-content">
            <h3 id="custom-alert-title" class="text-xl font-bold text-gray-800 mb-2">Alert</h3>
            <p id="custom-alert-message" class="text-gray-600 mb-6">This is an alert message.</p>
            <button onclick="closeCustomAlert()" class="py-2 px-6 bg-edu-purple text-white font-semibold rounded-md hover:bg-purple-700 transition duration-150">
                OK
            </button>
        </div>
    </div>

    <!-- Footer Area -->
    <footer class="sticky bottom-0 z-10">
        <!-- Social Media Bar -->
        <div class="social-bar p-3">
            <div class="max-w-4xl mx-auto flex justify-center items-center space-x-6">
                <a href="https://facebook.com/YOUR-PAGE-HERE" target="_blank" class="social-icon social-fb" aria-label="Facebook">
                    <i class="fab fa-facebook fa-2x"></i>
                </a>
                <a href="https://tiktok.com/@YOUR-PAGE-HERE" target="_blank" class="social-icon social-tk" aria-label="TikTok">
                    <i class="fab fa-tiktok fa-2x"></i>
                </a>
                <a href="https://youtube.com/YOUR-CHANNEL-HERE" target="_blank" class="social-icon social-yt" aria-label="YouTube">
                    <i class="fab fa-youtube fa-2x"></i>
                </a>
                <a href="https://instagram.com/YOUR-PAGE-HERE" target="_blank" class="social-icon social-ig" aria-label="Instagram">
                    <i class="fab fa-instagram fa-2x"></i>
                </a>
            </div>
        </div>
        <!-- News Ticker -->
        <div class="news-ticker">
            <div class="ticker-wrapper" id="tickerWrapper">
                <!-- Content will be injected by JS -->
            </div>
        </div>
    </footer>

    <!-- Firebase & Logic Script -->
    <script type="module">
        // --- Firebase SDK Imports (CDN Modules) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

        // --- *** YOUR FIREBASE CONFIG IS PASTED HERE *** ---
        const firebaseConfig = {
           apiKey: "AIzaSyDtxFsLYoe0NYlZRWiXgEM90IYKMwx7K8s",
           authDomain: "sonic-verbena-239117.firebaseapp.com",
           databaseURL: "https://sonic-verbena-239117.firebaseio.com",
           projectId: "sonic-verbena-239117",
           storageBucket: "sonic-verbena-239117.firebasestorage.app",
           messagingSenderId: "652544574249",
           appId: "1:652544574249:web:6ff33771307e892e7f6d38",
           measurementId: "G-TD780JGNED"
         };
        // --- *** END OF CONFIG ---

        // --- Firebase & App State ---
        let db;
        let auth;
        let userId;
        let teamDocRef;
        let teamDocId;
        let playerList = [];
        
        // --- DOM Elements ---
        const teamNameDisplay = document.getElementById('teamNameDisplay');
        const levelDisplay = document.getElementById('levelDisplay');
        const playerListContainer = document.getElementById('playerListContainer');
        const newPlayerNameInput = document.getElementById('newPlayerName');
        const addPlayerButton = document.getElementById('addPlayerButton');
        const playerCountInput = document.getElementById('playerCount');
        const playerLimitMessage = document.getElementById('playerLimitMessage');
        const noPlayersMessage = document.getElementById('noPlayersMessage');
        const submitRosterButton = document.getElementById('submitRosterButton');
        const successModal = document.getElementById('success-modal');
        const customAlertModal = document.getElementById('custom-alert-modal');
        const customAlertTitle = document.getElementById('custom-alert-title');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const tickerWrapper = document.getElementById('tickerWrapper');

        // --- Page Load Logic ---
        function loadPageData() {
            const params = new URLSearchParams(window.location.search);
            teamDocId = params.get('teamId'); 

            if (!teamDocId) {
                console.error("Team ID is missing from URL!");
                teamNameDisplay.textContent = "Error: Invalid Link";
                levelDisplay.textContent = "Please go back and complete payment.";
                document.getElementById('rosterForm').classList.add('hidden');
            }
        }
        
        // --- Player List Logic ---
        window.addPlayer = function() {
            const playerName = newPlayerNameInput.value.trim();
            if (playerName === "") {
                showCustomAlert("Error", "Please enter a player name.");
                return;
            }
            
            const currentCount = parseInt(playerCountInput.value);
            if (currentCount >= 18) {
                showCustomAlert("Limit Reached", "You cannot add more than 18 players.");
                return;
            }
            
            playerList.push(playerName);
            newPlayerNameInput.value = ""; // Clear input
            playerCountInput.value = currentCount + 1;
            renderPlayerList();
        }
        
        function renderPlayerList() {
            if (playerList.length === 0) {
                noPlayersMessage.style.display = 'block';
                playerListContainer.innerHTML = '';
                playerListContainer.appendChild(noPlayersMessage);
            } else {
                noPlayersMessage.style.display = 'none';
                playerListContainer.innerHTML = ''; // Clear list
                
                playerList.forEach((name, index) => {
                    const playerEl = document.createElement('div');
                    playerEl.className = 'player-entry bg-white p-2 rounded-md border border-gray-300 shadow-sm';
                    playerEl.innerHTML = `
                        <span class="font-semibold text-gray-700 flex-grow">${index + 1}. ${name}</span>
                        <button type="button" onclick="removePlayer(${index})" class="text-red-500 hover:text-red-700 font-bold px-2 py-1 rounded-full text-xs">
                            Remove
                        </button>
                    `;
                    playerListContainer.appendChild(playerEl);
                });
            }
            
            // Check limit
            if (playerList.length >= 18) {
                playerLimitMessage.classList.remove('hidden');
                newPlayerNameInput.disabled = true;
                addPlayerButton.disabled = true;
            } else {
                playerLimitMessage.classList.add('hidden');
                newPlayerNameInput.disabled = false;
                addPlayerButton.disabled = false;
            }
        }
        
        window.removePlayer = function(index) {
            playerList.splice(index, 1);
            playerCountInput.value = playerList.length;
            renderPlayerList();
        }
        
        // --- Form Submission ---
        window.saveRoster = async function(event) {
            event.preventDefault();
            if (playerList.length === 0) {
                showCustomAlert("Error", "You must add at least one player to the roster.");
                return;
            }
            
            if (!teamDocRef) {
                showCustomAlert("Error", "Database connection not found. Please refresh.");
                return;
            }
            
            submitRosterButton.disabled = true;
            submitRosterButton.textContent = "Saving...";

            const coachData = {
                headCoach: document.getElementById('coachName').value,
                headCoachPhone: document.getElementById('coachPhone').value,
                asstCoach: document.getElementById('asstCoachName').value,
                asstCoachPhone: document.getElementById('asstCoachPhone').value,
            };

            try {
                await updateDoc(teamDocRef, {
                    officials: coachData,
                    players: playerList,
                    registrationStatus: "Complete" // Final step!
                });
                
                // Show success modal
                openModal('success-modal');

            } catch (error) {
                console.error("Error updating roster: ", error);
                showCustomAlert("Error", "Could not save roster. Please try again.");
                submitRosterButton.disabled = false;
                submitRosterButton.textContent = "Submit Roster & Complete Registration";
            }
        }

        window.goToHome = function() {
            // Redirects to registration page with a success flag
            window.location.assign('./index.html?status=complete');
        }

        // --- Modal Functions ---
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            const content = modal.querySelector('.modal-content');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');
            if (content) content.classList.remove('scale-95');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            const content = modal.querySelector('.modal-content');
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.classList.remove('opacity-100');
            if (content) content.classList.add('scale-95');
        }
        
        window.showCustomAlert = (title, message) => {
            customAlertTitle.textContent = title;
            customAlertMessage.textContent = message;
            openModal('custom-alert-modal');
        }
        window.closeCustomAlert = () => closeModal('custom-alert-modal');
        
        // --- News Ticker ---
        async function fetchNews() {
            const staticNews = [
                "<strong>EDU-LEAGUE:</strong> Battle within Educators",
                "<strong>REGISTRATION:</strong> Nov 15th - Nov 25th",
                "<strong>CONTACT:</strong> OPEYEMI 08140712347",
                "<strong>LEVELS:</strong> ðŸ† Finalist (400Lvl) ðŸ”¥ Penultimate (300Lvl) ðŸ‘Ÿ Sophomore (200Lvl)"
            ];
            
            let newsHtml = "";
            staticNews.forEach(item => { newsHtml += `<div class="ticker-item">${item}</div>`; });
            staticNews.forEach(item => { newsHtml += `<div class="ticker-item">${item}</div>`; }); // Duplicate for loop
            tickerWrapper.innerHTML = newsHtml;

            const proxyUrl = 'https://api.allorigins.win/raw?url=';
            const rssFeedUrl = 'https://feeds.skysports.com/data/football.xml';
            try {
                const response = await fetch(proxyUrl + encodeURIComponent(rssFeedUrl));
                if (!response.ok) throw new Error('Network response was not ok for live news.');
                const str = await response.text();
                const data = new window.DOMParser().parseFromString(str, "text/xml");
                const items = data.querySelectorAll("item");
                let liveNewsHtml = "";
                items.forEach((el, index) => {
                    if (index < 15) { 
                        const title = el.querySelector("title").innerHTML;
                        liveNewsHtml += `<div class="ticker-item"><strong>LATEST:</strong> ${title}</div>`;
                    }
                });
                
                if(liveNewsHtml) {
                    tickerWrapper.innerHTML = newsHtml + liveNewsHtml + newsHtml + liveNewsHtml; 
                }
            } catch (error) {
                console.error('Error fetching live news:', error);
            }
            
            const ticker = document.querySelector('.news-ticker');
            ticker.addEventListener('mouseover', () => tickerWrapper.style.animationPlayState = 'paused');
            ticker.addEventListener('mouseout', () => tickerWrapper.style.animationPlayState = 'running');
        }

        // --- Initialize Firebase ---
        function initializeFirebase() {
            return new Promise(async (resolve, reject) => {
                try {
                    if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("PASTE_YOUR_CONFIG_HERE")) {
                        showCustomAlert("Error", "Firebase configuration is missing. Database features will not work.");
                        console.error("Firebase config is missing. Please paste it into team_roster.html.");
                        return reject("Config missing");
                    }

                    const app = initializeApp(firebaseConfig);
                    const analytics = getAnalytics(app);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    await signInAnonymously(auth);

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("User signed in:", userId);
                            
                            if (teamDocId) {
                                teamDocRef = doc(db, "registrations", teamDocId);
                                // Now, fetch the team's data to display
                                try {
                                    const docSnap = await getDoc(teamDocRef);
                                    if (docSnap.exists()) {
                                        const data = docSnap.data();
                                        teamNameDisplay.textContent = data.teamName;
                                        levelDisplay.textContent = data.level;
                                    } else {
                                        teamNameDisplay.textContent = "Error: Team Not Found";
                                    }
                                } catch (getDocError) {
                                    console.error("Error fetching team data:", getDocError);
                                    teamNameDisplay.textContent = "Error loading data";
                                }
                            } else {
                                console.error("Auth change: Team ID is missing from URL!");
                                // This case is already handled by loadPageData, but good to log
                            }
                            resolve(user); 
                            
                        } else {
                            console.log("User signed out.");
                            userId = null;
                            teamDocRef = null;
                            reject("User is not signed in.");
                        }
                    });

                } catch (error) {
                    console.error("Firebase Initialization Error:", error);
                    showCustomAlert("Error", "Could not connect to the database. " + error.message);
                    reject(error);
                }
            });
        }

        // --- Start the App ---
        loadPageData();
        initializeFirebase();
        fetchNews();
    </script>
</body>
</html>