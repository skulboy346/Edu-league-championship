<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Roster - EDU-LEAGUE</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- *** NEW FIREBASE HOSTING SCRIPTS *** -->
    <script src="/__/firebase/11.6.1/firebase-app.js"></script>
    <script src="/__/firebase/11.6.1/firebase-auth.js"></script>
    <script src="/__/firebase/11.6.1/firebase-firestore.js"></script>
    <script src="/__/firebase/init.js"></script>
    <!-- *** END NEW SCRIPTS *** -->
    
    <style>
        /* ... existing style code ... */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fd;
        }
        .bg-edu-purple { background-color: #6d28d9; }
        .text-edu-purple { color: #6d28d9; }
        .border-edu-purple { border-color: #6d28d9; }
        .ring-edu-purple:focus { ring-color: #6d28d9; }
        .bg-edu-yellow { background-color: #fbbf24; }
        .hover-edu-yellow:hover { background-color: #f59e0b; }
        .player-entry {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4">

    <!-- ... existing HTML code ... -->
    <div class="max-w-4xl w-full bg-white shadow-2xl rounded-xl overflow-hidden">
        
        <!-- Header -->
        <div class="bg-edu-purple text-white p-8">
            <h1 class="text-3xl font-extrabold tracking-tight text-center">Team Roster Submission</h1>
            <p class="mt-1 text-purple-200 text-lg text-center">EDU-LEAGUE CHAMPIONSHIP</p>
        </div>

        <!-- Roster Form -->
        <div class="p-8 md:p-10 space-y-6">
            
            <!-- Team Info Display -->
            <div class="bg-gray-100 p-4 rounded-lg border border-gray-200 text-center">
                <h2 id="teamNameDisplay" class="text-2xl font-bold text-edu-purple">Loading Team...</h2>
                <p id="levelDisplay" class="text-lg font-semibold text-gray-700">Loading Level...</p>
            </div>

            <form id="rosterForm" onsubmit="saveRoster(event); return false;" class="space-y-6">

                <!-- Coach Details -->
                <fieldset class="space-y-4">
                    <legend class="text-xl font-bold text-gray-800 border-b pb-2 mb-3">Team Officials (2 Total)</legend>
                    <!-- Head Coach -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="coachName" class="block text-sm font-medium text-gray-700">1. Head Coach Name</label>
                            <input type="text" id="coachName" name="coachName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-edu-purple ring-edu-purple h-10 p-2 border">
                        </div>
                        <div>
                            <label for="coachPhone" class="block text-sm font-medium text-gray-700">Head Coach Phone</label>
                            <input type="tel" id="coachPhone" name="coachPhone" pattern="[0-9]{11}" placeholder="e.g., 08140712347" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-edu-purple ring-edu-purple h-10 p-2 border">
                        </div>
                    </div>
                    <!-- Assistant Coach -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div>
                            <label for="asstCoachName" class="block text-sm font-medium text-gray-700">2. Assistant Coach Name</label>
                            <input type="text" id="asstCoachName" name="asstCoachName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-edu-purple ring-edu-purple h-10 p-2 border">
                        </div>
                        <div>
                            <label for="asstCoachPhone" class="block text-sm font-medium text-gray-700">Assistant Coach Phone</label>
                            <input type="tel" id="asstCoachPhone" name="asstCoachPhone" pattern="[0-9]{11}" placeholder="e.g., 08140712347" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-edu-purple ring-edu-purple h-10 p-2 border">
                        </div>
                    </div>
                </fieldset>

                <!-- Player Details -->
                <fieldset>
                    <legend class="text-xl font-bold text-gray-800 border-b pb-2 mb-3">Players (Max 18)</legend>
                    
                    <!-- Player Add Input -->
                    <div class="flex gap-3 mb-4">
                        <div class="flex-grow">
                            <label for="newPlayerName" class="block text-sm font-medium text-gray-700">New Player Full Name</label>
                            <input type="text" id="newPlayerName" name="newPlayerName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-edu-purple ring-edu-purple h-10 p-2 border" placeholder="e.g., John Doe">
                        </div>
                        <button type="button" id="addPlayerButton" onclick="addPlayer()" class="mt-6 px-4 py-2 bg-edu-purple text-white font-semibold rounded-md shadow hover:bg-purple-700 h-10">Add</button>
                    </div>
                    
                    <p id="playerLimitMessage" class="text-sm text-red-600 font-semibold text-center hidden mb-3">Maximum of 18 players reached.</p>

                    <!-- Player List Container -->
                    <div id="playerListContainer" class="max-h-64 overflow-y-auto space-y-2 bg-gray-50 p-4 rounded-lg border">
                        <p id="noPlayersMessage" class="text-gray-500 text-center">No players added yet.</p>
                        <!-- Players will be added here -->
                    </div>
                    <input type="hidden" id="playerCount" value="0">
                </fieldset>

                <!-- Submit Button -->
                <button type="submit" id="submitRosterButton" class="w-full mt-8 py-3 bg-green-600 text-white font-bold rounded-md shadow-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    Submit Roster & Complete Registration
                </button>
            </form>
        </div>
    </div>

    <!-- Roster Success Box (Modal) -->
    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0 pointer-events-none z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-sm w-full text-center transform transition-all scale-95 duration-300">
            <svg class="w-16 h-16 text-green-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Registration 100% Complete!</h3>
            <p class="text-gray-600 mb-6">Your team roster has been submitted. We'll be in touch with the schedule. Good luck!</p>
            <button onclick="goToHome()" class="py-2 px-4 bg-edu-purple text-white font-semibold rounded-md hover:bg-purple-700 transition duration-150">
                Back to Home Page
            </button>
        </div>
    </div>
    
    <!-- Custom Alert Modal -->
    <div id="custom-alert-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-sm w-full text-center transform transition-all scale-95 duration-300">
            <h3 id="custom-alert-title" class="text-xl font-bold text-gray-800 mb-2">Alert</h3>
            <p id="custom-alert-message" class="text-gray-600 mb-6">This is an alert message.</p>
            <button onclick="closeCustomAlert()" class="py-2 px-6 bg-edu-purple text-white font-semibold rounded-md hover:bg-purple-700 transition duration-150">
                OK
            </button>
        </div>
    </div>


    <!-- Firebase & Logic Script -->
    <script type="module">
        // --- Firebase SDK Imports ---
        // import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // import { getFirestore, doc, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // *** Use the global firebase object provided by the new scripts ***
        const { initializeApp } = firebase;
        const { getAuth, signInAnonymously, onAuthStateChanged } = firebase.auth;
        const { getFirestore, doc, updateDoc, setLogLevel } = firebase.firestore;


        // --- Firebase & App State ---
        let db;
        let auth;
        let userId;
        let teamDocRef; // This will be the reference to the team's document in Firestore
        let teamDocId; // The string ID of the document
        // const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // No longer needed
        
        // --- DOM Elements ---
        // ... all other DOM element consts are correct ...
        const teamNameDisplay = document.getElementById('teamNameDisplay');
        const levelDisplay = document.getElementById('levelDisplay');
        const newPlayerNameInput = document.getElementById('newPlayerName');
        const addPlayerButton = document.getElementById('addPlayerButton');
        const playerListContainer = document.getElementById('playerListContainer');
        const noPlayersMessage = document.getElementById('noPlayersMessage');
        const playerLimitMessage = document.getElementById('playerLimitMessage');
        const playerCountInput = document.getElementById('playerCount');
        const successModal = document.getElementById('success-modal');
        const rosterForm = document.getElementById('rosterForm');
        const customAlertModal = document.getElementById('custom-alert-modal');
        const customAlertTitle = document.getElementById('custom-alert-title');
        const customAlertMessage = document.getElementById('custom-alert-message');

        // --- Player List Management ---
        // ... existing addPlayer and removePlayer functions ...
        const MAX_PLAYERS = 18;
        let players = []; // Array to store player names

        window.addPlayer = function() {
            const playerName = newPlayerNameInput.value.trim();
            if (playerName === "") {
                newPlayerNameInput.focus();
                return; // Don't add empty names
            }
            
            let currentCount = parseInt(playerCountInput.value);
            if (currentCount >= MAX_PLAYERS) {
                return; // Should be impossible if button is disabled, but good to check
            }

            // Add to array and update UI
            players.push(playerName);
            currentCount++;
            playerCountInput.value = currentCount;

            // Hide "no players" message
            if (noPlayersMessage) {
                noPlayersMessage.style.display = 'none';
            }

            // Create new player entry element
            const playerEntry = document.createElement('div');
            playerEntry.className = 'player-entry bg-white p-2 border rounded-md shadow-sm';
            playerEntry.innerHTML = `
                <span class="font-semibold text-gray-800 flex-grow">${currentCount}. ${playerName}</span>
                <button type="button" onclick="removePlayer(this, '${playerName}')" class="text-red-500 hover:text-red-700 font-bold text-sm p-1">
                    &times; Remove
                </button>
            `;
            playerListContainer.appendChild(playerEntry);
            
            // Check limit
            if (currentCount >= MAX_PLAYERS) {
                addPlayerButton.disabled = true;
                newPlayerNameInput.disabled = true;
                playerLimitMessage.classList.remove('hidden');
            }

            // Clear input
            newPlayerNameInput.value = '';
            newPlayerNameInput.focus();
        }
        
        window.removePlayer = function(buttonElement, playerName) {
            // Remove from array
            players = players.filter(p => p !== playerName);
            
            // Remove from UI
            buttonElement.parentElement.remove();
            
            // Update count
            let currentCount = players.length;
            playerCountInput.value = currentCount;

            // Re-enable add button if below limit
            if (currentCount < MAX_PLAYERS) {
                addPlayerButton.disabled = false;
                newPlayerNameInput.disabled = false;
                playerLimitMessage.classList.add('hidden');
            }
            
            // Show "no players" message if empty
            if (currentCount === 0 && noPlayersMessage) {
                noPlayersMessage.style.display = 'block';
            }

            // Re-number remaining players
            const playerEntries = playerListContainer.querySelectorAll('.player-entry');
            playerEntries.forEach((entry, index) => {
                const span = entry.querySelector('span');
                if (span) {
                    span.textContent = `${index + 1}. ${players[index]}`;
                }
            });
        }


        // --- Form & Modal Logic ---
        
        // ... existing saveRoster function ...
        window.saveRoster = async function(event) {
            event.preventDefault();
            
            const coachName = document.getElementById('coachName').value;
            const coachPhone = document.getElementById('coachPhone').value;
            const asstCoachName = document.getElementById('asstCoachName').value;
            const asstCoachPhone = document.getElementById('asstCoachPhone').value;
            
            if (!coachName || !asstCoachName || !coachPhone || !asstCoachPhone) {
                showCustomAlert("Alert", "Please fill in all four Team Official fields (Name and Phone).");
                return;
            }
            
            if (players.length === 0) {
                showCustomAlert("Alert", "Please add at least one player to the roster.");
                return;
            }
            
            if (!teamDocRef) {
                showCustomAlert("Error", "Team document reference not found. Cannot save roster.");
                return;
            }

            const rosterData = {
                roster: {
                    coach: { name: coachName, phone: coachPhone },
                    asstCoach: { name: asstCoachName, phone: asstCoachPhone },
                    players: players,
                    playerCount: players.length
                },
                paymentStatus: "Completed", // Mark payment as fully completed
                registrationStatus: "Complete" // Final status
            };
            
            try {
                // Update the existing document with the new roster data
                await updateDoc(teamDocRef, rosterData);
                console.log("Roster successfully added to document!");
                
                // Show final success modal
                showSuccessModal();

            } catch (error) {
                console.error("Error updating document with roster: ", error);
                showCustomAlert("Error", "An error occurred while saving the roster. Please try again.");
            }
        }
        
        // ... existing showSuccessModal ...
        function showSuccessModal() {
            successModal.classList.remove('opacity-0', 'pointer-events-none');
            successModal.classList.add('opacity-100', 'pointer-events-auto');
            successModal.querySelector('div').classList.remove('scale-95');
            successModal.querySelector('div').classList.add('scale-100');
        }

        // ... existing goToHome (no change needed from last fix) ...
        window.goToHome = function() {
            // Redirect back to the main registration page (index.html) with a final success status
            window.location.assign('./index.html?status=complete');
        }
        
        // ... existing showCustomAlert and closeCustomAlert ...
        window.showCustomAlert = function(title, message) {
            customAlertTitle.textContent = title;
            customAlertMessage.textContent = message;
            customAlertModal.classList.remove('opacity-0', 'pointer-events-none');
            customAlertModal.classList.add('opacity-100');
            customAlertModal.querySelector('div').classList.remove('scale-95');
            customAlertModal.querySelector('div').classList.add('scale-100');
        }

        window.closeCustomAlert = function() {
            customAlertModal.classList.add('opacity-0', 'pointer-events-none');
            customAlertModal.classList.remove('opacity-100');
            customAlertModal.querySelector('div').classList.add('scale-95');
            customAlertModal.querySelector('div').classList.remove('scale-100');
        }

        // --- *** UPDATED Initialize Firebase Function *** ---
        async function initializeFirebase() {
            try {
                // Check if Firebase Hosting auto-injected the config
                if (typeof firebase === 'undefined' || typeof firebase.app === 'undefined') {
                    console.error("Firebase object is not defined. Make sure init scripts are loaded.");
                    teamNameDisplay.textContent = "Error: Firebase Config Missing";
                    levelDisplay.textContent = "The application cannot be initialized.";
                    rosterForm.classList.add('hidden');
                    return;
                }

                // *** NEW: Check if firebase.apps is available before getting config ***
                const app = firebase.apps.length ? firebase.app() : initializeApp(firebaseConfig);
                
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // Enable detailed Firestore logs

                // Sign in the user anonymously
                await signInAnonymously(auth);

                // Setup listener for auth changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User signed in:", userId);
                        
                        // --- Get Team Info from URL ---
                        const urlParams = new URLSearchParams(window..search);
                        teamDocId = urlParams.get('teamId');
                        const teamName = urlParams.get('team') || 'Unknown Team';
                        const level = urlParams.get('level') || 'Unknown Level';

                        if (!teamDocId) {
                            console.error("Team ID is missing from URL!");
                            teamNameDisplay.textContent = "Error: Team ID Not Found";
                            teamNameDisplay.classList.add('text-red-600');
                            levelDisplay.textContent = "Please go back to the registration page and complete payment first.";
                            rosterForm.classList.add('hidden');
                            return;
                        }

                        // Update display
                        teamNameDisplay.textContent = teamName;
                        levelDisplay.textContent = `${level} Level`;
                        
                        // *** UPDATED FIRESTORE PATH ***
                        // Use a simple top-level collection path
                        teamDocRef = doc(db, 'registrations', teamDocId);
                        console.log("Targeting document:", teamDocRef.path);
                        
                    } else {
                        console.log("User signed out.");
                        userId = null;
                        teamDocRef = null;
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                 // Check if firebaseConfig is defined, which is the root cause
                if (typeof firebaseConfig === 'undefined') {
                    teamNameDisplay.textContent = "Error: Config Missing";
                    levelDisplay.textContent = "The /__/firebase/init.js script failed.";
                } else {
                    teamNameDisplay.textContent = "Application Error";
                    levelDisplay.textContent = "Could not initialize Firebase. Check console.";
                }
                rosterForm.classList.add('hidden');
            }
        }
        // --- *** END UPDATED FUNCTION *** ---

        // --- Start the App ---
        initializeFirebase();

    </script>
</body>
</html>