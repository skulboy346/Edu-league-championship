<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News - EDU-LEAGUE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="icon" href="edulogo.jpg" type="image/jpeg">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .bg-edu-purple { background-color: #6d28d9; }
        .news-card { transition: all 0.3s ease; display: flex; flex-direction: column; }
        .news-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1); }
        .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .liked { color: #ef4444; animation: pop 0.3s ease; }
        @keyframes pop { 50% { transform: scale(1.2); } }
        .tab-active { background-color: #16a34a; color: white; border-color: #16a34a; }
        .tab-inactive { background-color: white; color: #374151; border-color: #e5e7eb; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <a href="admin.html" class="fixed bottom-6 right-6 bg-gray-900 text-white w-12 h-12 flex items-center justify-center rounded-full shadow-2xl hover:bg-edu-purple hover:scale-110 transition z-50 border-2 border-white" title="Admin Login">
        <i class="fa-solid fa-lock"></i>
    </a>

    <div class="bg-edu-purple text-white py-2 px-4 flex justify-between items-center z-50 relative shadow-md">
        <span class="text-[10px] md:text-xs font-bold tracking-widest opacity-90 hidden md:block">OFFICIAL NUESA SPORTS PLATFORM</span>
        <span class="text-[10px] md:text-xs font-bold tracking-widest opacity-90 md:hidden">NUESA SPORTS</span>
        <div class="flex space-x-4">
            <a href="https://www.instagram.com/theambassadors_sport?igsh=NjZrdnE1ZXhkang=" target="_blank" class="hover:text-pink-400 transition transform hover:scale-125"><i class="fa-brands fa-instagram text-sm md:text-base"></i></a>
            <a href="https://www.facebook.com/profile.php?id=61583536988203" target="_blank" class="hover:text-blue-500 transition transform hover:scale-125"><i class="fa-brands fa-facebook text-sm md:text-base"></i></a>
            <a href="https://x.com/Ambassador30788?t=jMIhwr41PFXhuY2Q1gGWKg&s=09" target="_blank" class="hover:text-black transition transform hover:scale-125"><i class="fa-brands fa-x-twitter text-sm md:text-base"></i></a>
            <a href="https://www.tiktok.com/@theambassadors_sport?_r=1&_t=ZS-91HkO4CoTOJ" target="_blank" class="hover:text-black transition transform hover:scale-125"><i class="fa-brands fa-tiktok text-sm md:text-base"></i></a>
            <a href="https://youtube.com/@theambassadorsport?si=31duWmdmjbjGCSLI" target="_blank" class="hover:text-red-500 transition transform hover:scale-125"><i class="fa-brands fa-youtube text-sm md:text-base"></i></a>
            <a href="https://wa.me/2348113032943" target="_blank" class="hover:text-green-400 transition transform hover:scale-125"><i class="fa-brands fa-whatsapp text-sm md:text-base"></i></a>
        </div>
    </div>

    <nav class="bg-white border-b sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 flex justify-between h-16 items-center">
            <a href="index.html" class="flex items-center gap-2"><img src="edulogo.jpg" class="h-8 w-8 rounded-full"><span class="font-black text-xl">EDU-LEAGUE</span></a>
            <div class="flex space-x-4"><a href="index.html" class="text-gray-500 font-bold text-sm">Register</a></div>
        </div>
    </nav>

    <main class="flex-grow">
        <div class="bg-gray-900 text-white py-8">
            <div class="max-w-4xl mx-auto px-4">
                <h2 class="text-center text-green-500 text-xs font-bold tracking-widest mb-4">MATCHDAY CENTER</h2>
                <div id="match-widget" class="bg-white/10 rounded-xl p-6 flex justify-between items-center transition-opacity duration-500 mb-6">
                    <div class="w-1/3 text-center"><img id="teamA_img" src="edulogo.jpg" class="w-16 h-16 mx-auto bg-white rounded-full p-1"><h3 id="teamA_name" class="font-bold mt-2">Loading</h3></div>
                    <div class="w-1/3 text-center"><div class="text-3xl font-black italic">VS</div><div id="match_details" class="text-xs text-gray-300 font-mono mt-1">...</div></div>
                    <div class="w-1/3 text-center"><img id="teamB_img" src="edulogo.jpg" class="w-16 h-16 mx-auto bg-white rounded-full p-1"><h3 id="teamB_name" class="font-bold mt-2">Loading</h3></div>
                </div>
                <div class="bg-black/40 rounded-lg p-4 backdrop-blur-sm">
                    <p class="text-center text-xs font-bold text-gray-400 mb-2 uppercase">Predict the Result</p>
                    <div class="flex justify-between gap-2 mb-2">
                        <button onclick="predict('home')" class="flex-1 bg-green-900/50 hover:bg-green-700 py-2 rounded text-xs font-bold border border-green-700">HOME WIN</button>
                        <button onclick="predict('draw')" class="flex-1 bg-gray-700/50 hover:bg-gray-600 py-2 rounded text-xs font-bold border border-gray-500">DRAW</button>
                        <button onclick="predict('away')" class="flex-1 bg-red-900/50 hover:bg-red-700 py-2 rounded text-xs font-bold border border-red-700">AWAY WIN</button>
                    </div>
                    <div class="h-1.5 w-full bg-gray-700 rounded-full overflow-hidden flex">
                        <div id="bar-home" class="bg-green-500 h-full transition-all" style="width: 33%"></div>
                        <div id="bar-draw" class="bg-gray-400 h-full transition-all" style="width: 33%"></div>
                        <div id="bar-away" class="bg-red-500 h-full transition-all" style="width: 33%"></div>
                    </div>
                    <div class="flex justify-between text-[10px] text-gray-400 mt-1"><span id="pct-home">33%</span><span id="pct-draw">33%</span><span id="pct-away">33%</span></div>
                </div>
            </div>
        </div>

        <div class="max-w-6xl mx-auto px-4 mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
            <a href="stats.html" class="bg-gradient-to-r from-gray-900 to-black text-white p-6 rounded-xl shadow-lg flex justify-between items-center transition transform hover:scale-[1.02]">
                <div><h3 class="font-black text-xl text-yellow-500">STATS CENTER</h3><p class="text-xs text-gray-400">Golden Boot • Golden Glove</p></div><i class="fa-solid fa-trophy text-3xl text-gray-600"></i>
            </a>

            <div class="bg-white rounded-xl shadow p-5 border border-gray-100">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-gray-800 text-sm"><i class="fa-solid fa-bullhorn text-blue-500 mr-1"></i> ACTIVE POLLS</h3>
                    <span class="text-[10px] bg-blue-100 text-blue-600 px-2 py-1 rounded font-bold">VOTE</span>
                </div>
                <div id="polls-container" class="space-y-4 max-h-60 overflow-y-auto no-scrollbar"><p class="text-xs text-gray-400 text-center">No active polls.</p></div>
            </div>

            <div class="bg-white rounded-xl shadow p-5 border border-gray-100">
                <div class="flex justify-between items-center mb-3"><h3 class="font-bold text-gray-800 text-sm"><i class="fa-solid fa-star text-purple-500 mr-1"></i> MAN OF THE MATCH</h3><span class="text-[10px] bg-purple-100 text-purple-600 px-2 py-1 rounded font-bold">VOTE</span></div>
                <div id="motm-container" class="space-y-2"><p class="text-xs text-gray-400 text-center">Voting opens after match.</p></div>
            </div>
        </div>

        <div class="max-w-4xl mx-auto px-4 mt-8">
            <div class="bg-white rounded-xl shadow border overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                    <h3 class="font-bold text-gray-800">Standings</h3>
                    <div class="flex space-x-1 overflow-x-auto">
                        <button onclick="loadTable('Finalist')" id="tab-Finalist" class="tab-active px-3 py-1 rounded text-xs font-bold">Finalist</button>
                        <button onclick="loadTable('Penultimate')" id="tab-Penultimate" class="tab-inactive px-3 py-1 rounded text-xs font-bold">Penultimate</button>
                        <button onclick="loadTable('Sophomore')" id="tab-Sophomore" class="tab-inactive px-3 py-1 rounded text-xs font-bold">Sophomore</button>
                        <button onclick="loadTable('Female')" id="tab-Female" class="tab-inactive px-3 py-1 rounded text-xs font-bold bg-pink-50 text-pink-600">Female</button>
                    </div>
                </div>
                <div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-gray-100 text-gray-500 text-xs"><tr><th class="p-3 w-10">#</th><th class="p-3">Team</th><th class="p-3 text-center">PL</th><th class="p-3 text-center">GD</th><th class="p-3 text-center font-black">PTS</th></tr></thead><tbody id="league-table-body"></tbody></table></div>
            </div>
        </div>

        <div class="max-w-6xl mx-auto px-4 py-12">
            <h3 class="font-bold text-2xl mb-6 border-l-4 border-green-600 pl-4">Latest Updates</h3>
            <div id="loading" class="text-center py-10"><i class="fa-solid fa-circle-notch fa-spin text-4xl text-green-600"></i></div>
            <div id="news-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 hidden"></div>
        </div>

        <div class="bg-gray-50 border-t border-b border-gray-200 py-10 mt-12">
            <div class="max-w-6xl mx-auto px-4 text-center">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-6">Supported By</p>
                <div class="flex flex-wrap justify-center items-center gap-8 md:gap-12 opacity-50 hover:opacity-100 transition duration-500">
                    <img src="https://placehold.co/120x60/e5e7eb/a3a3a3?text=SPONSOR+1" class="h-8 md:h-10 object-contain grayscale hover:grayscale-0 transition duration-300">
                    <img src="https://placehold.co/120x60/e5e7eb/a3a3a3?text=SPONSOR+2" class="h-8 md:h-10 object-contain grayscale hover:grayscale-0 transition duration-300">
                    <img src="https://placehold.co/120x60/e5e7eb/a3a3a3?text=SPONSOR+3" class="h-8 md:h-10 object-contain grayscale hover:grayscale-0 transition duration-300">
                    <a href="https://wa.me/2348113032943?text=Hello%20I%20want%20to%20advertise%20on%20EDU-LEAGUE" class="h-8 md:h-10 px-4 border-2 border-dashed border-gray-300 rounded flex items-center justify-center text-[10px] text-gray-400 font-bold hover:border-edu-purple hover:text-edu-purple transition">Your Logo Here</a>
                </div>
            </div>
        </div>

        <footer class="bg-white border-t py-8 text-center">
            <p class="text-gray-400 text-xs font-bold mb-4">POWERED BY THE AMBASSADOR'S SPORTS</p>
        </footer>
    </main>

    <div id="newsModal" class="fixed inset-0 bg-black bg-opacity-90 z-[60] hidden flex items-center justify-center p-0 md:p-4 backdrop-blur-sm">
        <div class="bg-white md:rounded-2xl w-full max-w-3xl h-full md:h-[90vh] flex flex-col overflow-hidden relative shadow-2xl">
            <div class="p-4 border-b flex justify-between items-center bg-white z-10">
                <h3 class="font-bold text-gray-800 text-lg truncate pr-4">Post Details</h3>
                <button onclick="closeModal()" class="bg-gray-100 p-2 rounded-full hover:bg-gray-200 text-gray-600 transition"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="overflow-y-auto flex-grow bg-gray-50 no-scrollbar pb-20">
                <div id="media-container" class="w-full bg-black flex justify-center">
                    <img id="modalImg" class="w-full max-h-96 object-contain hidden">
                </div>
                <div class="p-6 md:p-8 bg-white">
                    <span id="modalDate" class="text-xs font-bold text-green-600 uppercase tracking-wide"></span>
                    <h2 id="modalTitle" class="text-2xl md:text-3xl font-black text-gray-900 mt-2 mb-6 leading-tight"></h2>
                    <p id="modalBody" class="text-gray-800 whitespace-pre-line text-base leading-relaxed"></p>
                </div>
                <div class="p-6 border-t bg-gray-50">
                    <h4 class="font-bold text-gray-700 mb-4 text-sm uppercase">Comments</h4>
                    <div id="comments-list" class="space-y-3 mb-4"></div>
                </div>
            </div>
            <form onsubmit="postComment(event)" class="bg-white p-3 border-t flex gap-2 items-center absolute bottom-0 w-full">
                <input id="commentName" class="w-1/4 text-xs border p-2 rounded bg-gray-50 focus:outline-none" placeholder="Name" required maxlength="15">
                <input id="commentInput" class="flex-grow text-sm p-2 border rounded bg-gray-50 focus:outline-none" placeholder="Write a comment..." required autocomplete="off">
                <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded font-bold"><i class="fa-solid fa-paper-plane"></i></button>
            </form>
        </div>
    </div>

    <div id="teamModal" class="fixed inset-0 bg-black/90 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl overflow-hidden relative">
            <button onclick="document.getElementById('teamModal').classList.add('hidden')" class="absolute top-2 right-2 bg-gray-100 p-2 rounded-full text-gray-600 z-10"><i class="fa-solid fa-times"></i></button>
            <div class="bg-edu-purple p-6 text-center text-white relative">
                <img id="tm-logo" src="edulogo.jpg" class="w-20 h-20 rounded-full border-4 border-white shadow-lg mx-auto mb-2 object-contain bg-white">
                <h2 id="tm-name" class="text-xl font-black">Team Name</h2>
                <p id="tm-coach" class="text-xs text-purple-200">Coach: ...</p>
            </div>
            <div class="p-6 max-h-[60vh] overflow-y-auto">
                <h4 class="font-bold text-gray-500 text-xs uppercase mb-3 border-b pb-1">Squad List</h4>
                <ul id="tm-roster" class="space-y-2 text-sm text-gray-800"></ul>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, increment, addDoc, serverTimestamp, getDoc, where, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- FIREBASE KEYS ---
        const firebaseConfig = {
           apiKey: "AIzaSyDtxFsLYoe0NYlZRWiXgEM90IYKMwx7K8s",
           authDomain: "sonic-verbena-239117.firebaseapp.com",
           projectId: "sonic-verbena-239117",
           storageBucket: "sonic-verbena-239117.firebasestorage.app",
           messagingSenderId: "652544574249",
           appId: "1:652544574249:web:6ff33771307e892e7f6d38",
           measurementId: "G-TD780JGNED"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let currentPostId = null;
        let commentsUnsubscribe = null;
        let matchInterval = null;

        signInAnonymously(auth).catch(console.error);

        // --- 1. MATCH SPOTLIGHT ---
        onSnapshot(doc(db, "app_content", "current_fixture"), (docSnap) => {
            if(docSnap.exists()) {
                const data = docSnap.data();
                if(matchInterval) clearInterval(matchInterval);
                if (data.matches && Array.isArray(data.matches) && data.matches.length > 0) {
                    let idx = 0;
                    document.getElementById('slider-dots').innerHTML = data.matches.map((_, i) => `<div class="h-2 w-2 rounded-full bg-gray-500 opacity-50 transition-all" id="dot-${i}"></div>`).join('');
                    const updateDisplay = () => {
                        const m = data.matches[idx];
                        const widget = document.getElementById('match-widget');
                        widget.style.opacity = 0;
                        setTimeout(() => {
                            document.getElementById('teamA_name').textContent = m.teamA;
                            document.getElementById('teamB_name').textContent = m.teamB;
                            document.getElementById('match_details').textContent = `${m.date} • ${m.time} • ${m.venue}`;
                            document.getElementById('teamA_img').src = m.teamALogo || 'edulogo.jpg';
                            document.getElementById('teamB_img').src = m.teamBLogo || 'edulogo.jpg';
                            for(let i=0; i<data.matches.length; i++) {
                                const dot = document.getElementById(`dot-${i}`);
                                if(i===idx) { dot.classList.add('bg-white'); dot.classList.remove('bg-gray-500'); }
                                else { dot.classList.remove('bg-white'); dot.classList.add('bg-gray-500'); }
                            }
                            widget.style.opacity = 1;
                        }, 250);
                        idx = (idx + 1) % data.matches.length;
                    };
                    updateDisplay();
                    if(data.matches.length > 1) matchInterval = setInterval(updateDisplay, 5000); 
                }
            }
        });

        // --- 2. NEWS FEED (FIXED: Now includes Interaction Buttons) ---
        onSnapshot(query(collection(db, "news_posts"), orderBy("timestamp", "desc")), (snapshot) => {
            const grid = document.getElementById('news-grid');
            document.getElementById('loading').classList.add('hidden');
            grid.classList.remove('hidden');
            grid.innerHTML = '';
            
            if (snapshot.empty) { grid.innerHTML = '<p class="text-center col-span-full text-gray-400">No news updates available.</p>'; return; }

            snapshot.forEach(doc => {
                const data = doc.data();
                const pid = doc.id;
                const mediaUrl = data.imageUrl || 'https://placehold.co/600x400/16a34a/ffffff?text=EDU-LEAGUE+NEWS';
                const likes = data.likes || 0;
                const commentsCount = data.commentsCount || 0;
                const isLiked = localStorage.getItem(`liked_${pid}`) ? 'liked' : 'text-gray-400';
                const heartIcon = localStorage.getItem(`liked_${pid}`) ? 'fa-solid' : 'fa-regular';
                
                let dateStr = "Recent";
                if(data.timestamp) dateStr = data.timestamp.toDate().toLocaleDateString('en-US', {month:'short', day:'numeric'});

                const isVideo = mediaUrl.includes('.mp4') || mediaUrl.includes('.mov') || mediaUrl.includes('.webm') || mediaUrl.includes('/video/upload/');
                let mediaHtml = isVideo ? `<video src="${mediaUrl}" class="w-full h-full object-cover" muted></video>` : `<img src="${mediaUrl}" class="w-full h-full object-cover">`;

                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-sm overflow-hidden news-card border border-gray-100 h-full flex flex-col';
                card.id = `card-${pid}`; // ID for lookup
                
                // Store data
                card.dataset.title = data.title;
                card.dataset.content = data.content;
                card.dataset.media = mediaUrl; 
                card.dataset.isvideo = isVideo; 
                card.dataset.date = dateStr;

                card.innerHTML = `
                    <div class="relative h-48 bg-gray-100">
                        ${mediaHtml}
                        <div class="absolute bottom-2 right-2 bg-black bg-opacity-60 text-white text-[10px] font-bold px-2 py-1 rounded backdrop-blur-sm uppercase">${dateStr}</div>
                    </div>
                    <div class="p-5 flex flex-col flex-grow">
                        <h3 class="text-lg font-bold text-gray-900 mb-2 leading-snug cursor-pointer hover:text-green-600 transition" onclick="openModal('${pid}')">${data.title}</h3>
                        <p class="text-sm text-gray-500 line-clamp-3 mb-4 flex-grow">${data.content}</p>
                        
                        <button onclick="openModal('${pid}')" class="text-green-600 font-bold text-xs mb-4 hover:underline self-start">
                            READ FULL STORY &rarr;
                        </button>

                        <div class="pt-3 mt-auto border-t border-gray-100 flex justify-between items-center text-sm">
                            <div class="flex space-x-4">
                                <button onclick="handleLike('${pid}')" class="flex items-center space-x-1 interaction-btn ${isLiked}" id="like-btn-${pid}">
                                    <i class="${heartIcon} fa-heart"></i><span id="like-count-${pid}" class="text-xs font-bold">${likes}</span>
                                </button>
                                <button onclick="openModal('${pid}')" class="flex items-center space-x-1 interaction-btn text-gray-400 hover:text-blue-500">
                                    <i class="fa-regular fa-comment"></i><span class="text-xs font-bold">${commentsCount}</span>
                                </button>
                            </div>
                            <button onclick="handleShare('${data.title}')" class="text-gray-400 hover:text-green-600 interaction-btn"><i class="fa-solid fa-share-nodes"></i></button>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        });

        // --- INTERACTIONS ---
        window.handleLike = async (id) => {
            const isLiked = localStorage.getItem(`liked_${id}`);
            const btn = document.getElementById(`like-btn-${id}`);
            const countSpan = document.getElementById(`like-count-${id}`);
            const icon = btn.querySelector('i');
            let newCount = parseInt(countSpan.innerText);
            if (isLiked) { newCount--; localStorage.removeItem(`liked_${id}`); btn.classList.remove('liked'); icon.classList.replace('fa-solid', 'fa-regular'); } 
            else { newCount++; localStorage.setItem(`liked_${id}`, 'true'); btn.classList.add('liked'); icon.classList.replace('fa-regular', 'fa-solid'); }
            countSpan.innerText = newCount;
            await updateDoc(doc(db, "news_posts", id), { likes: increment(isLiked ? -1 : 1) });
        }
        window.handleShare = (title) => { if (navigator.share) navigator.share({ title: 'EDU-LEAGUE Update', text: title, url: window.location.href }); else { navigator.clipboard.writeText(window.location.href); alert("Link copied!"); } }

        // --- 3. MODAL (FIXED) ---
        window.openModal = (pid) => {
            currentPostId = pid;
            const cardEl = document.getElementById(`card-${pid}`);
            if(!cardEl) return;

            document.getElementById('modalTitle').innerText = cardEl.dataset.title;
            document.getElementById('modalBody').innerText = cardEl.dataset.content;
            document.getElementById('modalDate').innerText = cardEl.dataset.date;
            
            const imgEl = document.getElementById('modalImg');
            const container = document.getElementById('media-container');
            const existingVideo = container.querySelector('video');
            if(existingVideo) existingVideo.remove();
            imgEl.classList.add('hidden');

            const isVideo = cardEl.dataset.isvideo === 'true';
            const mediaUrl = cardEl.dataset.media;

            if (isVideo) {
                const video = document.createElement('video');
                video.src = mediaUrl;
                video.controls = true;
                video.autoplay = true;
                video.className = "w-full max-h-96 object-contain";
                container.appendChild(video);
            } else {
                imgEl.src = mediaUrl;
                imgEl.classList.remove('hidden');
            }

            document.getElementById('newsModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            const list = document.getElementById('comments-list'); list.innerHTML = '<p class="text-xs text-gray-400">Loading comments...</p>';
            commentsUnsubscribe = onSnapshot(query(collection(db, "news_posts", pid, "comments"), orderBy("timestamp", "asc")), (snap) => {
                list.innerHTML = '';
                if(snap.empty) { list.innerHTML = '<p class="text-xs text-gray-400 italic">No comments yet.</p>'; return; }
                snap.forEach(d => { const c = d.data(); list.innerHTML += `<div class="bg-gray-50 p-2 rounded-lg border text-sm"><p class="font-bold text-green-700 text-xs">${c.user}</p><p class="text-gray-700">${c.text}</p></div>`; });
            });
        }
        window.closeModal = () => { document.getElementById('newsModal').classList.add('hidden'); document.body.style.overflow = 'auto'; if(commentsUnsubscribe) commentsUnsubscribe(); }
        window.postComment = async (e) => {
            e.preventDefault(); if(!currentPostId) return;
            const input = document.getElementById('commentInput'); const nameInput = document.getElementById('commentName');
            const text = input.value.trim(); const user = nameInput.value.trim() || "Fan";
            if(!text) return; input.value = ''; 
            await addDoc(collection(db, "news_posts", currentPostId, "comments"), { user, text, timestamp: serverTimestamp() });
            await updateDoc(doc(db, "news_posts", currentPostId), { commentsCount: increment(1) });
        }

        // --- 4. LEAGUE TABLE & TEAM POPUP ---
        window.loadTable = (lvl) => {
            ['Finalist','Penultimate','Sophomore','Female'].forEach(l => { const b=document.getElementById(`tab-${l}`); b.className = l===lvl ? "tab-active px-3 py-1 rounded text-xs font-bold" : "tab-inactive px-3 py-1 rounded text-xs font-bold"; });
            onSnapshot(doc(db, "app_content", `league_table_${lvl.toLowerCase()}`), (s) => {
                const b = document.getElementById('league-table-body'); b.innerHTML = ''; if(!s.exists()) return;
                const d = s.data(); const teams = Object.keys(d).map(k=>({name:k, ...d[k]})).sort((a,b)=>(b.pts-a.pts)||(b.gd-a.gd));
                teams.forEach((t,i) => {
                    b.innerHTML += `<tr class="border-b"><td class="p-3 font-bold ${i<4?'text-green-700':''}">${i+1}</td><td class="p-3 font-semibold text-blue-700 cursor-pointer hover:underline" onclick="openTeam('${t.name}')">${t.name}</td><td class="p-3 text-center">${t.mp}</td><td class="p-3 text-center">${t.gd}</td><td class="p-3 text-center font-black">${t.pts}</td></tr>`;
                });
            });
        }
        loadTable('Finalist');

        window.openTeam = async (name) => {
            const q = query(collection(db, "registrations"), where("department", "==", name)); const snap = await getDocs(q);
            if(!snap.empty) {
                const d = snap.docs[0].data(); document.getElementById('tm-name').textContent=d.department; document.getElementById('tm-coach').textContent="Coach: "+d.coachName;
                const asset = await getDoc(doc(db, "team_assets", name)); document.getElementById('tm-logo').src = asset.exists()?asset.data().logoUrl : 'edulogo.jpg';
                document.getElementById('tm-roster').innerHTML = (d.players||[]).map(p=>`<li class="flex justify-between border-b pb-1"><span>${p.name}</span><span class="text-gray-400 text-xs">${p.position||''}</span></li>`).join('') || '<li>No players.</li>';
                document.getElementById('teamModal').classList.remove('hidden');
            } else alert("Team details not found.");
        }

        // --- 5. FAN ZONE (MULTIPLE POLLS) ---
        onSnapshot(query(collection(db, "polls"), where("active", "==", true)), (snap) => {
            const el = document.getElementById('polls-container');
            el.innerHTML = snap.empty ? '<p class="text-xs text-gray-400 text-center">No active polls.</p>' : '';
            snap.forEach(doc => {
                const d = doc.data(); const id = doc.id;
                const voted = localStorage.getItem(`voted_${id}`);
                let content = '';
                if(voted) {
                    const t = (d.votes1||0)+(d.votes2||0); const p1=t?Math.round((d.votes1/t)*100):0; const p2=t?Math.round((d.votes2/t)*100):0;
                    content = `<div class="mb-1 text-xs font-bold flex justify-between"><span>${d.opt1}</span><span>${p1}%</span></div><div class="h-1.5 bg-gray-200 rounded mb-2"><div class="h-1.5 bg-blue-600 rounded" style="width:${p1}%"></div></div><div class="mb-1 text-xs font-bold flex justify-between"><span>${d.opt2}</span><span>${p2}%</span></div><div class="h-1.5 bg-gray-200 rounded"><div class="h-1.5 bg-red-600 rounded" style="width:${p2}%"></div></div>`;
                } else {
                    content = `<div class="grid grid-cols-2 gap-2 mt-2"><button onclick="vote('${id}',1)" class="border p-2 rounded text-xs font-bold hover:bg-blue-50">${d.opt1}</button><button onclick="vote('${id}',2)" class="border p-2 rounded text-xs font-bold hover:bg-red-50">${d.opt2}</button></div>`;
                }
                el.innerHTML += `<div class="border-b pb-4 mb-4 last:border-0"><p class="text-sm font-bold text-gray-800">${d.question}</p>${content}</div>`;
            });
        });
        window.vote = async (id, o) => { localStorage.setItem(`voted_${id}`,'true'); await updateDoc(doc(db, "polls", id), { [o===1?'votes1':'votes2']: increment(1) }); }
        
        // --- 6. PREDICTOR & MOTM & CHEER ---
        const fanDoc = doc(db, "app_content", "fan_zone");
        onSnapshot(fanDoc, (s) => {
            if(!s.exists()) { setDoc(fanDoc, { cheer_battle: {}, prediction: {home:0, draw:0, away:0}, motm: { active:false, nominees:[], votes:[] } }, { merge: true }); return; }
            const d = s.data();
            // Predictor
            const totalP = (d.prediction.home||0) + (d.prediction.draw||0) + (d.prediction.away||0);
            const ph = totalP ? Math.round((d.prediction.home/totalP)*100) : 33; const pd = totalP ? Math.round((d.prediction.draw/totalP)*100) : 33; const pa = totalP ? Math.round((d.prediction.away/totalP)*100) : 33;
            document.getElementById('bar-home').style.width = ph+'%'; document.getElementById('pct-home').innerText = ph+'%'; document.getElementById('bar-draw').style.width = pd+'%'; document.getElementById('pct-draw').innerText = pd+'%'; document.getElementById('bar-away').style.width = pa+'%'; document.getElementById('pct-away').innerText = pa+'%';
            // MOTM
            const m = document.getElementById('motm-container');
            if(d.motm && d.motm.active) {
                m.innerHTML = ''; const totalV = d.motm.votes.reduce((a,b)=>a+b, 0);
                d.motm.nominees.forEach((n, i) => { if(n) { const pct = totalV ? Math.round((d.motm.votes[i]/totalV)*100) : 0; m.innerHTML += `<div class="mb-2"><div class="flex justify-between items-center text-xs mb-1"><span>${n}</span><span>${pct}%</span></div><div class="w-full bg-gray-200 h-1.5 rounded mb-1"><div class="bg-purple-600 h-1.5 rounded" style="width:${pct}%"></div></div><button onclick="voteMOTM(${i})" class="text-[10px] underline text-gray-500">Vote</button></div>`; } });
            } else { m.innerHTML = '<p class="text-xs text-gray-400 text-center">Voting closed.</p>'; }
        });
        window.predict = async (type) => { if(localStorage.getItem('predicted_match')) return alert("Already predicted!"); localStorage.setItem('predicted_match', 'true'); await updateDoc(fanDoc, { [`prediction.${type}`]: increment(1) }); }
        window.voteMOTM = async (idx) => { if(localStorage.getItem('voted_motm')) return alert("Already voted!"); localStorage.setItem('voted_motm', 'true'); alert("Vote Recorded!"); }
    </script>
</body>
</html>