<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News - EDU-LEAGUE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* Card & Interactions */
        .news-card { transition: all 0.2s ease; }
        .news-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .interaction-btn { transition: color 0.2s ease; }
        .interaction-btn:hover { transform: scale(1.1); }
        .liked { color: #ef4444; } /* Red Heart */
        
        /* Modal */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <nav class="bg-white border-b sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="index.html" class="flex-shrink-0 flex items-center">
                        <span class="font-black text-2xl tracking-tighter text-gray-900">EDU-<span class="text-green-600">LEAGUE</span></span>
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="index.html" class="text-gray-500 hover:text-green-600 font-medium text-sm hidden md:block">Registration</a>
                    
                    <button onclick="toggleFollow()" id="followBtn" class="bg-gray-100 text-gray-600 px-4 py-2 rounded-full text-xs font-bold border hover:bg-green-50 transition flex items-center">
                        <i class="fa-regular fa-bell mr-2"></i> Follow Updates
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow">
        <div class="bg-gray-900 text-white py-10 text-center relative overflow-hidden">
            <div class="relative z-10">
                <h1 class="text-3xl md:text-4xl font-extrabold mb-2">LEAGUE <span class="text-green-500">BUZZ</span></h1>
                <p class="text-gray-400 text-sm">Highlights ‚Ä¢ Results ‚Ä¢ Gist</p>
            </div>
            <div class="absolute top-0 left-0 w-32 h-32 bg-green-600 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-blob"></div>
            <div class="absolute top-0 right-0 w-32 h-32 bg-purple-600 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-blob animation-delay-2000"></div>
        </div>

        <div class="bg-green-600 text-white py-2 px-4 text-center text-xs font-bold tracking-wide shadow-inner" id="latest-result-bar">
            Thinking football...
        </div>

        <div class="max-w-5xl mx-auto px-4 py-8">
            <div id="loading" class="text-center py-20"><i class="fa-solid fa-circle-notch fa-spin text-3xl text-green-600"></i></div>
            <div id="news-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden"></div>
        </div>
    </main>

    <div id="newsModal" class="fixed inset-0 bg-black bg-opacity-80 z-[60] hidden flex items-center justify-center p-0 md:p-4">
        <div class="bg-white md:rounded-2xl w-full max-w-2xl h-full md:h-[90vh] flex flex-col overflow-hidden relative animate-fade-in">
            
            <div class="p-4 border-b flex justify-between items-center bg-white z-10">
                <h3 class="font-bold text-gray-800 text-lg truncate pr-4" id="modalHeaderTitle">Post Details</h3>
                <button onclick="closeModal()" class="bg-gray-100 p-2 rounded-full hover:bg-gray-200"><i class="fa-solid fa-times"></i></button>
            </div>

            <div class="overflow-y-auto flex-grow bg-gray-50 scrollbar-hide">
                <img id="modalImg" class="w-full h-64 object-cover hidden">
                <div class="p-6 bg-white mb-2">
                    <span id="modalDate" class="text-xs font-bold text-green-600 uppercase"></span>
                    <h2 id="modalTitle" class="text-2xl font-black text-gray-900 mt-1 mb-4 leading-tight"></h2>
                    <p id="modalBody" class="text-gray-700 whitespace-pre-line text-sm leading-relaxed"></p>
                </div>

                <div class="p-6">
                    <h4 class="font-bold text-gray-800 mb-4 flex items-center"><i class="fa-regular fa-comments mr-2"></i> Comments</h4>
                    
                    <div id="comments-list" class="space-y-4 mb-6">
                        </div>

                    <form onsubmit="postComment(event)" class="bg-white p-3 rounded-xl border shadow-sm sticky bottom-0">
                        <input id="commentName" class="w-full text-xs border-b mb-2 p-1 focus:outline-none focus:border-green-500" placeholder="Your Name (Optional)" maxlength="20">
                        <div class="flex items-center gap-2">
                            <input id="commentInput" class="w-full text-sm p-2 bg-gray-50 rounded-lg focus:outline-none" placeholder="Write a comment..." required autocomplete="off">
                            <button type="submit" class="text-green-600 font-bold px-3 hover:text-green-700"><i class="fa-solid fa-paper-plane"></i></button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, increment, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- PASTE FIREBASE CONFIG HERE ---
        const firebaseConfig = {
           apiKey: "AIzaSyDtxFsLYoe0NYlZRWiXgEM90IYKMwx7K8s",
           authDomain: "sonic-verbena-239117.firebaseapp.com",
           projectId: "sonic-verbena-239117",
           storageBucket: "sonic-verbena-239117.firebasestorage.app",
           messagingSenderId: "652544574249",
           appId: "1:652544574249:web:6ff33771307e892e7f6d38",
           measurementId: "G-TD780JGNED"
        };
        // ----------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let currentPostId = null;
        let commentsUnsubscribe = null;

        // Anonymous Auth for Likes/Comments
        signInAnonymously(auth).catch(console.error);

        // --- FOLLOW LOGIC ---
        window.toggleFollow = () => {
            const btn = document.getElementById('followBtn');
            const isFollowing = localStorage.getItem('eduLeagueFollowing') === 'true';
            
            if (isFollowing) {
                localStorage.setItem('eduLeagueFollowing', 'false');
                btn.innerHTML = '<i class="fa-regular fa-bell mr-2"></i> Follow Updates';
                btn.classList.remove('bg-green-100', 'text-green-700');
                btn.classList.add('bg-gray-100', 'text-gray-600');
            } else {
                localStorage.setItem('eduLeagueFollowing', 'true');
                btn.innerHTML = '<i class="fa-solid fa-bell mr-2"></i> Following';
                btn.classList.remove('bg-gray-100', 'text-gray-600');
                btn.classList.add('bg-green-100', 'text-green-700');
                alert("You are now following EDU-LEAGUE! We'll highlight new posts for you.");
            }
        }
        
        // Init Follow State
        if(localStorage.getItem('eduLeagueFollowing') === 'true') {
            const btn = document.getElementById('followBtn');
            btn.innerHTML = '<i class="fa-solid fa-bell mr-2"></i> Following';
            btn.classList.add('bg-green-100', 'text-green-700');
        }

        // --- LOAD POSTS ---
        const q = query(collection(db, "news_posts"), orderBy("timestamp", "desc"));
        onSnapshot(q, (snapshot) => {
            const grid = document.getElementById('news-grid');
            const loading = document.getElementById('loading');
            grid.innerHTML = '';
            loading.classList.add('hidden'); grid.classList.remove('hidden');

            if (snapshot.empty) { grid.innerHTML = '<p class="text-center col-span-full text-gray-400">No news yet.</p>'; return; }

            snapshot.forEach(doc => {
                const data = doc.data();
                const pid = doc.id;
                const imgUrl = data.imageUrl || 'https://placehold.co/600x400/16a34a/ffffff?text=NEWS';
                const likes = data.likes || 0;
                const commentsCount = data.commentsCount || 0;
                const isLiked = localStorage.getItem(`liked_${pid}`) ? 'liked' : 'text-gray-400';
                const heartIcon = localStorage.getItem(`liked_${pid}`) ? 'fa-solid' : 'fa-regular';
                
                // Format Date
                let dateStr = "Recent";
                if(data.timestamp) dateStr = data.timestamp.toDate().toLocaleDateString('en-US', {month:'short', day:'numeric'});

                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-sm overflow-hidden news-card border border-gray-100 flex flex-col h-full';
                card.innerHTML = `
                    <div class="relative cursor-pointer" onclick="openModal('${pid}')">
                        <img src="${imgUrl}" class="h-48 w-full object-cover">
                        <div class="absolute bottom-2 right-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded backdrop-blur-sm">
                            ${dateStr}
                        </div>
                    </div>
                    <div class="p-4 flex flex-col flex-grow">
                        <h3 class="text-lg font-bold text-gray-900 mb-2 leading-snug cursor-pointer hover:text-green-600" onclick="openModal('${pid}')">${data.title}</h3>
                        <p class="text-sm text-gray-500 line-clamp-3 mb-4">${data.content}</p>
                        
                        <div class="mt-auto pt-3 border-t border-gray-100 flex justify-between items-center text-sm">
                            <div class="flex space-x-4">
                                <button onclick="handleLike('${pid}')" class="flex items-center space-x-1 interaction-btn ${isLiked}" id="like-btn-${pid}">
                                    <i class="${heartIcon} fa-heart"></i>
                                    <span id="like-count-${pid}">${likes}</span>
                                </button>
                                <button onclick="openModal('${pid}')" class="flex items-center space-x-1 interaction-btn text-gray-400 hover:text-blue-500">
                                    <i class="fa-regular fa-comment"></i>
                                    <span>${commentsCount}</span>
                                </button>
                            </div>
                            <button onclick="handleShare('${data.title}')" class="text-gray-400 hover:text-green-600 interaction-btn">
                                <i class="fa-solid fa-share-nodes"></i>
                            </button>
                        </div>
                    </div>
                `;
                // Store data on element for modal retrieval
                card.dataset.title = data.title;
                card.dataset.content = data.content;
                card.dataset.img = imgUrl;
                card.dataset.date = dateStr;
                grid.appendChild(card);
            });
        });

        // --- INTERACTIONS ---
        window.handleLike = async (id) => {
            const isLiked = localStorage.getItem(`liked_${id}`);
            const btn = document.getElementById(`like-btn-${id}`);
            const countSpan = document.getElementById(`like-count-${id}`);
            const icon = btn.querySelector('i');
            
            // Optimistic UI Update
            let newCount = parseInt(countSpan.innerText);
            if (isLiked) {
                newCount--;
                localStorage.removeItem(`liked_${id}`);
                btn.classList.remove('liked', 'text-gray-400');
                btn.classList.add('text-gray-400');
                icon.classList.remove('fa-solid'); icon.classList.add('fa-regular');
            } else {
                newCount++;
                localStorage.setItem(`liked_${id}`, 'true');
                btn.classList.remove('text-gray-400');
                btn.classList.add('liked');
                icon.classList.remove('fa-regular'); icon.classList.add('fa-solid');
            }
            countSpan.innerText = newCount;

            // DB Update
            const ref = doc(db, "news_posts", id);
            await updateDoc(ref, { likes: increment(isLiked ? -1 : 1) });
        }

        window.handleShare = (title) => {
            if (navigator.share) {
                navigator.share({ title: 'EDU-LEAGUE News', text: title, url: window.location.href });
            } else {
                navigator.clipboard.writeText(window.location.href);
                alert("Link copied to clipboard!");
            }
        }

        // --- MODAL & COMMENTS ---
        window.openModal = (pid) => {
            currentPostId = pid;
            // Find card data
            const card = document.querySelector(`div[onclick="openModal('${pid}')"]`).parentNode;
            
            document.getElementById('modalTitle').innerText = card.dataset.title;
            document.getElementById('modalBody').innerText = card.dataset.content;
            document.getElementById('modalHeaderTitle').innerText = card.dataset.title;
            document.getElementById('modalDate').innerText = card.dataset.date;
            
            const img = document.getElementById('modalImg');
            if(card.dataset.img.includes('placehold.co')) img.classList.add('hidden');
            else { img.src = card.dataset.img; img.classList.remove('hidden'); }

            document.getElementById('newsModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            // Load Comments
            const commentsRef = collection(db, "news_posts", pid, "comments");
            const q = query(commentsRef, orderBy("timestamp", "asc"));
            
            const list = document.getElementById('comments-list');
            list.innerHTML = '<p class="text-xs text-gray-400">Loading comments...</p>';

            commentsUnsubscribe = onSnapshot(q, (snap) => {
                list.innerHTML = '';
                if(snap.empty) { list.innerHTML = '<p class="text-xs text-gray-400 italic">Be the first to comment!</p>'; return; }
                
                snap.forEach(d => {
                    const c = d.data();
                    list.innerHTML += `
                        <div class="bg-gray-50 p-2 rounded-lg border">
                            <p class="text-xs font-bold text-gray-800">${c.user}</p>
                            <p class="text-sm text-gray-600">${c.text}</p>
                        </div>
                    `;
                });
            });
        }

        window.closeModal = () => {
            document.getElementById('newsModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            if(commentsUnsubscribe) commentsUnsubscribe(); // Stop listening
        }

        window.postComment = async (e) => {
            e.preventDefault();
            if(!currentPostId) return;
            const input = document.getElementById('commentInput');
            const nameInput = document.getElementById('commentName');
            const text = input.value.trim();
            const user = nameInput.value.trim() || "Anonymous";

            if(!text) return;
            input.value = ''; // Clear early

            const postRef = doc(db, "news_posts", currentPostId);
            const commentsRef = collection(db, "news_posts", currentPostId, "comments");

            await addDoc(commentsRef, { user, text, timestamp: serverTimestamp() });
            await updateDoc(postRef, { commentsCount: increment(1) });
        }

        // --- TICKER ---
        onSnapshot(doc(db, "app_content", "current_fixture"), (doc) => {
            if(doc.exists()) {
                const d = doc.data();
                document.getElementById('latest-result-bar').innerText = `üèÜ UPCOMING: ${d.teamA} vs ${d.teamB} @ ${d.time} (${d.venue})`;
            }
        });

    </script>
</body>
</html>