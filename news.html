<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News - EDU-LEAGUE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="icon" href="edulogo.jpg" type="image/jpeg">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .news-card { transition: all 0.3s ease; } .news-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px -5px rgba(0,0,0,0.1); }
        .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .liked { color: #ef4444; animation: pop 0.3s ease; } @keyframes pop { 50% { transform: scale(1.2); } }
        .tab-active { background-color: #16a34a; color: white; border-color: #16a34a; }
        .tab-inactive { background-color: white; color: #374151; border-color: #e5e7eb; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <nav class="bg-white border-b sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 flex justify-between h-16 items-center">
            <a href="index.html" class="flex items-center gap-2"><img src="edulogo.jpg" class="h-8 w-8 rounded-full"><span class="font-black text-xl">EDU-LEAGUE</span></a>
            <div class="flex space-x-4"><a href="index.html" class="text-gray-500 font-bold text-sm">Register</a></div>
        </div>
    </nav>

    <main class="flex-grow">
        <div class="bg-gray-900 text-white py-8">
            <div class="max-w-4xl mx-auto px-4">
                <h2 class="text-center text-green-500 text-xs font-bold tracking-widest mb-4">MATCHDAY FIXTURES</h2>
                <div id="match-widget" class="bg-white/10 rounded-xl p-6 flex justify-between items-center transition-opacity duration-500">
                    <div class="w-1/3 text-center"><img id="teamA_img" src="edulogo.jpg" class="w-16 h-16 mx-auto bg-white rounded-full p-1"><h3 id="teamA_name" class="font-bold mt-2">Loading</h3></div>
                    <div class="w-1/3 text-center"><div class="text-3xl font-black italic">VS</div><div id="match_details" class="text-xs text-gray-300 font-mono mt-1">...</div></div>
                    <div class="w-1/3 text-center"><img id="teamB_img" src="edulogo.jpg" class="w-16 h-16 mx-auto bg-white rounded-full p-1"><h3 id="teamB_name" class="font-bold mt-2">Loading</h3></div>
                </div>
                <div id="slider-dots" class="flex justify-center gap-2 mt-4"></div>
            </div>
        </div>

        <div class="max-w-4xl mx-auto px-4 mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
            <a href="stats.html" class="bg-gradient-to-r from-gray-900 to-black text-white p-6 rounded-xl shadow-lg flex justify-between items-center">
                <div><h3 class="font-black text-xl text-yellow-500">STATS CENTER</h3><p class="text-xs text-gray-400">Golden Boot • Golden Glove</p></div><i class="fa-solid fa-trophy text-3xl text-gray-600"></i>
            </a>
            <div class="bg-white rounded-xl shadow p-5">
                <div class="flex justify-between mb-3"><h3 class="font-bold text-gray-800 text-sm"><i class="fa-solid fa-bolt text-yellow-500 mr-2"></i>Fan Zone</h3><span class="text-[10px] bg-red-100 text-red-600 px-2 py-1 rounded font-bold">POLL</span></div>
                <div id="poll-container"><p class="text-sm font-bold" id="poll-question">Loading...</p><div class="space-y-2" id="poll-options"></div></div>
            </div>
        </div>

        <div class="max-w-4xl mx-auto px-4 mt-8">
            <div class="bg-white rounded-xl shadow border overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                    <h3 class="font-bold text-gray-800">Standings</h3>
                    <div class="flex space-x-1">
                        <button onclick="loadTable('Finalist')" id="tab-Finalist" class="tab-active px-3 py-1 rounded text-xs font-bold">Finalist</button>
                        <button onclick="loadTable('Penultimate')" id="tab-Penultimate" class="tab-inactive px-3 py-1 rounded text-xs font-bold">Penultimate</button>
                        <button onclick="loadTable('Sophomore')" id="tab-Sophomore" class="tab-inactive px-3 py-1 rounded text-xs font-bold">Sophomore</button>
                        <button onclick="loadTable('Female')" id="tab-Female" class="tab-inactive px-3 py-1 rounded text-xs font-bold bg-pink-50 text-pink-600">Female</button>
                    </div>
                </div>
                <div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-gray-100 text-gray-500 text-xs"><tr><th class="p-3 w-10">#</th><th class="p-3">Team</th><th class="p-3 text-center">PL</th><th class="p-3 text-center">GD</th><th class="p-3 text-center font-black">PTS</th></tr></thead><tbody id="league-table-body"></tbody></table></div>
            </div>
        </div>

        <div class="max-w-6xl mx-auto px-4 py-12">
            <h3 class="font-bold text-2xl mb-6 border-l-4 border-green-600 pl-4">Latest Updates</h3>
            <div id="news-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6">Loading...</div>
        </div>
    </main>

    <div id="newsModal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl h-[80vh] flex flex-col rounded-xl overflow-hidden">
            <div class="p-4 border-b flex justify-between"><h3 class="font-bold">Post</h3><button onclick="closeModal()">X</button></div>
            <div class="overflow-y-auto flex-grow bg-gray-100">
                <div id="media-container" class="bg-black flex justify-center"><img id="modalImg" class="max-h-80 hidden"></div>
                <div class="p-6 bg-white"><h2 id="modalTitle" class="text-2xl font-black"></h2><p id="modalBody" class="mt-4 text-gray-800 whitespace-pre-line"></p></div>
                <div class="p-6 border-t"><h4 class="font-bold text-xs mb-2">COMMENTS</h4><div id="comments-list" class="space-y-2"></div></div>
            </div>
            <form onsubmit="postComment(event)" class="p-3 border-t bg-white flex gap-2"><input id="commentName" class="w-1/4 border p-2 rounded text-xs" placeholder="Name"><input id="commentInput" class="flex-grow border p-2 rounded text-xs" placeholder="Comment..."><button class="bg-green-600 text-white px-4 rounded">Send</button></form>
        </div>
    </div>

    <div id="teamModal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-xl overflow-hidden relative">
            <button onclick="document.getElementById('teamModal').classList.add('hidden')" class="absolute top-2 right-2 bg-gray-100 p-2 rounded-full text-gray-600 z-10">X</button>
            <div class="bg-purple-700 p-6 text-center text-white"><img id="tm-logo" src="edulogo.jpg" class="w-16 h-16 rounded-full mx-auto bg-white p-1 mb-2"><h2 id="tm-name" class="text-xl font-black">Team</h2><p id="tm-coach" class="text-xs text-purple-200">Coach: ...</p></div>
            <div class="p-6 max-h-[50vh] overflow-y-auto"><h4 class="font-bold text-xs mb-2">SQUAD</h4><ul id="tm-roster" class="space-y-2 text-sm"></ul></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, increment, addDoc, serverTimestamp, getDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDtxFsLYoe0NYlZRWiXgEM90IYKMwx7K8s", authDomain: "sonic-verbena-239117.firebaseapp.com", projectId: "sonic-verbena-239117", storageBucket: "sonic-verbena-239117.appspot.com", messagingSenderId: "652544574249", appId: "1:652544574249:web:6ff33771307e892e7f6d38", measurementId: "G-TD780JGNED" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);
        signInAnonymously(auth);
        let currentPostId, matchInterval, commentsUnsubscribe;

        onSnapshot(doc(db, "app_content", "current_fixture"), (s) => {
            if(s.exists()) {
                const d = s.data(); if(matchInterval) clearInterval(matchInterval);
                if(d.matches && d.matches.length > 0) {
                    let idx = 0; document.getElementById('slider-dots').innerHTML = d.matches.map((_,i)=>`<div class="h-2 w-2 rounded-full bg-gray-500" id="dot-${i}"></div>`).join('');
                    const update = () => {
                        const m = d.matches[idx];
                        document.getElementById('teamA_name').textContent=m.teamA; document.getElementById('teamB_name').textContent=m.teamB; document.getElementById('match_details').textContent=`${m.date} • ${m.time} • ${m.venue}`;
                        document.getElementById('teamA_img').src=m.teamALogo||'edulogo.jpg'; document.getElementById('teamB_img').src=m.teamBLogo||'edulogo.jpg';
                        for(let i=0;i<d.matches.length;i++) document.getElementById(`dot-${i}`).className = i===idx ? "h-2 w-2 rounded-full bg-white" : "h-2 w-2 rounded-full bg-gray-500";
                        idx = (idx+1)%d.matches.length;
                    };
                    update(); if(d.matches.length>1) matchInterval=setInterval(update, 4000);
                }
            }
        });

        onSnapshot(query(collection(db, "news_posts"), orderBy("timestamp", "desc")), (snap) => {
            const grid = document.getElementById('news-grid'); grid.innerHTML='';
            snap.forEach(doc => {
                const d = doc.data(); const url = d.imageUrl || 'edulogo.jpg'; const isVideo = url.includes('.mp4')||url.includes('.mov')||url.includes('video/upload');
                const media = isVideo ? `<video src="${url}" class="w-full h-full object-cover" muted></video>` : `<img src="${url}" class="w-full h-full object-cover">`;
                const div = document.createElement('div'); div.className="bg-white rounded-xl shadow overflow-hidden news-card";
                div.dataset.title=d.title; div.dataset.content=d.content; div.dataset.media=url; div.dataset.isvideo=isVideo;
                div.innerHTML = `<div class="h-48 relative bg-gray-100">${media}</div><div class="p-4"><h3 class="font-bold text-lg cursor-pointer hover:text-green-600" onclick="openModal('${doc.id}')">${d.title}</h3><p class="text-sm text-gray-500 line-clamp-3">${d.content}</p><button class="text-xs font-bold text-green-600 mt-2" onclick="openModal('${doc.id}')">READ MORE</button></div>`;
                grid.appendChild(div);
            });
        });

        window.loadTable = (lvl) => {
            ['Finalist','Penultimate','Sophomore','Female'].forEach(l => { const b=document.getElementById(`tab-${l}`); b.className = l===lvl ? "tab-active px-3 py-1 rounded text-xs font-bold" : "tab-inactive px-3 py-1 rounded text-xs font-bold"; });
            onSnapshot(doc(db, "app_content", `league_table_${lvl.toLowerCase()}`), (s) => {
                const b = document.getElementById('league-table-body'); b.innerHTML = ''; if(!s.exists()) return;
                const d = s.data(); const teams = Object.keys(d).map(k=>({name:k, ...d[k]})).sort((a,b)=>(b.pts-a.pts)||(b.gd-a.gd));
                teams.forEach((t,i) => {
                    b.innerHTML += `<tr class="border-b"><td class="p-3 font-bold ${i<4?'text-green-700':''}">${i+1}</td><td class="p-3 font-semibold text-blue-700 cursor-pointer hover:underline" onclick="openTeam('${t.name}')">${t.name}</td><td class="p-3 text-center">${t.mp}</td><td class="p-3 text-center">${t.gd}</td><td class="p-3 text-center font-black">${t.pts}</td></tr>`;
                });
            });
        }
        loadTable('Finalist');

        window.openTeam = async (name) => {
            const q = query(collection(db, "registrations"), where("department", "==", name)); const snap = await getDocs(q);
            if(!snap.empty) {
                const d = snap.docs[0].data(); document.getElementById('tm-name').textContent=d.department; document.getElementById('tm-coach').textContent="Coach: "+d.coachName;
                const asset = await getDoc(doc(db, "team_assets", name)); document.getElementById('tm-logo').src = asset.exists()?asset.data().logoUrl : 'edulogo.jpg';
                document.getElementById('tm-roster').innerHTML = (d.players||[]).map(p=>`<li class="flex justify-between border-b pb-1"><span>${p.name}</span><span class="text-gray-400 text-xs">${p.position||''}</span></li>`).join('') || '<li>No players.</li>';
                document.getElementById('teamModal').classList.remove('hidden');
            } else alert("Team details not found.");
        }

        onSnapshot(doc(db, "app_content", "active_poll"), (s) => {
            const el = document.getElementById('poll-container');
            if(!s.exists()) { el.innerHTML='<p class="text-xs text-gray-400">No active polls.</p>'; return; }
            const d = s.data(); document.getElementById('poll-question').textContent=d.question;
            const voted = localStorage.getItem('voted_poll');
            const opts = document.getElementById('poll-options');
            if(voted) {
                const t = (d.votes1||0)+(d.votes2||0); const p1=t?Math.round((d.votes1/t)*100):0; const p2=t?Math.round((d.votes2/t)*100):0;
                opts.innerHTML = `<div class="mb-2 text-xs font-bold flex justify-between"><span>${d.opt1}</span><span>${p1}%</span></div><div class="h-2 bg-gray-200 rounded"><div class="h-2 bg-blue-600 rounded" style="width:${p1}%"></div></div><div class="mb-2 mt-2 text-xs font-bold flex justify-between"><span>${d.opt2}</span><span>${p2}%</span></div><div class="h-2 bg-gray-200 rounded"><div class="h-2 bg-red-600 rounded" style="width:${p2}%"></div></div>`;
            } else {
                opts.innerHTML = `<button onclick="vote(1)" class="w-full border p-2 rounded text-xs font-bold mb-2">${d.opt1}</button><button onclick="vote(2)" class="w-full border p-2 rounded text-xs font-bold">${d.opt2}</button>`;
            }
        });
        window.vote = async (o) => { localStorage.setItem('voted_poll','true'); await updateDoc(doc(db, "app_content", "active_poll"), { [o===1?'votes1':'votes2']: increment(1) }); }

        window.openModal = (pid) => {
            currentPostId = pid;
            const btn = document.querySelector(`div[onclick="openModal('${pid}')"]`); if(!btn) return; 
            const cardEl = btn.parentNode;
            document.getElementById('modalTitle').innerText = cardEl.dataset.title; document.getElementById('modalBody').innerText = cardEl.dataset.content;
            const container = document.getElementById('media-container'); container.innerHTML='';
            if(cardEl.dataset.isvideo==='true') { const v=document.createElement('video'); v.src=cardEl.dataset.media; v.controls=true; v.className="w-full max-h-96"; container.appendChild(v); }
            else { const i=document.createElement('img'); i.src=cardEl.dataset.media; i.className="w-full max-h-96 object-contain"; container.appendChild(i); }
            document.getElementById('newsModal').classList.remove('hidden');
            const list = document.getElementById('comments-list'); list.innerHTML = 'Loading...';
            commentsUnsubscribe = onSnapshot(query(collection(db, "news_posts", pid, "comments"), orderBy("timestamp", "asc")), (snap) => {
                list.innerHTML = ''; snap.forEach(d => { const c = d.data(); list.innerHTML += `<div class="bg-gray-50 p-2 rounded text-sm mb-1"><b>${c.user}</b>: ${c.text}</div>`; });
            });
        }
        window.closeModal = () => document.getElementById('newsModal').classList.add('hidden');
        window.postComment = async (e) => { e.preventDefault(); if(!currentPostId) return; const t = document.getElementById('commentInput').value; const u = document.getElementById('commentName').value || "Fan"; if(!t)return; document.getElementById('commentInput').value=''; await addDoc(collection(db, "news_posts", currentPostId, "comments"), { user:u, text:t, timestamp: serverTimestamp() }); }
    </script>
</body>
</html>