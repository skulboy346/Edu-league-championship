<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - EDU-LEAGUE</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6d28d9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js');
            });
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="icon" href="edulogo.jpg" type="image/jpeg">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        h1, h2, h3, .sport-font { font-family: 'Rajdhani', sans-serif; text-transform: uppercase; }
        .bg-edu-purple { background-color: #6d28d9; } .text-edu-purple { color: #6d28d9; }
        .news-card { transition: all 0.3s ease; }
        .news-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1); }
        .liked { color: #ef4444; animation: pop 0.3s ease; }
        @keyframes pop { 50% { transform: scale(1.2); } }
        .mini-tab-active { background-color: #1f2937; color: white; }
        .mini-tab-inactive { background-color: #f3f4f6; color: #6b7280; }
        .tab-active { background-color: #6d28d9; color: white; border-color: #6d28d9; }
        .tab-inactive { background-color: white; color: #374151; border-color: #e5e7eb; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        @keyframes burn { 0% { opacity: 0.8; color: #ef4444; } 100% { opacity: 1; color: #f59e0b; } }
        .fire-icon { animation: burn 0.8s infinite alternate; }
        .sponsor-slot { border: 2px dashed rgba(255,255,255,0.2); transition: all 0.3s; }
        .sponsor-slot:hover { border-color: #fbbf24; background: rgba(255,255,255,0.05); transform: scale(1.05); }
        .glow-btn { animation: pulse-gold 2s infinite; }
        @keyframes pulse-gold { 0% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(251, 191, 36, 0); } 100% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0); } }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <a href="admin.html" class="fixed bottom-6 right-6 bg-gray-900 text-white w-12 h-12 flex items-center justify-center rounded-full shadow-2xl hover:bg-edu-purple hover:scale-110 transition z-50 border-2 border-white" title="Admin Login"><i class="fa-solid fa-lock"></i></a>

    <div class="bg-edu-purple text-white py-2 px-4 flex justify-between items-center z-50 relative shadow-md">
        <span class="text-[10px] md:text-xs font-bold tracking-widest opacity-90 hidden md:block">OFFICIAL NUESA SPORTS PLATFORM</span>
        <span class="text-[10px] md:text-xs font-bold tracking-widest opacity-90 md:hidden">NUESA SPORTS</span>
        <div class="flex space-x-4">
            <a href="https://www.instagram.com/theambassadors_sport" target="_blank" class="hover:text-pink-400 transition transform hover:scale-110"><i class="fa-brands fa-instagram"></i></a>
            <a href="https://x.com/Ambassador30788" target="_blank" class="hover:text-black transition transform hover:scale-110"><i class="fa-brands fa-x-twitter"></i></a>
            <a href="https://wa.me/2348113032943" target="_blank" class="hover:text-green-400 transition transform hover:scale-110"><i class="fa-brands fa-whatsapp"></i></a>
        </div>
    </div>

    <nav class="bg-white border-b sticky top-0 z-40 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 flex justify-between h-16 items-center">
            <a href="index.html" class="flex items-center gap-2"><img src="edulogo.jpg" class="h-9 w-9 rounded-full border border-gray-200"><span class="font-black text-2xl sport-font tracking-tight text-gray-800">EDU-LEAGUE</span></a>
            <div class="flex space-x-4"><a href="index.html" class="text-edu-purple font-bold text-sm uppercase tracking-wide">Home</a></div>
        </div>
    </nav>

    <div class="bg-white border-b border-gray-200 sticky top-16 z-30 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-3 flex gap-3 overflow-x-auto no-scrollbar">
            <button onclick="openTableModal()" class="flex-1 min-w-[120px] flex items-center justify-center gap-2 bg-slate-800 text-white py-2.5 rounded-lg shadow-md hover:bg-slate-900 transition">
                <i class="fa-solid fa-table"></i> <span class="font-bold text-xs sport-font tracking-wide">FULL TABLE</span>
            </button>
            <button onclick="openScheduleModal('fixtures')" class="flex-1 min-w-[120px] flex items-center justify-center gap-2 bg-green-600 text-white py-2.5 rounded-lg shadow-md hover:bg-green-700 transition">
                <i class="fa-regular fa-calendar-days"></i> <span class="font-bold text-xs sport-font tracking-wide">FIXTURES</span>
            </button>
            <button onclick="openScheduleModal('results')" class="flex-1 min-w-[120px] flex items-center justify-center gap-2 bg-red-600 text-white py-2.5 rounded-lg shadow-md hover:bg-red-700 transition">
                <i class="fa-solid fa-square-check"></i> <span class="font-bold text-xs sport-font tracking-wide">RESULTS</span>
            </button>
        </div>
    </div>

    <main class="flex-grow max-w-7xl mx-auto w-full p-4">
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-2 space-y-8">
                
                <div class="bg-gray-900 text-white rounded-2xl overflow-hidden shadow-xl relative">
                    <div class="absolute inset-0 bg-gradient-to-br from-purple-900/50 to-blue-900/50"></div>
                    <div class="relative p-6">
                        <h2 class="text-center text-green-400 text-[10px] font-bold tracking-[0.2em] mb-4">MATCHDAY SPOTLIGHT</h2>
                        <div id="match-widget" class="flex justify-between items-center mb-6 transition-opacity duration-300">
                            <div class="w-1/3 text-center flex flex-col items-center">
                                <img id="teamA_img" src="edulogo.jpg" class="w-14 h-14 bg-white rounded-full p-1 object-contain shadow-lg">
                                <h3 id="teamA_name" class="font-bold mt-2 text-sm sport-font">Loading</h3>
                            </div>
                            <div class="w-1/3 text-center">
                                <div id="match_category" class="text-[9px] bg-red-600 px-2 py-0.5 rounded mb-1 inline-block font-bold">LIVE</div>
                                <div class="text-3xl font-black italic sport-font">VS</div>
                                <div id="match_details" class="text-[10px] text-gray-300 font-mono mt-1">...</div>
                            </div>
                            <div class="w-1/3 text-center flex flex-col items-center">
                                <img id="teamB_img" src="edulogo.jpg" class="w-14 h-14 bg-white rounded-full p-1 object-contain shadow-lg">
                                <h3 id="teamB_name" class="font-bold mt-2 text-sm sport-font">Loading</h3>
                            </div>
                        </div>
                        <div class="bg-white/10 rounded-lg p-3 backdrop-blur-sm border border-white/10">
                            <div class="flex justify-between gap-2 mb-2">
                                <button onclick="predict('home')" class="flex-1 bg-green-600/80 hover:bg-green-600 py-1.5 rounded text-[10px] font-bold border border-green-400 transition">HOME</button>
                                <button onclick="predict('draw')" class="flex-1 bg-gray-600/80 hover:bg-gray-500 py-1.5 rounded text-[10px] font-bold border border-gray-400 transition">DRAW</button>
                                <button onclick="predict('away')" class="flex-1 bg-red-600/80 hover:bg-red-600 py-1.5 rounded text-[10px] font-bold border border-red-400 transition">AWAY</button>
                            </div>
                            <div class="h-1.5 w-full bg-gray-700 rounded-full overflow-hidden flex">
                                <div id="bar-home" class="bg-green-500 h-full transition-all duration-500" style="width: 33%"></div>
                                <div id="bar-draw" class="bg-gray-400 h-full transition-all duration-500" style="width: 33%"></div>
                                <div id="bar-away" class="bg-red-500 h-full transition-all duration-500" style="width: 33%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="font-black text-xl mb-4 border-l-4 border-edu-purple pl-3 sport-font text-gray-800">LATEST UPDATES</h3>
                    <div id="loading" class="text-center py-10"><i class="fa-solid fa-circle-notch fa-spin text-3xl text-edu-purple"></i></div>
                    <div id="news-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6 hidden"></div>
                </div>
            </div>

            <div class="lg:col-span-1 space-y-6">
                
                <div id="potw-card" class="bg-white rounded-xl shadow-lg border-t-4 border-purple-600 overflow-hidden">
                    <div class="p-4 bg-purple-50 border-b border-purple-100 flex justify-between items-center">
                        <h3 class="font-black text-purple-900 text-sm sport-font flex items-center gap-2">
                            <i class="fa-solid fa-star text-yellow-500"></i> PLAYER OF THE WEEK
                        </h3>
                        <button onclick="openPOTWHistory()" class="text-[10px] font-bold text-purple-600 hover:underline">
                            <i class="fa-solid fa-clock-rotate-left"></i> HISTORY
                        </button>
                    </div>
                    <div id="potw-voting-area" class="p-4">
                        <p class="text-center text-xs text-gray-400 py-4">Loading POTW...</p>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden">
                    <div class="p-3 bg-gray-50 border-b flex justify-between items-center">
                        <h3 class="font-black text-gray-800 text-sm sport-font flex items-center gap-2"><i class="fa-solid fa-list-ol text-blue-600"></i> TOP 4</h3>
                        <div class="flex gap-1">
                            <button onclick="loadMiniTable('Finalist')" id="mt-Finalist" class="mini-tab-active px-2 py-1 rounded text-[9px] font-bold transition">FIN</button>
                            <button onclick="loadMiniTable('Penultimate')" id="mt-Penultimate" class="mini-tab-inactive px-2 py-1 rounded text-[9px] font-bold transition">PEN</button>
                            <button onclick="loadMiniTable('Sophomore')" id="mt-Sophomore" class="mini-tab-inactive px-2 py-1 rounded text-[9px] font-bold transition">SOPH</button>
                            <button onclick="loadMiniTable('Female')" id="mt-Female" class="mini-tab-inactive px-2 py-1 rounded text-[9px] font-bold transition bg-pink-100 text-pink-700">FEM</button>
                        </div>
                    </div>
                    <div class="p-2">
                        <table class="w-full text-xs text-left">
                            <thead class="text-gray-400 font-bold border-b"><tr><th class="py-2 pl-2">Team</th><th class="text-center">P</th><th class="text-center">Pts</th></tr></thead>
                            <tbody id="mini-table-body" class="divide-y divide-gray-50"></tbody>
                        </table>
                        <button onclick="openTableModal()" class="w-full text-center text-[10px] text-blue-600 font-bold mt-3 hover:underline">VIEW FULL TABLE</button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md p-4 border border-gray-100">
                    <h3 class="font-black text-gray-800 text-sm sport-font mb-3 flex items-center gap-2"><i class="fa-solid fa-fire text-orange-500"></i> FAN ZONE</h3>
                    <div id="polls-container" class="space-y-3 max-h-60 overflow-y-auto no-scrollbar"><p class="text-xs text-gray-400 text-center py-2">No active polls.</p></div>
                </div>

                <a href="stats.html" class="block bg-gradient-to-r from-gray-900 to-black text-white p-4 rounded-xl shadow-lg text-center hover:scale-[1.02] transition">
                    <h3 class="font-black text-lg text-yellow-400 sport-font">STATS CENTER</h3>
                    <p class="text-[10px] text-gray-400">Goals ‚Ä¢ Assists ‚Ä¢ Cards</p>
                </a>

            </div>
        </div>

        <div class="mt-12 bg-gradient-to-r from-slate-900 via-purple-900 to-slate-900 py-10 relative overflow-hidden shadow-2xl border-t-4 border-yellow-400">
            <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 20px 20px;"></div>
            <div class="max-w-6xl mx-auto px-4 relative z-10 text-center">
                <h2 class="text-2xl md:text-3xl font-black text-white italic sport-font tracking-tighter mb-2">FUEL THE PASSION</h2>
                <p class="text-xs text-purple-200 font-bold uppercase tracking-[0.3em] mb-8">Official Partners & Sponsors</p>
                <div class="flex flex-wrap justify-center items-center gap-6 md:gap-10">
                    <div class="h-16 w-32 rounded-lg bg-white/5 backdrop-blur-sm flex items-center justify-center text-white/20 font-bold text-xs uppercase tracking-widest sponsor-slot cursor-default">Your Logo</div>
                    <div class="h-16 w-32 rounded-lg bg-white/5 backdrop-blur-sm flex items-center justify-center text-white/20 font-bold text-xs uppercase tracking-widest sponsor-slot cursor-default">Your Logo</div>
                    <a href="https://wa.me/2348113032943?text=Hello%20I%20want%20to%20sponsor%20EDU-LEAGUE" target="_blank" class="glow-btn bg-gradient-to-r from-yellow-400 to-yellow-500 text-gray-900 h-14 px-8 rounded-lg transform skew-x-[-10deg] flex items-center justify-center hover:scale-105 transition duration-300 shadow-xl border-b-4 border-yellow-700">
                        <span class="skew-x-[10deg] font-black text-lg sport-font flex items-center gap-2">BECOME A SPONSOR <i class="fa-solid fa-arrow-right-long"></i></span>
                    </a>
                </div>
            </div>
        </div>

        <footer class="bg-gray-900 text-white py-8">
            <div class="max-w-6xl mx-auto px-4 text-center">
                <img src="edulogo.jpg" class="h-12 w-12 rounded-full mx-auto mb-4 border-2 border-gray-700">
                <p class="text-gray-400 text-sm mb-4">¬© 2025/26 NUESA Sports Committee.</p>
                <p class="text-center text-gray-400 text-[10px] font-bold tracking-widest">POWERED BY THE AMBASSADOR'S SPORTS</p>
            </div>
        </footer>
    </main>

    <div id="potwHistoryModal" class="fixed inset-0 bg-black/90 z-[90] hidden flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-white w-full max-w-md rounded-2xl overflow-hidden shadow-2xl h-[70vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center bg-purple-600 text-white">
                <h3 class="font-black text-lg sport-font"><i class="fa-solid fa-trophy text-yellow-400 mr-2"></i> HALL OF FAME</h3>
                <button onclick="document.getElementById('potwHistoryModal').classList.add('hidden')" class="bg-white/20 p-2 rounded-full hover:bg-white/40"><i class="fa-solid fa-times"></i></button>
            </div>
            <div id="potw-history-list" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50"></div>
        </div>
    </div>

    <div id="tableModal" class="fixed inset-0 bg-black/90 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-white w-full max-w-2xl rounded-2xl overflow-hidden shadow-2xl h-[80vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-black text-lg text-gray-800 sport-font">LEAGUE STANDINGS</h3>
                <button onclick="document.getElementById('tableModal').classList.add('hidden')" class="bg-gray-200 p-2 rounded-full hover:bg-gray-300"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-4 bg-white flex space-x-2 overflow-x-auto justify-center shadow-sm">
                <button onclick="loadFullTable('Finalist')" id="ft-Finalist" class="tab-active px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition">Finalist</button>
                <button onclick="loadFullTable('Penultimate')" id="ft-Penultimate" class="tab-inactive px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition">Penultimate</button>
                <button onclick="loadFullTable('Sophomore')" id="ft-Sophomore" class="tab-inactive px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition">Sophomore</button>
                <button onclick="loadFullTable('Female')" id="ft-Female" class="tab-inactive px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition">Female</button>
            </div>
            <div class="flex-1 overflow-auto p-4">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-100 text-gray-500 text-[10px] uppercase font-bold sticky top-0">
                        <tr><th class="p-3">#</th><th class="p-3">Team</th><th class="p-3 text-center">PL</th><th class="p-3 text-center">W</th><th class="p-3 text-center">D</th><th class="p-3 text-center">L</th><th class="p-3 text-center">GD</th><th class="p-3 text-center text-black">PTS</th></tr>
                    </thead>
                    <tbody id="full-table-body" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="scheduleModal" class="fixed inset-0 bg-black/90 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-white w-full max-w-2xl h-[80vh] rounded-2xl overflow-hidden flex flex-col relative shadow-2xl">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h3 id="sched-modal-title" class="font-black text-xl text-gray-800 sport-font flex items-center gap-2"><i class="fa-regular fa-calendar-days text-green-600"></i> FIXTURES</h3>
                <button onclick="document.getElementById('scheduleModal').classList.add('hidden')" class="bg-gray-200 p-2 rounded-full hover:bg-gray-300 transition"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-4 bg-white border-b">
                <select id="sched-filter" onchange="renderSchedule()" class="w-full p-2 border rounded-lg text-sm font-bold text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-100">
                    <option value="All">All Divisions</option><option value="Finalist (400Lvl)">Finalist</option><option value="Penultimate (300Lvl)">Penultimate</option><option value="Sophomore (200Lvl)">Sophomore</option><option value="Female League">Female</option>
                </select>
            </div>
            <div id="schedule-list" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50"><p class="text-center text-gray-400 mt-10"><i class="fa-solid fa-circle-notch fa-spin text-2xl"></i> Loading...</p></div>
        </div>
    </div>

    <div id="newsModal" class="fixed inset-0 bg-black/95 z-[80] hidden flex items-center justify-center p-0 md:p-4 backdrop-blur-md">
        <div class="bg-white md:rounded-2xl w-full max-w-3xl h-full md:h-[90vh] flex flex-col overflow-hidden relative shadow-2xl">
            <div class="p-4 border-b flex justify-between items-center bg-white z-10"><h3 class="font-bold text-gray-800 text-lg truncate pr-4 sport-font">STORY DETAILS</h3><button onclick="closeModal()" class="bg-gray-100 p-2 rounded-full hover:bg-gray-200 text-gray-600"><i class="fa-solid fa-times text-xl"></i></button></div>
            <div class="overflow-y-auto flex-grow bg-gray-50 no-scrollbar pb-20">
                <div id="media-container" class="w-full bg-black flex justify-center min-h-[250px] items-center"><img id="modalImg" class="w-full max-h-[500px] object-contain hidden"></div>
                <div class="p-6 md:p-8 bg-white"><span id="modalDate" class="text-xs font-bold text-edu-purple uppercase"></span><h2 id="modalTitle" class="text-2xl font-black text-gray-900 mt-2 mb-6 leading-tight sport-font"></h2><p id="modalBody" class="text-gray-800 whitespace-pre-line text-base leading-relaxed"></p></div>
                <div class="p-6 border-t bg-gray-50"><h4 class="font-bold text-gray-700 mb-4 text-sm uppercase">Comments</h4><div id="comments-list" class="space-y-3 mb-4"></div></div>
            </div>
            <form onsubmit="postComment(event)" class="bg-white p-3 border-t flex gap-2 items-center absolute bottom-0 w-full shadow-lg"><input id="commentName" class="w-1/4 text-xs border p-3 rounded-lg bg-gray-50" placeholder="Name" required maxlength="15"><input id="commentInput" class="flex-grow text-sm p-3 border rounded-lg bg-gray-50" placeholder="Write a comment..." required autocomplete="off"><button type="submit" class="bg-edu-purple text-white px-4 py-2 rounded-lg font-bold"><i class="fa-solid fa-paper-plane"></i></button></form>
        </div>
    </div>

    <div id="teamModal" class="fixed inset-0 bg-black/90 z-[80] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl overflow-hidden relative shadow-2xl transform transition-all">
            <button onclick="document.getElementById('teamModal').classList.add('hidden')" class="absolute top-2 right-2 bg-white/20 p-2 rounded-full text-white hover:bg-white/40 z-10"><i class="fa-solid fa-times"></i></button>
            <div class="bg-edu-purple p-8 text-center text-white relative">
                <img id="tm-logo" src="edulogo.jpg" class="w-24 h-24 rounded-full border-4 border-white shadow-lg mx-auto mb-3 object-contain bg-white">
                <h2 id="tm-name" class="text-2xl font-black sport-font tracking-tight">Team Name</h2>
                <p id="tm-coach" class="text-sm text-purple-200 font-medium bg-white/10 inline-block px-3 py-1 rounded-full mt-2">Coach: ...</p>
            </div>
            <div class="p-6 max-h-[50vh] overflow-y-auto"><h4 class="font-bold text-gray-400 text-[10px] uppercase mb-4 tracking-widest border-b pb-2">Squad Roster</h4><ul id="tm-roster" class="space-y-3 text-sm text-gray-700"></ul></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, increment, addDoc, serverTimestamp, getDoc, where, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDtxFsLYoe0NYlZRWiXgEM90IYKMwx7K8s", authDomain: "sonic-verbena-239117.firebaseapp.com", projectId: "sonic-verbena-239117", storageBucket: "sonic-verbena-239117.appspot.com", messagingSenderId: "652544574249", appId: "1:652544574249:web:6ff33771307e892e7f6d38", measurementId: "G-TD780JGNED" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);
        signInAnonymously(auth);
        
        let currentPostId = null; let commentsUnsubscribe = null; let matchInterval = null;
        let activeMiniUnsub = null; let activeTableUnsub = null;
        let divLogos = { 'Finalist': 'edulogo.jpg', 'Penultimate': 'edulogo.jpg', 'Sophomore': 'edulogo.jpg', 'Female': 'edulogo.jpg' };
        let globalTeamLogos = {}; let allSchedules = []; let scheduleMode = 'fixtures'; 

        const fetchDivLogos = async () => { try { const s = await getDoc(doc(db, "app_content", "division_logos")); if(s.exists()) divLogos = { ...divLogos, ...s.data() }; } catch(e){} }; fetchDivLogos();
        const fetchTeamLogos = async () => { const assetsSnap = await getDocs(collection(db, "team_assets")); assetsSnap.forEach(doc => { globalTeamLogos[doc.id] = doc.data().logoUrl; }); }; fetchTeamLogos();

        // üî• FIXED REAL-TIME MINI TABLE
        window.loadMiniTable = (lvl) => {
            ['Finalist','Penultimate','Sophomore','Female'].forEach(l => { 
                const b = document.getElementById(`mt-${l}`); 
                if(b) b.className = l===lvl ? "mini-tab-active px-2 py-1 rounded text-[9px] font-bold transition" : "mini-tab-inactive px-2 py-1 rounded text-[9px] font-bold transition"; 
            });
            if(activeMiniUnsub) activeMiniUnsub(); // üõë Stop listening to previous
            activeMiniUnsub = onSnapshot(doc(db, "app_content", `league_table_${lvl.toLowerCase()}`), (s) => {
                const b = document.getElementById('mini-table-body'); b.innerHTML = '';
                if(!s.exists()) { b.innerHTML = '<tr><td colspan="3" class="p-2 text-center text-gray-400">No Data</td></tr>'; return; }
                const d = s.data(); 
                const teams = Object.keys(d).map(k=>({name:k, ...d[k]})).sort((a,b)=>(b.pts-a.pts)||(b.gd-a.gd)).slice(0,4); 
                teams.forEach((t,i) => { b.innerHTML += `<tr class="border-b border-gray-50"><td class="py-2 pl-2 font-bold text-gray-700 truncate w-24">${i+1}. ${t.name}</td><td class="text-center text-gray-500">${t.mp}</td><td class="text-center font-black text-edu-purple">${t.pts}</td></tr>`; });
            });
        }
        loadMiniTable('Finalist');

        // üî• FIXED REAL-TIME FULL TABLE MODAL
        window.openTableModal = () => { document.getElementById('tableModal').classList.remove('hidden'); loadFullTable('Finalist'); }
        window.loadFullTable = (lvl) => {
            ['Finalist','Penultimate','Sophomore','Female'].forEach(l => { const b=document.getElementById(`ft-${l}`); b.className = l===lvl ? "tab-active px-4 py-1.5 rounded-full text-xs font-bold" : "tab-inactive px-4 py-1.5 rounded-full text-xs font-bold"; });
            
            if(activeTableUnsub) activeTableUnsub(); // üõë Stop listening to previous
            activeTableUnsub = onSnapshot(doc(db, "app_content", `league_table_${lvl.toLowerCase()}`), (s) => {
                const b = document.getElementById('full-table-body'); b.innerHTML = '';
                if(!s.exists()) { b.innerHTML='<tr><td colspan="8" class="p-4 text-center">No Data</td></tr>'; return; }
                const d = s.data(); 
                const teams = Object.keys(d).map(k=>({name:k, ...d[k]})).sort((a,b)=>(b.pts-a.pts)||(b.gd-a.gd));
                teams.forEach((t,i) => {
                    const logoUrl = globalTeamLogos[`${t.name}_${lvl}`] || globalTeamLogos[t.name] || 'edulogo.jpg';
                    b.innerHTML += `<tr class="border-b"><td class="p-3 font-bold ${i<4?'text-green-600':''}">${i+1}</td><td class="p-3 font-bold text-gray-700 flex items-center gap-2"><img src="${logoUrl}" class="h-6 w-6 rounded-full object-contain"> ${t.name}</td><td class="p-3 text-center">${t.mp}</td><td class="p-3 text-center text-green-600">${t.w}</td><td class="p-3 text-center text-gray-500">${t.d}</td><td class="p-3 text-center text-red-500">${t.l}</td><td class="p-3 text-center">${t.gd}</td><td class="p-3 text-center font-black text-lg">${t.pts}</td></tr>`; 
                });
            });
        }

        // --- REST OF THE LOGIC ---
        window.openScheduleModal = async (mode) => {
            scheduleMode = mode;
            document.getElementById('sched-modal-title').innerHTML = mode === 'results' ? `<i class="fa-solid fa-square-check text-red-600"></i> RESULTS` : `<i class="fa-regular fa-calendar-days text-green-600"></i> FIXTURES`;
            document.getElementById('scheduleModal').classList.remove('hidden');
            if (allSchedules.length === 0) { const s1 = await getDocs(collection(db, "schedules")); const s2 = await getDocs(collection(db, "matches")); s1.forEach(d => allSchedules.push(d.data())); s2.forEach(d => allSchedules.push(d.data())); }
            window.renderSchedule();
        }
        
        window.renderSchedule = () => {
            const list = document.getElementById('schedule-list'); const filterDiv = document.getElementById('sched-filter').value; list.innerHTML = '';
            let filtered = allSchedules; if (filterDiv !== 'All') filtered = allSchedules.filter(m => m.div === filterDiv);
            if (filtered.length === 0) { list.innerHTML = '<div class="text-center py-10"><p class="text-gray-400 font-bold">No data found.</p></div>'; return; }
            const grouped = {}; filtered.forEach(m => { if(!grouped[m.day]) grouped[m.day] = []; grouped[m.day].push(m); });
            Object.keys(grouped).sort().forEach(day => {
                list.innerHTML += `<h4 class="text-xs font-black text-gray-400 uppercase tracking-widest mt-4 mb-2 sticky top-0 bg-gray-50 py-1 pl-2">${day}</h4>`;
                grouped[day].forEach(m => {
                    let status = m.time === 'TBD' ? 'TBD' : m.time;
                    let motmHtml = '';
                    if (scheduleMode === 'results') {
                        status = (m.homeScore !== undefined) ? `<span class="text-lg font-black text-slate-800">${m.homeScore} - ${m.awayScore}</span>` : '<span class="text-xs text-gray-400 font-bold">vs</span>';
                        if (m.motm && m.motm.player) motmHtml = `<div class="mt-2 pt-2 border-t border-gray-100 flex items-center gap-2"><span class="bg-yellow-100 text-yellow-700 text-[9px] font-black px-1.5 py-0.5 rounded"><i class="fa-solid fa-star"></i> MOTM</span><span class="text-[10px] font-bold text-gray-700 uppercase">${m.motm.player} <span class="text-gray-400">(${m.motm.team})</span></span></div>`;
                    }
                    list.innerHTML += `<div class="bg-white p-4 rounded-xl border border-gray-100 mb-2 shadow-sm"><div class="flex justify-between items-center"><div><span class="text-[9px] font-bold bg-gray-100 text-gray-600 px-2 py-0.5 rounded uppercase mb-1 inline-block">${(m.div||'').split(' ')[0]}</span><div class="font-black text-gray-800 text-sm sport-font uppercase">${m.home||m.homeTeam} <span class="text-gray-300 mx-1">vs</span> ${m.away||m.awayTeam}</div></div><div class="text-right"><p class="text-xs font-bold text-gray-600">${m.date||''}</p><div class="mt-1">${status}</div></div></div>${motmHtml}</div>`;
                });
            });
        }

        onSnapshot(query(collection(db, "polls"), where("active", "==", true)), (snap) => {
            const el = document.getElementById('polls-container'); el.innerHTML = snap.empty ? '<p class="text-xs text-gray-400 text-center py-4">No active polls.</p>' : '';
            snap.forEach(doc => { 
                const d = doc.data(); const id = doc.id; const voted = localStorage.getItem(`voted_${id}`);
                const v1 = d.votes1||0; const v2 = d.votes2||0; const total = v1+v2; const p1 = total?Math.round((v1/total)*100):0; const p2 = total?Math.round((v2/total)*100):0;
                let content = voted ? `<div class="mt-2 space-y-2"><div><div class="flex justify-between text-xs font-bold"><span class="text-gray-600">${d.opt1}</span><span>${p1}%</span></div><div class="h-2 bg-gray-100 rounded-full"><div class="h-full bg-blue-500 rounded-full transition-all duration-500" style="width:${p1}%"></div></div></div><div><div class="flex justify-between text-xs font-bold"><span class="text-gray-600">${d.opt2}</span><span>${p2}%</span></div><div class="h-2 bg-gray-100 rounded-full"><div class="h-full bg-red-500 rounded-full transition-all duration-500" style="width:${p2}%"></div></div></div></div>` : `<div class="grid grid-cols-2 gap-2 mt-2"><button onclick="vote('${id}',1)" class="border bg-blue-50 text-blue-800 p-2 rounded text-xs font-bold hover:bg-blue-100">üÖ∞Ô∏è ${d.opt1}</button><button onclick="vote('${id}',2)" class="border bg-red-50 text-red-800 p-2 rounded text-xs font-bold hover:bg-red-100">üÖ±Ô∏è ${d.opt2}</button></div>`;
                el.innerHTML += `<div class="bg-gray-50 p-3 rounded-lg border border-gray-100 mb-2"><p class="text-xs font-black text-gray-800 uppercase mb-1">${d.question}</p>${content}</div>`;
            });
        });

        // Other listeners...
        onSnapshot(doc(db, "app_content", "potw_current"), (docSnap) => {
            const container = document.getElementById('potw-voting-area');
            if(!docSnap.exists() || !docSnap.data().active) { container.innerHTML = '<p class="text-xs text-gray-400 text-center">No active voting.</p>'; return; }
            const d = docSnap.data(); const matchday = d.matchday || "Current"; const userVoted = localStorage.getItem(`voted_potw_${matchday}`); const totalVotes = Object.values(d.votes || {}).reduce((a,b)=>a+b, 0);
            let html = `<div class="mb-3 flex justify-between items-center"><span class="text-[10px] font-bold bg-purple-100 text-purple-700 px-2 py-0.5 rounded uppercase">${matchday}</span></div>`;
            d.nominees.forEach((n) => {
                const votes = d.votes ? (d.votes[n.name] || 0) : 0; const pct = totalVotes > 0 ? Math.round((votes/totalVotes)*100) : 0; const statsHtml = n.stats.map(s => `<span class="text-[9px] bg-gray-100 px-1.5 rounded text-gray-600">${s}</span>`).join(' ');
                html += userVoted ? `<div class="mb-3 p-3 bg-gray-50 rounded border relative overflow-hidden"><div class="flex justify-between relative z-10"><div><p class="font-bold text-sm">${n.name}</p><p class="text-[10px] text-purple-600 font-bold uppercase">${n.team}</p></div><span class="text-lg font-black text-purple-600">${pct}%</span></div><div class="absolute bottom-0 left-0 h-1 bg-purple-500" style="width:${pct}%"></div></div>` : `<div class="mb-3 p-3 bg-white border rounded shadow-sm"><div class="flex justify-between mb-2"><div><p class="font-black text-sm">${n.name}</p><p class="text-[10px] text-gray-500 uppercase">${n.team}</p></div><button onclick="votePOTW('${matchday}', '${n.name}')" class="bg-purple-600 text-white text-xs font-bold px-3 py-1.5 rounded hover:bg-purple-700">VOTE</button></div><div class="flex gap-1">${statsHtml}</div></div>`;
            });
            container.innerHTML = html;
        });

        // Globals & Helpers
        window.votePOTW = async (matchday, playerName) => { if(localStorage.getItem(`voted_potw_${matchday}`)) return alert("Already voted!"); localStorage.setItem(`voted_potw_${matchday}`, 'true'); await updateDoc(doc(db, "app_content", "potw_current"), { [`votes.${playerName}`]: increment(1) }); alert(`Voted for ${playerName}!`); };
        window.openPOTWHistory = async () => { document.getElementById('potwHistoryModal').classList.remove('hidden'); const snap = await getDocs(query(collection(db, "potw_history"), orderBy("timestamp", "desc"))); document.getElementById('potw-history-list').innerHTML = snap.empty ? '<p class="text-center text-gray-400 text-sm mt-4">No history.</p>' : ''; snap.forEach(d => { const h=d.data(); document.getElementById('potw-history-list').innerHTML += `<div class="bg-white p-4 rounded-xl border border-purple-100 shadow-sm flex items-center gap-4"><div class="bg-purple-100 h-12 w-12 rounded-full flex items-center justify-center text-xl">üëë</div><div><p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">${h.matchday}</p><h4 class="font-black text-lg text-gray-800 leading-none">${h.winner}</h4><p class="text-xs text-purple-600 font-bold">${h.team}</p></div></div>`; }); };
        onSnapshot(doc(db, "app_content", "current_fixture"), (d) => { if(d.exists() && d.data().matches && d.data().matches.length > 0) { let idx=0; const matches=d.data().matches; setInterval(() => { const m=matches[idx]; document.getElementById('teamA_name').textContent=m.teamA; document.getElementById('teamB_name').textContent=m.teamB; document.getElementById('match_details').textContent=`${m.date} ‚Ä¢ ${m.time}`; document.getElementById('teamA_img').src=m.teamALogo||'edulogo.jpg'; document.getElementById('teamB_img').src=m.teamBLogo||'edulogo.jpg'; idx=(idx+1)%matches.length; }, 5000); }});
        onSnapshot(query(collection(db, "news_posts"), orderBy("timestamp", "desc")), (s) => { const g=document.getElementById('news-grid'); document.getElementById('loading').classList.add('hidden'); g.classList.remove('hidden'); g.innerHTML=''; if(s.empty) { g.innerHTML='<p class="text-center col-span-full text-gray-400">No news.</p>'; return; } s.forEach(d => { const dt=d.data(); const pid=d.id; const liked=localStorage.getItem(`liked_${pid}`) ? 'liked':'text-gray-400'; const img=dt.imageUrl||'edulogo.jpg'; const isVid=img.includes('.mp4'); g.innerHTML += `<div class="bg-white rounded-xl shadow-sm border h-full flex flex-col news-card" id="card-${pid}" data-title="${dt.title}" data-content="${dt.content}" data-media="${img}" data-isvideo="${isVid}" data-date="Recent"><div class="relative h-48 bg-gray-900 overflow-hidden cursor-pointer" onclick="openModal('${pid}')">${isVid?`<video src="${img}" class="w-full h-full object-cover"></video>`:`<img src="${img}" class="w-full h-full object-cover">`}</div><div class="p-5 flex flex-col flex-grow"><h3 class="text-lg font-bold text-gray-900 mb-2 cursor-pointer uppercase sport-font" onclick="openModal('${pid}')">${dt.title}</h3><div class="pt-3 mt-auto border-t flex justify-between items-center text-sm"><button onclick="handleLike('${pid}')" class="flex items-center space-x-1 ${liked}" id="like-btn-${pid}"><i class="${liked.includes('liked')?'fa-solid':'fa-regular'} fa-heart"></i><span id="like-count-${pid}">${dt.likes||0}</span></button></div></div></div>`; }); });
        
        window.handleLike = async (id) => { const isLiked = localStorage.getItem(`liked_${id}`); const btn = document.getElementById(`like-btn-${id}`); const countSpan = document.getElementById(`like-count-${id}`); let newCount = parseInt(countSpan.innerText); if (isLiked) { newCount--; localStorage.removeItem(`liked_${id}`); btn.classList.remove('liked'); btn.querySelector('i').classList.replace('fa-solid', 'fa-regular'); } else { newCount++; localStorage.setItem(`liked_${id}`, 'true'); btn.classList.add('liked'); btn.querySelector('i').classList.replace('fa-regular', 'fa-solid'); } countSpan.innerText = newCount; await updateDoc(doc(db, "news_posts", id), { likes: increment(isLiked ? -1 : 1) }); }
        window.openModal = (pid) => { currentPostId = pid; const c=document.getElementById(`card-${pid}`); document.getElementById('modalTitle').innerText=c.dataset.title; document.getElementById('modalBody').innerText=c.dataset.content; const v=document.getElementById('modalImg'); v.src=c.dataset.media; v.classList.remove('hidden'); document.getElementById('newsModal').classList.remove('hidden'); commentsUnsubscribe = onSnapshot(query(collection(db, "news_posts", pid, "comments"), orderBy("timestamp", "asc")), (snap) => { document.getElementById('comments-list').innerHTML = snap.docs.map(d=>`<div class="bg-gray-50 p-3 rounded-xl border text-sm"><p class="font-bold text-edu-purple text-xs">${d.data().user}</p><p>${d.data().text}</p></div>`).join(''); }); }
        window.closeModal = () => { document.getElementById('newsModal').classList.add('hidden'); if(commentsUnsubscribe) commentsUnsubscribe(); }
        window.postComment = async (e) => { e.preventDefault(); const t=document.getElementById('commentInput').value; if(!t)return; document.getElementById('commentInput').value=''; await addDoc(collection(db, "news_posts", currentPostId, "comments"), { user:document.getElementById('commentName').value||"Fan", text:t, timestamp: serverTimestamp() }); await updateDoc(doc(db, "news_posts", currentPostId), { commentsCount: increment(1) }); }
        window.vote = async (id, o) => { localStorage.setItem(`voted_${id}`,'true'); await updateDoc(doc(db, "polls", id), { [o===1?'votes1':'votes2']: increment(1) }); }
        window.predict = async (type) => { if(localStorage.getItem('predicted_match')) return alert("Already predicted!"); localStorage.setItem('predicted_match', 'true'); await updateDoc(doc(db, "app_content", "fan_zone"), { [`prediction.${type}`]: increment(1) }); }
    </script>
</body>
</html>