<!-- ... (Head and Body HTML same as previous, just updating script) ... -->
    <!-- Firebase & Logic Script -->
    <script type="module">
        // ... (Imports and Config same as before) ...

        // ... (State and DOM Elements same as before) ...

        // --- Config ---
        const ORGANIZER_CODE = "EDU2025"; // The code to verify payment

        // --- Page Load Logic ---
        function loadPageData() {
            const params = new URLSearchParams(window.location.search);
            teamName = params.get('team');
            level = params.get('level');
            fee = params.get('fee');
            teamDocId = params.get('teamId'); 
            
            // ** NEW: Recovery Logic **
            if (!teamDocId) {
                const savedId = localStorage.getItem('eduLeagueTeamID');
                if (savedId) {
                    // We found a saved ID! Let's use it.
                    // Ideally we would fetch details from DB, but for now we at least need the ID.
                    teamDocId = savedId;
                    console.log("Recovered Team ID from storage:", teamDocId);
                    // We might not have name/level if URL params are gone, 
                    // but verifyCode needs teamDocId primarily.
                    if (!teamName) teamName = "Recovered Session";
                    if (!level) level = "Unknown Level";
                    if (!fee) fee = "0";
                }
            } else {
                // We have ID from URL, save it for safety
                localStorage.setItem('eduLeagueTeamID', teamDocId);
            }

            if (teamDocId) {
                teamNameDisplay.textContent = teamName || "Team";
                levelDisplay.textContent = level || "Level";
                // We don't update feeDisplay here because it's hardcoded to FREE in HTML
            } else {
                console.error("Missing Team ID.");
                teamNameDisplay.textContent = "Error: Session Lost";
                levelDisplay.textContent = "Please go back to registration.";
                document.getElementById('confirmButton').disabled = true;
                document.getElementById('confirmButton').textContent = "Error: Please Go Back";
            }
        }
        
        // ... (Rest of script same as before) ...
        // Just ensure 'verifyCode' function uses the current teamDocId variable
    </script>
</body>
</html>